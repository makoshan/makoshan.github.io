<div class="sourceCode" id="cb1"><pre class="sourceCode Haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#!/usr/bin/env runhaskell</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- Read directories like &quot;docs/iodine/&quot; for its files; generate a list item with the abstract in a blockquote where available; the full list is then turned into a directory listing, which gets compiled with Hakyll and gets the usual popup annotations. Very nifty. Much nicer than simply browsing a list of filenames or even the Google search of a directory (mostly showing random snippets).</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Monad</span> (filterM)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.List</span> (isPrefixOf, isInfixOf, isSuffixOf, sort, sortBy)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.List.Utils</span> (replace)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.Directory</span> (listDirectory, doesFileExist, doesDirectoryExist, renameFile, removeFile)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.Environment</span> (getArgs)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.FilePath</span> (takeDirectory, takeFileName)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.Pandoc</span> (def, nullAttr, nullMeta, pandocExtensions, runPure, writeMarkdown, writerExtensions,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Block</span>(<span class="dt">BulletList</span>, <span class="dt">Header</span>, <span class="dt">Para</span>, <span class="dt">RawBlock</span>), <span class="dt">Format</span>(<span class="dt">Format</span>), <span class="dt">Inline</span>(<span class="dt">Code</span>, <span class="dt">Link</span>, <span class="dt">Space</span>, <span class="dt">Span</span>, <span class="dt">Str</span>), <span class="dt">Pandoc</span>(<span class="dt">Pandoc</span>))</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">M</span> (lookup, size, toList, filterWithKey)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span> (unpack, pack)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.IO</span> (stderr, hPrint)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.IO.Temp</span> (writeSystemTempFile)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">LinkMetadata</span> (readLinkMetadata, generateAnnotationBlock, getBackLink, <span class="dt">Metadata</span>, <span class="dt">MetadataItem</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Columns</span> (listsTooLong)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span> dirs <span class="ot">&lt;-</span> getArgs</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>          <span class="kw">let</span> dirs&#39; <span class="ot">=</span> <span class="fu">map</span> (\dir <span class="ot">-&gt;</span> <span class="kw">if</span> <span class="st">&quot;./&quot;</span> <span class="ot">`isPrefixOf`</span> dir <span class="kw">then</span> <span class="fu">drop</span> <span class="dv">2</span> dir <span class="kw">else</span> dir) dirs</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>          meta <span class="ot">&lt;-</span> readLinkMetadata</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mapM_</span> (generateDirectory meta) dirs&#39;  <span class="co">-- </span><span class="al">NOTE</span><span class="co">: while embarrassingly-parallel &amp; trivial to switch to `Control.Monad.Parallel.mapM_`, because of the immensely slow Haskell compilation (due to Pandoc), 2021-04-23 benchmarking suggests that compile+runtime is ~1min slower than `runhaskell` interpretation</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="ot">generateDirectory ::</span> <span class="dt">Metadata</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>generateDirectory mta dir&#39;&#39; <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  direntries <span class="ot">&lt;-</span> listDirectory dir&#39;&#39;</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> direntries&#39; <span class="ot">=</span> <span class="fu">map</span> (\entry <span class="ot">-&gt;</span> <span class="st">&quot;/&quot;</span><span class="op">++</span>dir&#39;&#39;<span class="op">++</span>entry) direntries</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  dirs  <span class="ot">&lt;-</span> listDirectories direntries&#39;</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  pairs <span class="ot">&lt;-</span> listFiles mta   direntries&#39;</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> header <span class="ot">=</span> generateYAMLHeader dir&#39;&#39;</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> directorySection <span class="ot">=</span> generateDirectoryItems dirs</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> fileSection <span class="ot">=</span> generateListItems pairs</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> body <span class="ot">=</span> [<span class="dt">Header</span> <span class="dv">2</span> nullAttr [<span class="dt">Str</span> <span class="st">&quot;Directories&quot;</span>]] <span class="op">++</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>               <span class="co">-- for pages like ./docs/statistics/index.page where there are 9+ subdirectories, we&#39;d like to multi-column the directory section (we can&#39;t for files because there are so many annotations):</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>               (<span class="kw">if</span> <span class="fu">length</span> dirs <span class="op">&lt;</span> <span class="dv">8</span> <span class="kw">then</span> [directorySection] <span class="kw">else</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>                 [<span class="dt">RawBlock</span> (<span class="dt">Format</span> <span class="st">&quot;html&quot;</span>) <span class="st">&quot;&lt;div class=\&quot;columns\&quot;&gt;\n\n&quot;</span>,</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>                   directorySection,</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>                   <span class="dt">RawBlock</span> (<span class="dt">Format</span> <span class="st">&quot;html&quot;</span>) <span class="st">&quot;&lt;/div&gt;&quot;</span>]) <span class="op">++</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>               [<span class="dt">Header</span> <span class="dv">2</span> nullAttr [<span class="dt">Str</span> <span class="st">&quot;Files&quot;</span>]] <span class="op">++</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>                <span class="co">-- for lists, they *may* all be devoid of annotations and short</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>                <span class="kw">if</span> <span class="fu">length</span> (listsTooLong [fileSection]) <span class="op">==</span> <span class="dv">0</span> <span class="kw">then</span> [fileSection] <span class="kw">else</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>                  [<span class="dt">RawBlock</span> (<span class="dt">Format</span> <span class="st">&quot;html&quot;</span>) <span class="st">&quot;&lt;div class=\&quot;columns\&quot;&gt;\n\n&quot;</span>,</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>                   fileSection,</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>                   <span class="dt">RawBlock</span> (<span class="dt">Format</span> <span class="st">&quot;html&quot;</span>) <span class="st">&quot;&lt;/div&gt;&quot;</span>]</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> document <span class="ot">=</span> <span class="dt">Pandoc</span> nullMeta body</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> p <span class="ot">=</span> runPure <span class="op">$</span> writeMarkdown def{writerExtensions <span class="ot">=</span> pandocExtensions} document</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> p <span class="kw">of</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Left</span> e   <span class="ot">-&gt;</span> hPrint stderr e</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- compare with the old version, and update if there are any differences:</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Right</span> p&#39; <span class="ot">-&gt;</span> <span class="kw">do</span> <span class="kw">let</span> contentsNew <span class="ot">=</span> header <span class="op">++</span> T.unpack p&#39;</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>                   updateFile (dir&#39;&#39; <span class="op">++</span> <span class="st">&quot;index.page&quot;</span>) contentsNew</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="ot">updateFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>updateFile f contentsNew <span class="ot">=</span> <span class="kw">do</span> t <span class="ot">&lt;-</span> writeSystemTempFile <span class="st">&quot;hakyll-directories&quot;</span> contentsNew</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>                              existsOld <span class="ot">&lt;-</span> doesFileExist f</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>                              <span class="kw">if</span> <span class="fu">not</span> existsOld <span class="kw">then</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>                                renameFile t f</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>                                <span class="kw">else</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>                                  <span class="kw">do</span> contentsOld <span class="ot">&lt;-</span> <span class="fu">readFile</span> f</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>                                     <span class="kw">if</span> contentsNew <span class="op">/=</span> contentsOld <span class="kw">then</span> renameFile t f <span class="kw">else</span> removeFile t</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="ot">generateYAMLHeader ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>generateYAMLHeader d <span class="ot">=</span> <span class="st">&quot;---\n&quot;</span> <span class="op">++</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;title: /&quot;</span> <span class="op">++</span> d <span class="op">++</span> <span class="st">&quot; Directory Listing\n&quot;</span> <span class="op">++</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;description: Annotated bibliography of files in the directory &lt;code&gt;/&quot;</span> <span class="op">++</span> d <span class="op">++</span> <span class="st">&quot;&lt;/code&gt;, most recent first.\n&quot;</span> <span class="op">++</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;tags: index\n&quot;</span> <span class="op">++</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;created: 2009-01-01\n&quot;</span> <span class="op">++</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;status: in progress\n&quot;</span> <span class="op">++</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;confidence: log\n&quot;</span> <span class="op">++</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;importance: 0\n&quot;</span> <span class="op">++</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;cssExtension: drop-caps-de-zs\n&quot;</span> <span class="op">++</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;index: true\n&quot;</span> <span class="op">++</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;...\n&quot;</span> <span class="op">++</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;\n&quot;</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a><span class="ot">listDirectories ::</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">FilePath</span>]</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>listDirectories direntries&#39; <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>                       directories <span class="ot">&lt;-</span> filterM (doesDirectoryExist <span class="op">.</span> <span class="fu">tail</span>) direntries&#39;</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>                       <span class="kw">let</span> directoriesMi <span class="ot">=</span> <span class="fu">sort</span> <span class="op">$</span> <span class="fu">map</span> (<span class="op">++</span><span class="st">&quot;/index&quot;</span>) directories</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>                       filterM (\f <span class="ot">-&gt;</span> doesFileExist <span class="op">$</span> <span class="fu">tail</span> (f<span class="op">++</span><span class="st">&quot;.page&quot;</span>)) directoriesMi</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a><span class="ot">listFiles ::</span> <span class="dt">Metadata</span> <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> [(<span class="dt">FilePath</span>,<span class="dt">MetadataItem</span>,<span class="dt">FilePath</span>)]</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>listFiles m direntries&#39; <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>                   files <span class="ot">&lt;-</span> filterM (doesFileExist <span class="op">.</span> <span class="fu">tail</span>) direntries&#39;</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>                   <span class="kw">let</span> files&#39;          <span class="ot">=</span> (<span class="fu">sort</span> <span class="op">.</span> <span class="fu">filter</span> (<span class="fu">not</span> <span class="op">.</span> (<span class="st">&quot;index&quot;</span><span class="ot">`isSuffixOf`</span>)) <span class="op">.</span> <span class="fu">map</span> (replace <span class="st">&quot;.page&quot;</span> <span class="st">&quot;&quot;</span>) <span class="op">.</span> <span class="fu">filter</span> (<span class="fu">not</span> <span class="op">.</span> isSuffixOf <span class="st">&quot;.tar&quot;</span>) ) files</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>                   backlinks <span class="ot">&lt;-</span> <span class="fu">mapM</span> getBackLink files&#39;</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>                   <span class="kw">let</span> fileAnnotationsMi <span class="ot">=</span> <span class="fu">map</span> (lookupFallback m) files&#39;</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">return</span> <span class="op">$</span> <span class="fu">reverse</span> <span class="op">$</span> sortByDate <span class="op">$</span> <span class="co">-- most recent first: nicer for browsing, especially given that older files typically have no annotations.</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">zipWith</span> (\(a,b) c <span class="ot">-&gt;</span> (a,b,c)) fileAnnotationsMi backlinks</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a><span class="co">-- sort a list of entries in ascending order using the annotation date when available (as &#39;YYYY[-MM[-DD]]&#39;, which string-sorts correctly), and falling back to sorting on the filenames (&#39;YYYY-author.pdf&#39;).</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a><span class="ot">sortByDate ::</span> [(<span class="dt">FilePath</span>,<span class="dt">MetadataItem</span>,<span class="dt">FilePath</span>)] <span class="ot">-&gt;</span> [(<span class="dt">FilePath</span>,<span class="dt">MetadataItem</span>,<span class="dt">FilePath</span>)]</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>sortByDate <span class="ot">=</span> sortBy (\(f,(t,a,d,_,_),_) (f&#39;,(t&#39;,a&#39;,d&#39;,_,_),_) <span class="ot">-&gt;</span> <span class="kw">if</span> <span class="fu">not</span> (<span class="fu">null</span> d <span class="op">&amp;&amp;</span> <span class="fu">null</span> d&#39;) <span class="kw">then</span> (<span class="kw">if</span> d <span class="op">&gt;</span> d&#39; <span class="kw">then</span> <span class="dt">GT</span> <span class="kw">else</span> <span class="dt">LT</span>) <span class="kw">else</span> (<span class="kw">if</span> f <span class="op">&gt;</span> f&#39; <span class="kw">then</span> <span class="dt">GT</span> <span class="kw">else</span> <span class="dt">LT</span>))</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a><span class="co">-- how do we handle files with appended data, which are linked like &#39;/docs/rl/2020-bellemare.pdf#google&#39; but exist as files as &#39;/docs/rl/2020-bellemare.pdf&#39;? We can&#39;t just look up the *filename* because it&#39;s missing the # fragment, and the annotation is usually for the full path including the fragment. If a lookup fails, we fallback to looking for any annotation with the file as a *prefix*, and accept the first match.</span></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a><span class="ot">lookupFallback ::</span> <span class="dt">Metadata</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> (<span class="dt">FilePath</span>, <span class="dt">MetadataItem</span>)</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>lookupFallback m u <span class="ot">=</span> <span class="kw">case</span> M.lookup u m <span class="kw">of</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>                       <span class="dt">Nothing</span> <span class="ot">-&gt;</span> tryPrefix</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>                       <span class="dt">Just</span> (<span class="st">&quot;&quot;</span>,_,_,_,_) <span class="ot">-&gt;</span> tryPrefix</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>                       <span class="dt">Just</span> mi <span class="ot">-&gt;</span> (u,mi)</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>                       <span class="kw">where</span> tryPrefix <span class="ot">=</span> <span class="kw">let</span> possibles <span class="ot">=</span>  M.filterWithKey (\url _ <span class="ot">-&gt;</span> u <span class="ot">`isPrefixOf`</span> url <span class="op">&amp;&amp;</span> url <span class="op">/=</span> u) m <span class="kw">in</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>                                           <span class="kw">let</span> u&#39; <span class="ot">=</span> <span class="kw">if</span> M.size possibles <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">then</span> <span class="fu">fst</span> <span class="op">$</span> <span class="fu">head</span> <span class="op">$</span> M.toList possibles <span class="kw">else</span> u <span class="kw">in</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>                                               (<span class="kw">if</span> (<span class="st">&quot;.page&quot;</span> <span class="ot">`isInfixOf`</span> u&#39;) <span class="op">||</span> (u <span class="op">==</span> u&#39;) <span class="kw">then</span> (u, (<span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>)) <span class="kw">else</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>                                                  <span class="co">-- sometimes the fallback is useless eg, a link to a section will trigger a &#39;longer&#39; hit, like</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>                                                  <span class="co">-- &#39;/reviews/Cat-Sense.page&#39; will trigger a fallback to /reviews/Cat-Sense#fuzz-testing&#39;; the</span></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>                                                  <span class="co">-- longer hit will also be empty, usually, and so not better. We check for that case and return</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>                                                  <span class="co">-- the original path and not the longer path.</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>                                                  <span class="kw">let</span> possibleFallback <span class="ot">=</span> lookupFallback m u&#39; <span class="kw">in</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>                                                    <span class="kw">if</span> <span class="fu">snd</span> possibleFallback <span class="op">==</span> (<span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>) <span class="kw">then</span> (u, (<span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>)) <span class="kw">else</span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>                                                      (u&#39;,<span class="fu">snd</span> possibleFallback))</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a><span class="ot">generateDirectoryItems ::</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">Block</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>generateDirectoryItems ds <span class="ot">=</span> <span class="dt">BulletList</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>                              <span class="op">$</span> <span class="fu">filter</span> (<span class="fu">not</span> <span class="op">.</span> <span class="fu">null</span>) <span class="op">$</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>                              [<span class="dt">Para</span> [<span class="dt">Link</span> nullAttr [<span class="dt">Str</span> <span class="st">&quot;↑ Parent directory&quot;</span>] (<span class="st">&quot;../index&quot;</span>, <span class="st">&quot;Link to parent directory (ascending)&quot;</span>)]] <span class="op">:</span></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">map</span> generateDirectoryItem ds</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a> <span class="kw">where</span><span class="ot"> generateDirectoryItem ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> [<span class="dt">Block</span>]</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>       generateDirectoryItem d <span class="ot">=</span> [<span class="dt">Para</span> [<span class="dt">Link</span> nullAttr [<span class="dt">Code</span> nullAttr (T.pack <span class="op">$</span> <span class="st">&quot;↓ &quot;</span> <span class="op">++</span> takeDirectory d)] (T.pack d, <span class="st">&quot;&quot;</span>)]]</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a><span class="ot">generateListItems ::</span> [(<span class="dt">FilePath</span>, <span class="dt">MetadataItem</span>,<span class="dt">FilePath</span>)] <span class="ot">-&gt;</span> <span class="dt">Block</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>generateListItems p <span class="ot">=</span> <span class="dt">BulletList</span> (<span class="fu">map</span> generateListItem p)</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a><span class="ot">generateListItem ::</span> (<span class="dt">FilePath</span>,<span class="dt">MetadataItem</span>,<span class="dt">FilePath</span>) <span class="ot">-&gt;</span> [<span class="dt">Block</span>]</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>generateListItem (f,(t,aut,_,_,<span class="st">&quot;&quot;</span>),bl)  <span class="ot">=</span> <span class="kw">let</span> f&#39; <span class="ot">=</span> <span class="kw">if</span> <span class="st">&quot;index&quot;</span> <span class="ot">`isSuffixOf`</span> f <span class="kw">then</span> takeDirectory f <span class="kw">else</span> takeFileName f <span class="kw">in</span></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>                                            <span class="kw">let</span> author <span class="ot">=</span> <span class="kw">if</span> aut<span class="op">==</span><span class="st">&quot;&quot;</span> <span class="kw">then</span> [] <span class="kw">else</span> [<span class="dt">Str</span> <span class="st">&quot;,&quot;</span>, <span class="dt">Space</span>, <span class="dt">Str</span> (T.pack aut)] <span class="kw">in</span></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>                                              <span class="co">-- I skip date because files don&#39;t usually have anything better than year, and that&#39;s already encoded in the filename which is shown</span></span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>                                          <span class="kw">let</span> backlink <span class="ot">=</span> <span class="kw">if</span> bl<span class="op">==</span><span class="st">&quot;&quot;</span> <span class="kw">then</span> [] <span class="kw">else</span> [<span class="dt">Space</span>, <span class="dt">Str</span> <span class="st">&quot;(&quot;</span>,  <span class="dt">Span</span> (<span class="st">&quot;&quot;</span>, [<span class="st">&quot;backlinks&quot;</span>], []) [<span class="dt">Link</span> (<span class="st">&quot;&quot;</span>,[<span class="st">&quot;backlink&quot;</span>],[]) [<span class="dt">Str</span> <span class="st">&quot;backlinks&quot;</span>] (T.pack bl,<span class="st">&quot;Reverse citations/backlinks/&#39;What links here&#39;/&#39;incoming link&#39;/&#39;inbound link&#39;/inlink/&#39;inward link&#39;/citation for this page (the list of other pages which link to this URL).&quot;</span>)], <span class="dt">Str</span> <span class="st">&quot;)&quot;</span>] <span class="kw">in</span></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>                                            <span class="kw">if</span> t<span class="op">==</span><span class="st">&quot;&quot;</span> <span class="kw">then</span> [<span class="dt">Para</span> (<span class="dt">Link</span> nullAttr [<span class="dt">Code</span> nullAttr (T.pack f&#39;)] (T.pack f, <span class="st">&quot;&quot;</span>) <span class="op">:</span> (author <span class="op">++</span> backlink))]</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>                                            <span class="kw">else</span> [<span class="dt">Para</span> (<span class="dt">Code</span> nullAttr (T.pack f&#39;) <span class="op">:</span> (<span class="dt">Link</span> nullAttr [<span class="dt">Str</span> <span class="st">&quot;:&quot;</span>, <span class="dt">Space</span>, <span class="dt">Str</span> <span class="st">&quot;“&quot;</span>, <span class="dt">Str</span> (T.pack t), <span class="dt">Str</span> <span class="st">&quot;”&quot;</span>] (T.pack f, <span class="st">&quot;&quot;</span>)) <span class="op">:</span> (author <span class="op">++</span> backlink))]</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>generateListItem (f,a,bl) <span class="ot">=</span></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- render annotation as: (skipping DOIs)</span></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>  <span class="co">--</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- &gt; [`2010-lucretius-dererumnatura.pdf`: &quot;On The Nature of Things&quot;](/docs/philo/2010-lucretius-dererumnatura.pdf), Lucretius (55BC-01-01):</span></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- &gt;</span></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- &gt; &gt; A poem on the Epicurean model of the world...</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>  generateAnnotationBlock <span class="dt">True</span> (f,<span class="dt">Just</span> a) bl</span></code></pre></div>
