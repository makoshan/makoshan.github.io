<div class="sourceCode" id="cb1"><pre class="sourceCode Haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- Module for typographic enhancements of text:</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- 1. adding smallcaps to capitalized phrases</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- 2. adding line-break tags (`&lt;wbr&gt;`) to slashes so web browsers break at slashes in text</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- 3. Adding classes to horizontal rulers (nth ruler modulo 3, allowing CSS to decorate it in a cycling pattern, like `class=&quot;ruler-1&quot;`/`class=&quot;ruler-2&quot;`/`class=&quot;ruler-3&quot;`/`class=&quot;ruler-1&quot;`..., like a repeating pattern of stars/moon/sun/stars/moon/sun... CSS can do this with :nth, but only for immediate sub-children, it can&#39;t count elements *globally*, and since Pandoc nests horizontal rulers and other block elements within each section, it is not possible to do the usual trick like with blockquotes/lists).</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Typography</span> (invertImageInline, typographyTransform, imageMagickDimensions) <span class="kw">where</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Monad.State.Lazy</span> (evalState, get, put, <span class="dt">State</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Monad</span> (void, when)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.ByteString.Lazy.Char8</span> <span class="kw">as</span> <span class="dt">B8</span> (unpack)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.List</span> (isPrefixOf)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.List.Utils</span> (replace)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Time.Clock</span> (diffUTCTime, getCurrentTime, nominalDay)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.Directory</span> (getModificationTime, removeFile)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.Exit</span> (<span class="dt">ExitCode</span>(<span class="dt">ExitFailure</span>))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.Posix.Temp</span> (mkstemp)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span> (any, append, isInfixOf, isSuffixOf, pack, unpack, replace, <span class="dt">Text</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.Regex.Posix</span> <span class="kw">as</span> <span class="dt">R</span> (makeRegex, match, <span class="dt">Regex</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.Regex</span> (subRegex, mkRegex)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.IO</span> (stderr, hPrint)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Concurrent</span> (threadDelay)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.FileStore.Utils</span> (runShellCommand)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.Pandoc</span> (<span class="dt">Inline</span>(..), <span class="dt">Block</span>(..), <span class="dt">Pandoc</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.Pandoc.Walk</span> (walk, walkM)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="ot">typographyTransform ::</span> <span class="dt">Pandoc</span> <span class="ot">-&gt;</span> <span class="dt">Pandoc</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>typographyTransform <span class="ot">=</span> walk (breakSlashes <span class="op">.</span> breakEquals) <span class="op">.</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>                       walk smallcapsfyInlineCleanup <span class="op">.</span> walk smallcapsfy <span class="op">.</span> rulersCycle <span class="dv">3</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co">-- Bringhurst &amp; other typographers recommend using smallcaps for acronyms/initials of 3 or more capital letters because with full capitals, they look too big and dominate the page (eg Bringhurst 2004, _Elements_ pg47; cf https://en.wikipedia.org/wiki/Small_caps#Uses http://theworldsgreatestbook.com/book-design-part-5/ http://webtypography.net/3.2.2 )</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co">-- This can be done by hand in Pandoc by using the span syntax like `[ABC]{.smallcaps}`, but quickly grows tedious. It can also be done reasonably easily with a query-replace regexp eg in Emacs `(query-replace-regexp &quot;\\([[:upper:]][[:upper:]][[:upper:]]+\\)&quot; &quot;[\\1]{.smallcaps}\\2&quot; nil begin end)`, but still must be done manually because while almost all uses in regular text can be smallcaps-ed, a blind regexp will wreck a ton of things like URLs &amp; tooltips, code blocks, etc.</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co">-- However, if we walk a Pandoc AST and check for only acronyms/initials inside a `Str`, where they *can&#39;t* be part of a Link or CodeBlock, then looking over Gwern.net ASTs, they seem to always be safe to substitute in SmallCaps elements. Unfortunately, we can&#39;t use the regular `Inline -&gt; Inline` replacement pattern because SmallCaps takes a `[Inline]` argument, and so we are doing `Str String -&gt; SmallCaps [Inline]` in theory and changing the size/type.</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co">-- So we instead walk the Pandoc AST, use a regexp to split on 3 capital letters, and inline the HTML span, skipping `Span` and `SmallCaps` entirely as the former causes serious problems in infinite loops &amp; duplication when tree-walking, and the latter works incorrectly for capitalized phrases.</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co">-- Why? For HTML output, simply using the regular `smallcaps` HTML class (which is how the default Pandoc HTML output does it) is not enough, because using smallcaps on a capital letter is a null-op. We *could* just rewrite the capitals to lowercase with `map toLower` etc, but then that breaks copy-paste: the underlying text for a &#39;Big[GAN]{.smallcaps}&#39; is now &#39;[Biggan]{.smallcaps}&#39; etc. So instead of using native SmallCaps AST elements, we create a new HTML span class for *just* all-caps separate from the pre-existing standard Pandoc &#39;smallcaps&#39; CSS class, &#39;smallcaps-auto&#39;; we annotate capitals with that new class in a Span rather than SmallCaps, and then in CSS, we do `span.smallcaps-auto { font-feature-settings: &#39;smcp&#39;; text-transform: lowercase; }` - smallcaps is enabled for this class, but we also lowercase everything, thereby forcing the intended smallcaps appearance while ensuring that copy-paste produces &#39;BigGAN&#39; (as written) instead of &#39;Biggan&#39;. That will work for most fonts but may have a few bugs (does your font support italic smallcaps? if it doesn&#39;t, then automatically lowercasing &amp; applying smallcaps in an italicized phrase will just produce a lowercase phrase). The SSfP font used on Gwern.net supports an additional font feature: &#39;c2sc&#39;, which is intended for exactly the purpose of converting an all-caps phrase to smallcaps, so for use with SSfP, it can be simplified to `font-feature-settings: &#39;smcp&#39;, &#39;c2sc&#39;`.</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="co">-- Regexp examples:</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co">-- &quot;BigGAN&quot; =~ &quot;[A-Z][A-Z][A-Z]+&quot; :: (String,String,String)</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co">-- → (&quot;Big&quot;,&quot;GAN&quot;,&quot;&quot;)</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="co">--  &quot;BigGANNN BigGAN&quot; =~ &quot;[A-Z][A-Z][A-Z]+&quot; :: (String,String,String)</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="co">-- → (&quot;Big&quot;,&quot;GANNN&quot;,&quot; BigGAN&quot;)</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="co">--  &quot;NSFW BigGAN&quot; =~ &quot;[A-Z][A-Z][A-Z]+&quot; :: (String,String,String)</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="co">-- → (&quot;&quot;,&quot;NSFW&quot;,&quot; BigGAN&quot;)</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="co">--  &quot;BigGANNN BigGAN&quot; =~ &quot;[A-Z][A-Z][A-Z]&quot; :: (String,String,String)</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="co">-- → (&quot;Big&quot;,&quot;GAN&quot;,&quot;NN BigGAN&quot;)</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="co">-- This regexp can be extended to handle mixed alphanumeric examples like &quot;GPT-2-117M&quot; where not smallcapsing the &#39;M&#39; would make it larger than &#39;GPT&#39; and look odd, by alternation and handling the 3 possible cases of a number at the beginning/middle/end.</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="co">-- Function examples:</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="co">-- walk smallcapsfyInline [Str &quot;BigGAN&quot;]</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="co">-- → [RawInline (Format &quot;html&quot;) &quot;Big&lt;span class=\&quot;smallcaps-auto\&quot;&gt;GAN&lt;/span&gt;&quot;]</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="co">-- walk smallcapsfyInline [Str &quot;BigGANNN means big&quot;]</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="co">-- → [RawInline (Format &quot;html&quot;) &quot;Big&lt;span class=\&quot;smallcaps-auto\&quot;&gt;GANNN&lt;/span&gt; means big&quot;]</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="co">-- walk smallcapsfyInline [Str &quot;biggan means big&quot;]</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="co">-- → [Str &quot;biggan means big&quot;]</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="co">-- walk smallcapsfyInline [Str &quot;GPT-2-117M is a neural language model with ~117,000,000 parameters (fitting in 150MB) but smaller than GPT-2-1.5b and easily trained on a P100 using FP16; it is difficult to reach GPT-like levels&quot;]</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="co">-- → RawInline (Format &quot;html&quot;) &quot;&lt;span class=\&quot;smallcaps-auto\&quot;&gt;GPT-2-117M&lt;/span&gt; is a neural language model with ~117,000,000 parameters (fitting in 150MB) but smaller than &lt;span class=\&quot;smallcaps-auto\&quot;&gt;GPT-2-1&lt;/span&gt;.5b and easily trained on a P100 using FP16; it is difficult to reach &lt;span class=\&quot;smallcaps-auto\&quot;&gt;GPT&lt;/span&gt;-like levels&quot;</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="co">-- Whole-document examples:</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="co">--  walk smallcapsfyInline [Str &quot;bigGAN means&quot;, Emph [Str &quot;BIG&quot;]]</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="co">-- → [RawInline (Format &quot;html&quot;) &quot;big&lt;span class=\&quot;smallcaps-auto\&quot;&gt;GAN&lt;/span&gt; means&quot;,Emph [RawInline (Format &quot;html&quot;) &quot;&lt;span class=\&quot;smallcaps-auto\&quot;&gt;BIG&lt;/span&gt;&quot;]]</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="co">-- We exclude headers because on Gwern.net, headers are uppercase already, which makes auto-smallcaps look odd. So we skip header Block elements before doing the replacement on all other Block elements</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="ot">smallcapsfy ::</span> <span class="dt">Block</span> <span class="ot">-&gt;</span> <span class="dt">Block</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>smallcapsfy h<span class="op">@</span><span class="dt">Header</span>{} <span class="ot">=</span> h</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>smallcapsfy x          <span class="ot">=</span> walk smallcapsfyInline x</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>smallcapsfyInline,<span class="ot"> smallcapsfyInlineCleanup ::</span> <span class="dt">Inline</span> <span class="ot">-&gt;</span> <span class="dt">Inline</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>smallcapsfyInline x<span class="op">@</span>(<span class="dt">Str</span> s) <span class="ot">=</span> <span class="kw">let</span> rewrite <span class="ot">=</span> go s <span class="kw">in</span> <span class="kw">if</span> s <span class="op">/=</span> rewrite <span class="kw">then</span> <span class="dt">RawInline</span> <span class="st">&quot;html&quot;</span> rewrite <span class="kw">else</span> x</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="ot">    go ::</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">T.Text</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    go <span class="st">&quot;&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    go a <span class="ot">=</span> <span class="kw">let</span> (before,matched,after) <span class="ot">=</span> R.match smallcapsfyRegex (T.unpack a)<span class="ot"> ::</span> (<span class="dt">String</span>,<span class="dt">String</span>,<span class="dt">String</span>)</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>                                 <span class="kw">in</span> <span class="kw">if</span> matched<span class="op">==</span><span class="st">&quot;&quot;</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>                                    <span class="kw">then</span> a <span class="co">-- no acronym anywhere in it</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>                                    <span class="kw">else</span> (T.pack before)</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>                                         <span class="ot">`T.append`</span> <span class="st">&quot;&lt;span class=\&quot;smallcaps-auto\&quot;&gt;&quot;</span><span class="ot">`T.append`</span> (T.pack matched) <span class="ot">`T.append`</span> <span class="st">&quot;&lt;/span&gt;&quot;</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>                                         <span class="ot">`T.append`</span> go (T.pack after)</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>smallcapsfyInline x <span class="ot">=</span> x</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a><span class="co">-- Hack: collapse redundant span substitutions (this happens when we apply `typographyTransform` repeatedly eg if we scrape a Gwern.net abstract (which will already be smallcaps) as an annotation, and then go to inline it elsewhere like a link to that page on a different page):</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>smallcapsfyInlineCleanup x<span class="op">@</span>(<span class="dt">Span</span> (_,[<span class="st">&quot;smallcaps-auto&quot;</span>],_) [y<span class="op">@</span>(<span class="dt">RawInline</span> _ t)]) <span class="ot">=</span> <span class="kw">if</span> <span class="st">&quot;&lt;span class=\&quot;smallcaps-auto\&quot;&gt;&quot;</span> <span class="ot">`T.isInfixOf`</span> t <span class="kw">then</span> y <span class="kw">else</span> x</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>smallcapsfyInlineCleanup (<span class="dt">Span</span> (_,[<span class="st">&quot;smallcaps-auto&quot;</span>],_) (y<span class="op">@</span>(<span class="dt">Span</span> (_,[<span class="st">&quot;smallcaps-auto&quot;</span>],_) _)<span class="op">:</span>_)) <span class="ot">=</span> y</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>smallcapsfyInlineCleanup x<span class="op">@</span>(<span class="dt">Span</span> (_,[<span class="st">&quot;smallcaps-auto&quot;</span>],_) _) <span class="ot">=</span> x</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>smallcapsfyInlineCleanup x <span class="ot">=</span> x</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a><span class="co">-- define at top level to memoize / avoid recomputation for efficiency since it runs everywhere</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a><span class="ot">smallcapsfyRegex ::</span> <span class="dt">R.Regex</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>smallcapsfyRegex <span class="ot">=</span> R.makeRegex</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- match standard acronyms like ABC or ABCDEF:</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>  (<span class="st">&quot;[A-Z][A-Z][A-Z]+|&quot;</span> <span class="op">++</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- match hyphen-separated acronyms like &#39;GPT-2-117M&#39; but not small mixed like &#39;150MB&#39;/&#39;P100&#39;/&#39;FP16&#39;</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- or hyphenated expressions with lowercase letters like &#39;BigGAN-level&#39;:</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;[A-Z][A-Z][A-Z]+(-[[:digit:]]+|[A-Z]+)+|&quot;</span> <span class="op">++</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- smallcaps entirety of &quot;TPUv3&quot;, oldstyle numbers look odd when juxtaposed against smallcaps+lowercase</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;[A-Z][A-Z][A-Z]+([[:digit:]]+|[a-zA-Z]+)+|&quot;</span> <span class="op">++</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- but we do want to continue across hyphens of all-uppercase strings like &quot;YYYY-MM-DD&quot; or &quot;X-UNITER&quot; or &quot;DALL·E&quot;:</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;[A-Z][A-Z][A-Z]+(-[A-Z]+)+|&quot;</span> <span class="op">++</span> <span class="st">&quot;[A-Z]+-[A-Z][A-Z][A-Z]+|&quot;</span> <span class="op">++</span> <span class="st">&quot;[A-Z]+\183[A-Z]+|&quot;</span> <span class="op">++</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- or slashed acronyms like &quot;TCP/IP&quot;: eg</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- walk smallcapsfyInline [Str &quot;Connecting using TCP/IP&quot;]</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- → [RawInline (Format &quot;html&quot;) &quot;Connecting using &lt;span class=\&quot;smallcaps-auto\&quot;&gt;TCP/IP&lt;/span&gt;&quot;]</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- walk smallcapsfyInline [Str &quot;Connecting using TCP&quot;]</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- → [RawInline (Format &quot;html&quot;) &quot;Connecting using &lt;span class=\&quot;smallcaps-auto\&quot;&gt;TCP&lt;/span&gt;&quot;]</span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- walk smallcapsfyInline [Str &quot;Connecting using IP&quot;]</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- → [Str &quot;Connecting using IP&quot;]</span></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- walk smallcapsfyInline [Str &quot;Connecting using TCP IP&quot;]</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- → [RawInline (Format &quot;html&quot;) &quot;Connecting using &lt;span class=\&quot;smallcaps-auto\&quot;&gt;TCP&lt;/span&gt; IP&quot;]</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;[A-Z][A-Z][A-Z]+(/[A-Z]+)+|&quot;</span> <span class="op">++</span> <span class="st">&quot;[A-Z]+/[A-Z][A-Z][A-Z]+|&quot;</span> <span class="op">++</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- special-case AM/PM like &quot;9:30AM&quot; or &quot;1PM&quot; or &quot;5:55 PM&quot; (</span><span class="al">WARNING</span><span class="co">: Pandoc will typically parse spaces into &#39;Space&#39; AST nodes, making it hard to match on things like &quot;5 PM&quot;)</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;[[:digit:]]+ ?[AP]M|&quot;</span> <span class="op">++</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;\\??[AP]M|&quot;</span> <span class="op">++</span> <span class="co">-- special-case handling for all the &quot;?AM--?PM&quot; in /Morning-writing:</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- according to https://en.wikipedia.org/wiki/Small_caps#Uses http://theworldsgreatestbook.com/book-design-part-5/ http://webtypography.net/3.2.2 , smallcaps is also often specially applied to a few two-letter initialisms/acronyms</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>   <span class="co">-- special-case AD/BC as well, &quot;1AD&quot;, &quot;10 BC&quot;, &quot;1955 AD&quot;:</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;^AD.?$|&quot;</span>  <span class="op">++</span> <span class="st">&quot;^BC.?$|&quot;</span>  <span class="op">++</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;[[:digit:]]+ ?ADE?|&quot;</span> <span class="op">++</span> <span class="st">&quot;[[:digit:]]+ ?BCE?&quot;</span><span class="ot">::</span><span class="dt">String</span>)</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a><span class="co">-------------------------------------------</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a><span class="co">-- add &#39;&lt;wbr&gt;&#39; (https://developer.mozilla.org/en-US/docs/Web/HTML/Element/wbr) HTML element to inline uses of forward slashes, such as in lists, to tell Chrome to linebreak there (see https://www.gwern.net/Lorem#inline-formatting in Chrome for examples of how its linebreaking is incompetent, sadly).</span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a><span class="co">-- </span><span class="al">WARNING</span><span class="co">: this will affect link texts like &#39;[AC/DC](!Wikipedia)&#39;, so make sure you do the rewrite after the interwiki and any passes which insert inline HTML - right now &#39;breakSlashes&#39; tests for possible HTML and bails out to avoid damaging it</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a><span class="ot">breakSlashes ::</span> <span class="dt">Block</span> <span class="ot">-&gt;</span> <span class="dt">Block</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a><span class="co">-- skip CodeBlock/RawBlock/Header/Table: enabling line-breaking on slashes there is a bad idea or not possible:</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>breakSlashes x<span class="op">@</span><span class="dt">CodeBlock</span>{} <span class="ot">=</span> x</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>breakSlashes x<span class="op">@</span><span class="dt">RawBlock</span>{}  <span class="ot">=</span> x</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>breakSlashes x<span class="op">@</span><span class="dt">Header</span>{}    <span class="ot">=</span> x</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>breakSlashes x<span class="op">@</span><span class="dt">Table</span>{}     <span class="ot">=</span> x</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>breakSlashes x <span class="ot">=</span> walk breakSlashesInline x</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a><span class="ot">breakSlashesInline ::</span> <span class="dt">Inline</span> <span class="ot">-&gt;</span> <span class="dt">Inline</span></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>breakSlashesInline x<span class="op">@</span>(<span class="dt">SmallCaps</span> _) <span class="ot">=</span> x</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>breakSlashesInline x<span class="op">@</span>(<span class="dt">Str</span> s) <span class="ot">=</span> <span class="kw">if</span> T.any (\t <span class="ot">-&gt;</span> t<span class="op">==</span><span class="ch">&#39;/&#39;</span> <span class="op">&amp;&amp;</span> <span class="fu">not</span> (t<span class="op">==</span><span class="ch">&#39;&lt;&#39;</span> <span class="op">||</span> t<span class="op">==</span><span class="ch">&#39;&gt;&#39;</span>)) s <span class="kw">then</span> <span class="co">-- things get tricky if we mess around with raw HTML, so we bail out for anything that even *looks* like it might be HTML tags &amp; has &#39;&lt;&gt;&#39;</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>                                 <span class="dt">RawInline</span> <span class="st">&quot;html&quot;</span> (T.replace <span class="st">&quot; /&lt;wbr&gt; &quot;</span> <span class="st">&quot; / &quot;</span> <span class="op">$</span> T.replace <span class="st">&quot; /&lt;wbr&gt;&quot;</span> <span class="st">&quot; /&quot;</span> <span class="op">$</span> T.replace <span class="st">&quot;/&lt;wbr&gt; &quot;</span> <span class="st">&quot;/ &quot;</span> <span class="op">$</span> <span class="co">-- fix redundant &lt;wbr&gt;s to make HTML source nicer to read; 2 cleanup substitutions is easier than using a full regexp rewrite</span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>                                                   T.replace <span class="st">&quot;/&quot;</span> <span class="st">&quot;/&lt;wbr&gt;&quot;</span> s) <span class="kw">else</span> x</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>breakSlashesInline x <span class="ot">=</span> x</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a><span class="ot">breakEquals ::</span> <span class="dt">Block</span> <span class="ot">-&gt;</span> <span class="dt">Block</span></span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>breakEquals x<span class="op">@</span><span class="dt">CodeBlock</span>{} <span class="ot">=</span> x</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>breakEquals x<span class="op">@</span><span class="dt">RawBlock</span>{}  <span class="ot">=</span> x</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>breakEquals x<span class="op">@</span><span class="dt">Header</span>{}    <span class="ot">=</span> x</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>breakEquals x<span class="op">@</span><span class="dt">Table</span>{}     <span class="ot">=</span> x</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>breakEquals x <span class="ot">=</span> walk breakEqualsInline x</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a><span class="ot">breakEqualsInline ::</span> <span class="dt">Inline</span> <span class="ot">-&gt;</span> <span class="dt">Inline</span></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>breakEqualsInline (<span class="dt">Str</span> s) <span class="ot">=</span> <span class="kw">let</span> s&#39; <span class="ot">=</span> T.unpack s <span class="kw">in</span> <span class="dt">Str</span> <span class="op">$</span> T.pack <span class="op">$</span> subRegex equalsRegex s&#39; <span class="st">&quot; \\1 \\2&quot;</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>breakEqualsInline x <span class="ot">=</span> x</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a><span class="ot">equalsRegex ::</span> <span class="dt">R.Regex</span></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>equalsRegex <span class="ot">=</span> mkRegex <span class="st">&quot;([=≠])([a-zA-Z0-9])&quot;</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a><span class="co">-------------------------------------------</span></span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a><span class="co">-- Look at mean color of image, 0-1: if it&#39;s close to 0, then it&#39;s a monochrome-ish white-heavy image. Such images look better in HTML/CSS dark mode when inverted, so we can use this to check every image for color, and set an &#39;invertible-auto&#39; HTML class on the ones which are low. We can manually specify a &#39;invertible&#39; class on images which don&#39;t pass the heuristic but should.</span></span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a><span class="ot">invertImageInline ::</span> <span class="dt">Inline</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Inline</span></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>invertImageInline x<span class="op">@</span>(<span class="dt">Image</span> (htmlid, classes, kvs) xs (p,t)) <span class="ot">=</span></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> notInvertibleP classes <span class="kw">then</span></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> x <span class="kw">else</span> <span class="kw">do</span></span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>                   (color,_,_) <span class="ot">&lt;-</span> invertFile p</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>                   <span class="kw">if</span> <span class="fu">not</span> color <span class="kw">then</span> <span class="fu">return</span> x <span class="kw">else</span></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">return</span> (<span class="dt">Image</span> (htmlid, <span class="st">&quot;invertible-auto&quot;</span><span class="op">:</span>classes, kvs<span class="op">++</span>[(<span class="st">&quot;loading&quot;</span>,<span class="st">&quot;lazy&quot;</span>)]) xs (p,t))</span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>invertImageInline x<span class="op">@</span>(<span class="dt">Link</span> (htmlid, classes, kvs) xs (p, t)) <span class="ot">=</span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> notInvertibleP classes <span class="op">||</span> <span class="fu">not</span> (<span class="st">&quot;.png&quot;</span> <span class="ot">`T.isSuffixOf`</span> p <span class="op">||</span> <span class="st">&quot;.jpg&quot;</span> <span class="ot">`T.isSuffixOf`</span> p)  <span class="kw">then</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>                                                          <span class="fu">return</span> x <span class="kw">else</span></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>                                                            <span class="kw">do</span> (color,_,_) <span class="ot">&lt;-</span> invertFile p</span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>                                                               <span class="kw">if</span> <span class="fu">not</span> color <span class="kw">then</span> <span class="fu">return</span> x <span class="kw">else</span></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="fu">return</span> (<span class="dt">Link</span> (htmlid, <span class="st">&quot;invertible-auto&quot;</span><span class="op">:</span>classes, kvs) xs (p,t))</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>invertImageInline x <span class="ot">=</span> <span class="fu">return</span> x</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a><span class="ot">invertFile ::</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Bool</span>, <span class="dt">String</span>, <span class="dt">String</span>)</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>invertFile p <span class="ot">=</span> <span class="kw">do</span> <span class="kw">let</span> p&#39; <span class="ot">=</span> T.unpack p</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>                  <span class="kw">let</span> p&#39;&#39; <span class="ot">=</span> <span class="kw">if</span> <span class="fu">head</span> p&#39; <span class="op">==</span> <span class="ch">&#39;/&#39;</span> <span class="kw">then</span> <span class="fu">tail</span> p&#39; <span class="kw">else</span> p&#39;</span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>                  invertImage p&#39;&#39;</span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a><span class="ot">notInvertibleP ::</span> [<span class="dt">T.Text</span>] <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>notInvertibleP classes <span class="ot">=</span> <span class="st">&quot;invertible-not&quot;</span> <span class="ot">`elem`</span> classes</span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a><span class="ot">invertImage ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Bool</span>, <span class="dt">String</span>, <span class="dt">String</span>) <span class="co">-- invertible / height / width</span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>invertImage f <span class="op">|</span> <span class="st">&quot;https://www.gwern.net/&quot;</span> <span class="ot">`isPrefixOf`</span> f <span class="ot">=</span> invertImageLocal <span class="op">$</span> Data.List.Utils.replace <span class="st">&quot;https://www.gwern.net/&quot;</span> <span class="st">&quot;&quot;</span> f</span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>              <span class="op">|</span> <span class="st">&quot;http&quot;</span> <span class="ot">`isPrefixOf`</span> f <span class="ot">=</span> <span class="kw">do</span> (temp,_) <span class="ot">&lt;-</span> mkstemp <span class="st">&quot;/tmp/image-invertible&quot;</span></span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>                                           <span class="co">-- </span><span class="al">NOTE</span><span class="co">: while wget preserves it, curl erases the original modification time reported by server in favor of local file creation; this is useful for `invertImagePreview` --- we want to check downloaded images manually before their annotation gets stored permanently.</span></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>                                           (status,_,_) <span class="ot">&lt;-</span> runShellCommand <span class="st">&quot;./&quot;</span> <span class="dt">Nothing</span> <span class="st">&quot;curl&quot;</span> [<span class="st">&quot;--location&quot;</span>, <span class="st">&quot;--silent&quot;</span>, <span class="st">&quot;--user-agent&quot;</span>, <span class="st">&quot;gwern+wikipediascraping@gwern.net&quot;</span>, f, <span class="st">&quot;--output&quot;</span>, temp]</span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>                                           <span class="kw">case</span> status <span class="kw">of</span></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>                                             <span class="dt">ExitFailure</span> _ <span class="ot">-&gt;</span> <span class="kw">do</span> hPrint stderr (<span class="st">&quot;Download failed (unable to check image invertibility): &quot;</span> <span class="op">++</span> f)</span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>                                                                 removeFile temp</span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="fu">return</span> (<span class="dt">False</span>, <span class="st">&quot;320&quot;</span>, <span class="st">&quot;320&quot;</span>) <span class="co">-- </span><span class="al">NOTE</span><span class="co">: most WP thumbnails are 320/320px squares, so to be safe we&#39;ll use that as a default value</span></span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>                                             _ <span class="ot">-&gt;</span> <span class="kw">do</span> c <span class="ot">&lt;-</span> imageMagickColor f temp</span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>                                                     (h,w) <span class="ot">&lt;-</span> imageMagickDimensions temp</span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>                                                     <span class="kw">let</span> invertp <span class="ot">=</span> c <span class="op">&lt;</span> invertThreshold</span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>                                                     when invertp <span class="op">$</span> invertImagePreview temp</span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>                                                     removeFile temp</span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>                                                     <span class="fu">return</span> (invertp, h, w)</span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>              <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> invertImageLocal f</span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a><span class="ot">invertImageLocal ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Bool</span>, <span class="dt">String</span>, <span class="dt">String</span>)</span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a>invertImageLocal <span class="st">&quot;&quot;</span> <span class="ot">=</span> <span class="fu">return</span> (<span class="dt">False</span>, <span class="st">&quot;0&quot;</span>, <span class="st">&quot;0&quot;</span>)</span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>invertImageLocal f <span class="ot">=</span> <span class="kw">do</span> c <span class="ot">&lt;-</span> imageMagickColor f f</span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>                        (h,w) <span class="ot">&lt;-</span> imageMagickDimensions f</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">let</span> invertp <span class="ot">=</span> c <span class="op">&lt;</span> invertThreshold</span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">return</span> (invertp, h, w)</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a><span class="ot">invertThreshold ::</span> <span class="dt">Float</span></span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>invertThreshold <span class="ot">=</span> <span class="fl">0.09</span></span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a><span class="co">-- Manually check the inverted version of new images which trigger the inversion heuristic. I don&#39;t want to store a database of image inversion status, so I&#39;ll use the cheaper heuristic of just opening up every image modified &lt;1 day ago (which should catch all of the WP thumbnails + any images added).</span></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a><span class="ot">invertImagePreview ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>invertImagePreview f <span class="ot">=</span> <span class="kw">do</span> utcFile <span class="ot">&lt;-</span> getModificationTime f</span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>                          utcNow  <span class="ot">&lt;-</span> getCurrentTime</span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>                          <span class="kw">let</span> age  <span class="ot">=</span> utcNow <span class="ot">`diffUTCTime`</span> utcFile</span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>                          when (age <span class="op">&lt;</span> nominalDay) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>                            <span class="kw">let</span> f&#39; <span class="ot">=</span> f<span class="op">++</span><span class="st">&quot;-inverted.png&quot;</span></span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>                            void <span class="op">$</span> runShellCommand <span class="st">&quot;./&quot;</span> <span class="dt">Nothing</span> <span class="st">&quot;convert&quot;</span> [<span class="st">&quot;-negate&quot;</span>, f, f&#39;]</span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>                            void <span class="op">$</span> runShellCommand <span class="st">&quot;./&quot;</span> <span class="dt">Nothing</span> <span class="st">&quot;firefox&quot;</span> [f&#39;]</span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>                            threadDelay <span class="dv">5000000</span></span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>                            removeFile f&#39;</span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">return</span> ()</span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a><span class="ot">imageMagickColor ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Float</span></span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>imageMagickColor f f&#39; <span class="ot">=</span> <span class="kw">do</span> (status,_,bs) <span class="ot">&lt;-</span> runShellCommand <span class="st">&quot;./&quot;</span> <span class="dt">Nothing</span> <span class="st">&quot;convert&quot;</span> [f&#39;, <span class="st">&quot;-colorspace&quot;</span>, <span class="st">&quot;HSL&quot;</span>, <span class="st">&quot;-channel&quot;</span>, <span class="st">&quot;g&quot;</span>, <span class="st">&quot;-separate&quot;</span>, <span class="st">&quot;+channel&quot;</span>, <span class="st">&quot;-format&quot;</span>, <span class="st">&quot;%[fx:mean]&quot;</span>, <span class="st">&quot;info:&quot;</span>]</span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>                           <span class="kw">case</span> status <span class="kw">of</span></span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a>                             <span class="dt">ExitFailure</span> err <span class="ot">-&gt;</span>  <span class="fu">putStrLn</span> (f <span class="op">++</span> <span class="st">&quot; : ImageMagick color read error: &quot;</span> <span class="op">++</span> <span class="fu">show</span> err <span class="op">++</span> <span class="st">&quot; &quot;</span> <span class="op">++</span> f&#39;) <span class="op">&gt;&gt;</span> <span class="fu">return</span> <span class="fl">1.0</span></span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>                             _ <span class="ot">-&gt;</span> <span class="kw">do</span> <span class="kw">let</span> color <span class="ot">=</span> <span class="fu">read</span> (<span class="fu">take</span> <span class="dv">4</span> <span class="op">$</span> unpack bs)<span class="ot"> ::</span> <span class="dt">Float</span> <span class="co">-- </span><span class="al">WARNING</span><span class="co">: for GIFs, ImageMagick returns the mean for each frame; &#39;take 4&#39; should give us the first frame, more or less</span></span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">return</span> color</span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Use FileStore utility to run imageMagick&#39;s &#39;identify&#39;, &amp; extract the height/width dimensions</span></span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a><span class="co">-- Note that for animated GIFs, &#39;identify&#39; returns width/height for each frame of the GIF, which in</span></span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a><span class="co">-- most cases will all be the same, so we take the first line of whatever dimensions &#39;identify&#39; returns.</span></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a><span class="ot">imageMagickDimensions ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">String</span>,<span class="dt">String</span>)</span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>imageMagickDimensions f <span class="ot">=</span></span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> f&#39;</span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> <span class="st">&quot;/&quot;</span> <span class="ot">`isPrefixOf`</span> f <span class="op">&amp;&amp;</span> <span class="fu">not</span> (<span class="st">&quot;/tmp&quot;</span> <span class="ot">`isPrefixOf`</span> f) <span class="ot">=</span> <span class="fu">tail</span> f</span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> <span class="st">&quot;https://www.gwern.net/&quot;</span> <span class="ot">`isPrefixOf`</span> f <span class="ot">=</span> <span class="fu">drop</span> <span class="dv">22</span> f</span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> f</span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a>  <span class="kw">in</span></span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a>    <span class="kw">do</span> (status,_,bs) <span class="ot">&lt;-</span> runShellCommand <span class="st">&quot;./&quot;</span> <span class="dt">Nothing</span> <span class="st">&quot;identify&quot;</span> [<span class="st">&quot;-format&quot;</span>, <span class="st">&quot;%h %w\n&quot;</span>, f&#39;]</span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>       <span class="kw">case</span> status <span class="kw">of</span></span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>         <span class="dt">ExitFailure</span> _ <span class="ot">-&gt;</span> <span class="fu">error</span> f</span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>         _             <span class="ot">-&gt;</span> <span class="kw">do</span> <span class="kw">let</span> [height, width] <span class="ot">=</span> <span class="fu">words</span> <span class="op">$</span> <span class="fu">head</span> <span class="op">$</span> <span class="fu">lines</span> <span class="op">$</span> B8.unpack bs</span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span> (height, width)</span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a><span class="co">-------------------------------------------</span></span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a><span class="co">-- Annotate body horizontal rulers with a class based on global count: &#39;&lt;div class=&quot;ruler-nth-0&quot;&gt; / &lt;hr /&gt; / &lt;/div&gt;&#39; / &#39;&lt;div class=&quot;ruler-nth-1&quot;&gt; / &lt;hr /&gt; / &lt;/div&gt;&#39; / &#39;&lt;div class=&quot;ruler-nth-2&quot;&gt; / &lt;hr /&gt; / &lt;/div&gt;&#39; etc (cycling). Allows CSS decoration of &quot;every second ruler&quot; or &quot;every fourth ruler&quot; etc. I use it for cycling rulers in 3 levels, similar to the rest of Gwern.net&#39;s visual design.</span></span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a><span class="co">-- Generalized versions for arbitrary Inline/Block types using generic programming: https://groups.google.com/g/pandoc-discuss/c/x1IXyfC2tfU/m/sXnHU7DIAgAJ (not currently necessary, but worth noting should I need to number anything in the future).</span></span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a><span class="co">-- (</span><span class="al">NOTE</span><span class="co">: As a rewrite pass, this does not affect the horizontal ruler in the endnotes section, nor any horizontal rulers in the outer HTML document.)</span></span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a><span class="ot">rulersCycle ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Pandoc</span> <span class="ot">-&gt;</span> <span class="dt">Pandoc</span></span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a>rulersCycle modulus doc <span class="ot">=</span> evalState (walkM addHrNth doc) <span class="dv">0</span></span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a> <span class="kw">where</span><span class="ot"> addHrNth ::</span> <span class="dt">Block</span> <span class="ot">-&gt;</span> <span class="dt">State</span> <span class="dt">Int</span> <span class="dt">Block</span></span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>       addHrNth <span class="dt">HorizontalRule</span> <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a>         count <span class="ot">&lt;-</span> get</span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>         put (count <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a>         <span class="kw">let</span> nth <span class="ot">=</span> count <span class="ot">`mod`</span> modulus</span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>         <span class="kw">let</span> nthClass <span class="ot">=</span> T.pack <span class="op">$</span> <span class="st">&quot;horizontalRule&quot;</span> <span class="op">++</span> <span class="st">&quot;-nth-&quot;</span> <span class="op">++</span> <span class="fu">show</span> nth</span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span> <span class="op">$</span> <span class="dt">Div</span> (<span class="st">&quot;&quot;</span>, [nthClass], []) [<span class="dt">HorizontalRule</span>]</span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a>       addHrNth x <span class="ot">=</span> <span class="fu">return</span> x</span></code></pre></div>
