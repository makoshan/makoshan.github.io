<div class="sourceCode" id="cb1"><pre class="sourceCode Haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#!/usr/bin/env runhaskell</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">{-</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">Hakyll file for building Gwern.net</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">Author: gwern</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">Date: 2010-10-01</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">When: Time-stamp: &quot;2021-07-11 20:42:47 gwern&quot;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">License: CC-0</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">Debian dependencies:</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">$ sudo apt-get install libghc-hakyll-dev libghc-pandoc-dev libghc-filestore-dev libghc-tagsoup-dev libghc-yaml-dev imagemagick s3cmd git libghc-aeson-dev libghc-missingh-dev libghc-digest-dev tidy gridsite-clients</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">(GHC is needed for Haskell; Hakyll &amp; Pandoc do the heavy lifting of compiling Markdown files to HTML; tag soup &amp; ImageMagick are runtime dependencies used to help optimize images, and s3cmd/git upload to hosting/Github respectively.)</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">Demo command (for the full script, with all static checks &amp; generation &amp; optimizations, see `sync-gwern.net.sh`):</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">$ cd ~/wiki/ &amp;&amp; ghc -rtsopts -threaded -O2 -fforce-recomp -optl-s --make hakyll.hs &amp;&amp;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">  ./hakyll rebuild +RTS -N3 -RTS &amp;&amp; echo -n -e &#39;\a&#39;  &amp;&amp;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co">  s3cmd -v -v --human-readable-sizes --reduced-redundancy --no-mime-magic --guess-mime-type --default-mime-type=text/html</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co">        --add-header=&quot;Cache-Control: max-age=604800, public&quot; --delete-removed sync _site/ s3://www.gwern.net/ &amp;&amp;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">  rm -rf ~/wiki/_cache/ ~/wiki/_site/ &amp;&amp; rm ./hakyll *.o *.hi ;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co">  git push; echo -n -e &#39;\a&#39;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">Explanations:</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co">- we could run Hakyll with a command like `./hakyll.hs build` but this would run much slower than if we compile an optimized parallelized binary &amp; run it with multiple threads; this comes at the cost of considerable extra complexity in the invocation, though, since we need to compile it with fancy options, run it with other options, and then at the end clean up by deleting the compiled binary &amp; intermediates (GHC cannot take care of them on its own: https://ghc.haskell.org/trac/ghc/ticket/4114 )</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co">- `rebuild` instead of &#39;build&#39; because IIRC there was some problem where Hakyll didn&#39;t like extension-less files so incremental syncs/builds don&#39;t work; this tells Hakyll</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co"> to throw everything away without even trying to check</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co">- s3cmd:</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co">    - `--reduced-redundancy` saves a bit of money; no need for high-durability since everything is backed up locally in the git repo, after all</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co">    - s3cmd&#39;s MIME type detection has been unreliable in the past due to long-standing bugs in `python-magic` (particularly with CSS), so we need to force a default, especially for the extension-less (HTML) files</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co">- after that, we clean up after ourselves and sync with the Github mirror as well</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co">- the &#39;echo&#39; calls are there to ring the terminal bell and notify the user that he needs to edit the Modafinil file or that the whole thing is done</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co">-}</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Exception</span> (onException)</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Monad</span> (when, void)</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Char</span> (toLower)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.List</span> (isPrefixOf, nubBy, sort)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Maybe</span> (isNothing)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Monoid</span> ((&lt;&gt;))</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.HTTP</span> (urlDecode)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.Directory</span> (doesFileExist)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.FilePath</span> (takeExtension)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.FileStore.Utils</span> (runShellCommand)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Hakyll</span> (applyTemplateList, buildTags, compile, composeRoutes, constField,</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>               copyFileCompiler, dateField, defaultContext, defaultHakyllReaderOptions, field, getMetadata, lookupString,</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>               defaultHakyllWriterOptions, fromCapture, getRoute, gsubRoute, hakyll, idRoute, itemIdentifier,</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>               loadAll, loadAndApplyTemplate, loadBody, makeItem, match, modificationTimeField, mapContext,</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>               pandocCompilerWithTransformM, route, setExtension, pathField, preprocess,</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>               tagsField, tagsRules, templateCompiler, version, <span class="dt">Compiler</span>, <span class="dt">Context</span>, <span class="dt">Item</span>, <span class="dt">Pattern</span>, <span class="dt">Tags</span>, unsafeCompiler, noResult)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.Exit</span> (<span class="dt">ExitCode</span>(<span class="dt">ExitFailure</span>))</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.HTML.TagSoup</span> (renderTagsOptions, parseTags, renderOptions, optMinimize, optRawTag, <span class="dt">Tag</span>(<span class="dt">TagOpen</span>))</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.Pandoc.Shared</span> (blocksToInlines)</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.Pandoc</span> (nullAttr, runPure, runWithDefaultPartials, compileTemplate,</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>                    def, pandocExtensions, readerExtensions, readMarkdown, writeHtml5String,</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Block</span>(<span class="op">..</span>), <span class="dt">HTMLMathMethod</span>(<span class="dt">MathJax</span>), defaultMathJaxURL, <span class="dt">Inline</span>(<span class="op">..</span>),</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">ObfuscationMethod</span>(<span class="dt">NoObfuscation</span>), <span class="dt">Pandoc</span>(<span class="op">..</span>), <span class="dt">WriterOptions</span>(<span class="op">..</span>))</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.Pandoc.Walk</span> (walk, walkM)</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.HTTP</span> (urlEncode)</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.List.Utils</span> (replace)</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span> (append, isInfixOf, isPrefixOf, isSuffixOf, pack, unpack)</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="co">-- local custom modules:</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Inflation</span> (nominalToRealInflationAdjuster)</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Interwiki</span> (convertInterwikiLinks, inlinesToString)</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">LinkMetadata</span> (isLocalLink, readLinkMetadata, writeAnnotationFragments, <span class="dt">Metadata</span>, createAnnotations, hasAnnotation)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">LinkArchive</span> (localizeLink, readArchiveMetadata, <span class="dt">ArchiveMetadata</span>)</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Typography</span> (typographyTransform, invertImageInline, imageMagickDimensions)</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">LinkAuto</span> (linkAuto)</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> hakyll <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>             tags <span class="ot">&lt;-</span> buildTags <span class="st">&quot;**.page&quot;</span> (fromCapture <span class="st">&quot;tags/*&quot;</span>)</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>             preprocess <span class="op">$</span> <span class="fu">print</span> (<span class="st">&quot;Local archives parsing...&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>             am <span class="ot">&lt;-</span> preprocess readArchiveMetadata</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>             <span class="co">-- popup metadata:</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>             preprocess <span class="op">$</span> <span class="fu">print</span> (<span class="st">&quot;Popups parsing...&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>             meta <span class="ot">&lt;-</span> preprocess readLinkMetadata</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>             preprocess <span class="op">$</span> <span class="fu">print</span> (<span class="st">&quot;Writing annotations...&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>             preprocess <span class="op">$</span> writeAnnotationFragments am meta</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>             preprocess <span class="op">$</span> <span class="fu">print</span> (<span class="st">&quot;Begin site compilation...&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>             match <span class="st">&quot;**.page&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>                 <span class="co">-- strip extension since users shouldn&#39;t care if HTML3-5/XHTML/etc (cool URLs); delete apostrophes/commas &amp; replace spaces with hyphens</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>                 <span class="co">-- as people keep screwing them up endlessly:</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>                 route <span class="op">$</span> gsubRoute <span class="st">&quot;,&quot;</span> (<span class="fu">const</span> <span class="st">&quot;&quot;</span>) <span class="ot">`composeRoutes`</span> gsubRoute <span class="st">&quot;&#39;&quot;</span> (<span class="fu">const</span> <span class="st">&quot;&quot;</span>) <span class="ot">`composeRoutes`</span> gsubRoute <span class="st">&quot; &quot;</span> (<span class="fu">const</span> <span class="st">&quot;-&quot;</span>) <span class="ot">`composeRoutes`</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>                          setExtension <span class="st">&quot;&quot;</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>                 <span class="co">-- https://groups.google.com/forum/#!topic/pandoc-discuss/HVHY7-IOLSs</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>                 <span class="kw">let</span> readerOptions <span class="ot">=</span> defaultHakyllReaderOptions</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>                 compile <span class="op">$</span> pandocCompilerWithTransformM readerOptions woptions (unsafeCompiler <span class="op">.</span> pandocTransform meta am)</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>                     <span class="op">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;static/templates/default.html&quot;</span> (postCtx tags)</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>                     <span class="op">&gt;&gt;=</span> imgUrls</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>             tagsRules tags <span class="op">$</span> \tag <span class="kw">pattern</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>                 <span class="kw">let</span> title <span class="ot">=</span> <span class="st">&quot;Tag: &quot;</span> <span class="op">++</span> tag</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>                 route idRoute</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>                 compile <span class="op">$</span> tagPage tags title <span class="kw">pattern</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>             <span class="co">-- handle the simple static non-.page files; we define this after the pages because the pages&#39; compilation has side-effects which may create new static files (archives &amp; downsized images)</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>             <span class="kw">let</span> static <span class="ot">=</span> route idRoute <span class="op">&gt;&gt;</span> compile copyFileCompiler <span class="co">-- </span><span class="al">WARNING</span><span class="co">: custom optimization requiring forked Hakyll installation; see https://github.com/jaspervdj/hakyll/issues/786</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>             version <span class="st">&quot;static&quot;</span> <span class="op">$</span> <span class="fu">mapM_</span> (<span class="ot">`match`</span> static) [</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;docs/**&quot;</span>,</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;images/**&quot;</span>,</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;**.hs&quot;</span>,</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;**.sh&quot;</span>,</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;**.txt&quot;</span>,</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;**.html&quot;</span>,</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;**.page&quot;</span>,</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;**.css&quot;</span>,</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;**.R&quot;</span>,</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;**.conf&quot;</span>,</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;**.php&quot;</span>,</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;**.svg&quot;</span>,</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;**.png&quot;</span>,</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;**.jpg&quot;</span>,</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;**.py&quot;</span>,</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>                                     <span class="co">-- skip &quot;static/build/**&quot; because of the temporary files</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/css/**&quot;</span>,</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/font/**&quot;</span>,</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/img/**&quot;</span>,</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/includes/**&quot;</span>,</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/nginx/**&quot;</span>,</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/redirects/**&quot;</span>,</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/templates/**&quot;</span>,</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.conf&quot;</span>,</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.css&quot;</span>,</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.gif&quot;</span>,</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.git&quot;</span>,</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.gitignore&quot;</span>,</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.hs&quot;</span>,</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.html&quot;</span>,</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.ico&quot;</span>,</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.js&quot;</span>,</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.net&quot;</span>,</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.png&quot;</span>,</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.png-768px&quot;</span>,</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.R&quot;</span>,</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.sh&quot;</span>,</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.svg&quot;</span>,</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.ttf&quot;</span>,</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.otf&quot;</span>,</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/**.php&quot;</span>,</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;**.yaml&quot;</span>,</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;metadata/**&quot;</span>,</span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;static/build/.htaccess&quot;</span>,</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;atom.xml&quot;</span>, <span class="co">-- copy stub of deprecated RSS feed</span></span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;tweet&quot;</span>,</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;index&quot;</span>]</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>             match <span class="st">&quot;static/templates/*.html&quot;</span> <span class="op">$</span> compile templateCompiler</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>             match <span class="st">&quot;static/includes/inlined-foot.html&quot;</span> <span class="op">$</span> compile templateCompiler</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>             match <span class="st">&quot;static/includes/inlined-head-escaped.html&quot;</span> <span class="op">$</span> compile templateCompiler</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a><span class="co">-- https://kyle.marek-spartz.org/posts/2014-12-09-hakyll-css-template-compiler.html</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a><span class="co">-- cssTemplateCompiler :: Compiler (Item Template)</span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a><span class="co">-- cssTemplateCompiler = cached &quot;Hakyll.Web.Template.cssTemplateCompiler&quot; $</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a><span class="co">--     fmap (readTemplate . compressCss) &lt;$&gt; getResourceString</span></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a><span class="ot">woptions ::</span> <span class="dt">WriterOptions</span></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>woptions <span class="ot">=</span> defaultHakyllWriterOptions{ writerSectionDivs <span class="ot">=</span> <span class="dt">True</span>,</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>                                       writerTableOfContents <span class="ot">=</span> <span class="dt">True</span>,</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>                                       writerColumns <span class="ot">=</span> <span class="dv">130</span>,</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>                                       writerTemplate <span class="ot">=</span> <span class="dt">Just</span> tocTemplate,</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>                                       writerTOCDepth <span class="ot">=</span> <span class="dv">4</span>,</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>                                       <span class="co">-- we use MathJax directly to bypass Texmath; this enables features like colored equations:</span></span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>                                       <span class="co">-- https://docs.mathjax.org/en/latest/input/tex/extensions/color.html http://mirrors.ctan.org/macros/latex/required/graphics/color.pdf#page=4 eg &quot;Roses are $\color{red}{\text{beautiful red}}$, violets are $\color{blue}{\text{lovely blue}}$&quot; or &quot;${\color{red} x} + {\color{blue} y}$&quot;</span></span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>                                       writerHTMLMathMethod <span class="ot">=</span> <span class="dt">MathJax</span> defaultMathJaxURL,</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>                                       writerEmailObfuscation <span class="ot">=</span> <span class="dt">NoObfuscation</span> }</span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>   <span class="kw">where</span></span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- below copied from https://github.com/jaspervdj/hakyll/blob/e8ed369edaae1808dffcc22d1c8fb1df7880e065/web/site.hs#L73 because god knows I don&#39;t know what this type bullshit is either:</span></span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- &quot;When did it get so hard to compile a string to a Pandoc template?&quot;</span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>    tocTemplate <span class="ot">=</span></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>        <span class="fu">either</span> <span class="fu">error</span> <span class="fu">id</span> <span class="op">$</span> <span class="fu">either</span> (<span class="fu">error</span> <span class="op">.</span> <span class="fu">show</span>) <span class="fu">id</span> <span class="op">$</span></span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>        runPure <span class="op">$</span> runWithDefaultPartials <span class="op">$</span></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>        compileTemplate <span class="st">&quot;&quot;</span> <span class="st">&quot;&lt;div id=\&quot;TOC\&quot;&gt;$toc$&lt;/div&gt;\n&lt;div id=\&quot;markdownBody\&quot; class=\&quot;markdownBody\&quot;&gt;$body$&lt;/div&gt;&quot;</span></span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a><span class="ot">postList ::</span> <span class="dt">Tags</span> <span class="ot">-&gt;</span> <span class="dt">Pattern</span> <span class="ot">-&gt;</span> ([<span class="dt">Item</span> <span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">Compiler</span> [<span class="dt">Item</span> <span class="dt">String</span>]) <span class="ot">-&gt;</span> <span class="dt">Compiler</span> <span class="dt">String</span></span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>postList tags <span class="kw">pattern</span> preprocess&#39; <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>    postItemTemplate <span class="ot">&lt;-</span> loadBody <span class="st">&quot;static/templates/postitem.html&quot;</span></span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>    posts&#39; <span class="ot">&lt;-</span> loadAll <span class="kw">pattern</span></span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>    posts <span class="ot">&lt;-</span> preprocess&#39; posts&#39;</span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>    applyTemplateList postItemTemplate (postCtx tags) posts</span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a><span class="ot">tagPage ::</span> <span class="dt">Tags</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Pattern</span> <span class="ot">-&gt;</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>)</span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>tagPage tags title <span class="kw">pattern</span> <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>    list <span class="ot">&lt;-</span> postList tags <span class="kw">pattern</span> (<span class="fu">return</span> <span class="op">.</span> <span class="fu">id</span>)</span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>    makeItem <span class="st">&quot;&quot;</span></span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>        <span class="op">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;static/templates/tags.html&quot;</span></span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>                (constField <span class="st">&quot;posts&quot;</span> list <span class="op">&lt;&gt;</span> constField <span class="st">&quot;title&quot;</span> title <span class="op">&lt;&gt;</span></span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a>                    defaultContext)</span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a><span class="ot">imgUrls ::</span> <span class="dt">Item</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>)</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>imgUrls item <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>    rte <span class="ot">&lt;-</span> getRoute <span class="op">$</span> itemIdentifier item</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> rte <span class="kw">of</span></span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> item</span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> _  <span class="ot">-&gt;</span> <span class="fu">traverse</span> (unsafeCompiler <span class="op">.</span> addImgDimensions) item</span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a><span class="ot">postCtx ::</span> <span class="dt">Tags</span> <span class="ot">-&gt;</span> <span class="dt">Context</span> <span class="dt">String</span></span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>postCtx tags <span class="ot">=</span></span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>    tagsField <span class="st">&quot;tagsHTML&quot;</span> tags <span class="op">&lt;&gt;</span></span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>    descField <span class="st">&quot;title&quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>    descField <span class="st">&quot;description&quot;</span> <span class="op">&lt;&gt;</span> <span class="co">-- constField &quot;description&quot; &quot;N/A&quot; &lt;&gt;</span></span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- </span><span class="al">NOTE</span><span class="co">: as a hack to implement conditional loading of JS/metadata in /index, in default.html, we switch on an &#39;index&#39; variable; this variable *must* be left empty (and not set using `constField &quot;index&quot; &quot;&quot;`)! (It is defined in the YAML front-matter of /index.page as `index: true` to set it to a non-null value.)</span></span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- similarly, &#39;author&#39;: default.html has a conditional to set &#39;Gwern Branwen&#39; as the author in the HTML metadata if &#39;author&#39; is not defined, but if it is, then the HTML metadata switches to the defined author &amp; the non-default author is exposed in the visible page metadata as well for the human readers.</span></span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>    defaultContext <span class="op">&lt;&gt;</span></span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>    dateField <span class="st">&quot;created&quot;</span> <span class="st">&quot;%F&quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- if no manually set last-modified time, fall back to checking file modification time:</span></span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a>    dateField <span class="st">&quot;modified&quot;</span> <span class="st">&quot;%F&quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>    modificationTimeField <span class="st">&quot;modified&quot;</span> <span class="st">&quot;%F&quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- page navigation defaults:</span></span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>    constField <span class="st">&quot;next&quot;</span> <span class="st">&quot;/index&quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>    constField <span class="st">&quot;previous&quot;</span> <span class="st">&quot;/index&quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- metadata:</span></span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>    constField <span class="st">&quot;status&quot;</span> <span class="st">&quot;notes&quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>    constField <span class="st">&quot;confidence&quot;</span> <span class="st">&quot;log&quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a>    constField <span class="st">&quot;importance&quot;</span> <span class="st">&quot;0&quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>    constField <span class="st">&quot;cssExtension&quot;</span> <span class="st">&quot;drop-caps-de-zs&quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a>    constField <span class="st">&quot;thumbnail&quot;</span> <span class="st">&quot;/static/img/logo/logo-whitebg-large-border.png&quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- for use in templating, `&lt;body class=&quot;$safeURL$&quot;&gt;`, allowing page-specific CSS:</span></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>    escapedTitleField <span class="st">&quot;safeURL&quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>    (mapContext (\p <span class="ot">-&gt;</span> (urlEncode <span class="op">$</span> <span class="fu">concatMap</span> (\t <span class="ot">-&gt;</span> <span class="kw">if</span> t<span class="op">==</span><span class="ch">&#39;/&#39;</span> <span class="kw">then</span> urlEncode <span class="st">&quot;/&quot;</span> <span class="kw">else</span> [t]) <span class="op">$</span> (<span class="st">&quot;/&quot;</span> <span class="op">++</span> (replace <span class="st">&quot;.page&quot;</span> <span class="st">&quot;.html&quot;</span> p)))) <span class="op">.</span> pathField) <span class="st">&quot;escapedURL&quot;</span> <span class="co">-- for use with backlinks ie &#39;href=&quot;/metadata/annotations/backlinks/$escapedURL$&quot;&#39;, so &#39;Bitcoin-is-Worse-is-Better.page&#39; → &#39;/metadata/annotations/backlinks/%2FBitcoin-is-Worse-is-Better.html&#39;, &#39;notes/Faster.page&#39; → &#39;/metadata/annotations/backlinks/%2Fnotes%2FFaster.html&#39;</span></span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a><span class="ot">escapedTitleField ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Context</span> a</span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a>escapedTitleField t <span class="ot">=</span> (mapContext (<span class="fu">map</span> <span class="fu">toLower</span> <span class="op">.</span> replace <span class="st">&quot;/&quot;</span> <span class="st">&quot;-&quot;</span> <span class="op">.</span> replace <span class="st">&quot;.page&quot;</span> <span class="st">&quot;&quot;</span>) <span class="op">.</span> pathField) t</span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a><span class="ot">descField ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Context</span> a</span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a>descField d <span class="ot">=</span> field d <span class="op">$</span> \item <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>                  metadata <span class="ot">&lt;-</span> getMetadata (itemIdentifier item)</span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>                  <span class="kw">let</span> descMaybe <span class="ot">=</span> lookupString d metadata</span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>                  <span class="kw">case</span> descMaybe <span class="kw">of</span></span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> noResult <span class="st">&quot;no description field&quot;</span></span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Just</span> desc <span class="ot">-&gt;</span></span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>                     <span class="kw">let</span> cleanedDesc <span class="ot">=</span> runPure <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a>                              pandocDesc <span class="ot">&lt;-</span> readMarkdown def{readerExtensions<span class="ot">=</span>pandocExtensions} (T.pack desc)</span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>                              htmlDesc <span class="ot">&lt;-</span> writeHtml5String def pandocDesc</span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">return</span> <span class="op">$</span> T.unpack htmlDesc</span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>                      <span class="kw">in</span> <span class="kw">case</span> cleanedDesc <span class="kw">of</span></span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>                         <span class="dt">Left</span> _          <span class="ot">-&gt;</span> noResult <span class="st">&quot;no description field&quot;</span></span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>                         <span class="dt">Right</span> finalDesc <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="fu">reverse</span> <span class="op">$</span> <span class="fu">drop</span> <span class="dv">4</span> <span class="op">$</span> <span class="fu">reverse</span> <span class="op">$</span> <span class="fu">drop</span> <span class="dv">3</span> finalDesc <span class="co">-- strip &lt;p&gt;&lt;/p&gt;</span></span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a><span class="ot">pandocTransform ::</span> <span class="dt">Metadata</span> <span class="ot">-&gt;</span> <span class="dt">ArchiveMetadata</span> <span class="ot">-&gt;</span> <span class="dt">Pandoc</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Pandoc</span></span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a>pandocTransform md adb p <span class="ot">=</span></span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>                           <span class="kw">do</span> <span class="kw">let</span> pw <span class="ot">=</span> walk linkAuto <span class="op">$</span> walk (marginNotes <span class="op">.</span> convertInterwikiLinks) p</span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a>                              _ <span class="ot">&lt;-</span> createAnnotations md pw</span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>                              <span class="kw">let</span> pb <span class="ot">=</span> walk (hasAnnotation md <span class="dt">True</span>) pw</span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a>                              <span class="kw">let</span> pbt <span class="ot">=</span> typographyTransform <span class="op">.</span> walk (<span class="fu">map</span> (nominalToRealInflationAdjuster <span class="op">.</span> addAmazonAffiliate)) <span class="op">$</span> pb</span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>                              <span class="kw">let</span> pbth <span class="ot">=</span> isLocalLink <span class="op">$</span> walk headerSelflink pbt</span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a>                              walkM (\x <span class="ot">-&gt;</span> localizeLink adb x <span class="op">&gt;&gt;=</span> imageSrcset <span class="op">&gt;&gt;=</span> invertImageInline) pbth</span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a><span class="co">-- Example: Image (&quot;&quot;,[&quot;full-width&quot;],[]) [Str &quot;...&quot;] (&quot;/images/gan/thiswaifudoesnotexist.png&quot;,&quot;fig:&quot;)</span></span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a><span class="co">-- type Text.Pandoc.Definition.Attr = (T.Text, [T.Text], [(T.Text, T.Text)])</span></span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a><span class="co">-- </span><span class="al">WARNING</span><span class="co">: image hotlinking is a bad practice: hotlinks will often break, sometimes just because of hotlinking. We assume that all images are locally hosted! Woe betide the cheapskate parasite who fails to heed this.</span></span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a><span class="ot">imageSrcset ::</span> <span class="dt">Inline</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Inline</span></span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a>imageSrcset x<span class="op">@</span>(<span class="dt">Image</span> (c, t, pairs) inlines (target, title)) <span class="ot">=</span></span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a>  <span class="kw">do</span> <span class="kw">let</span> ext <span class="ot">=</span> takeExtension <span class="op">$</span> T.unpack target</span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a>     <span class="kw">let</span> target&#39; <span class="ot">=</span> replace <span class="st">&quot;%2F&quot;</span> <span class="st">&quot;/&quot;</span> <span class="op">$</span> T.unpack target</span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a>     (_,w) <span class="ot">&lt;-</span> imageMagickDimensions <span class="op">$</span> <span class="fu">tail</span> target&#39;</span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a>     <span class="kw">if</span> (<span class="fu">read</span><span class="ot"> w ::</span> <span class="dt">Int</span>) <span class="op">&lt;=</span> <span class="dv">768</span> <span class="kw">then</span> <span class="fu">return</span> x <span class="kw">else</span> <span class="kw">do</span></span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a>         <span class="kw">let</span> smallerPath <span class="ot">=</span> (<span class="fu">tail</span> target&#39;)<span class="op">++</span><span class="st">&quot;-768px&quot;</span><span class="op">++</span>ext</span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a>         notExist <span class="ot">&lt;-</span> <span class="fu">fmap</span> <span class="fu">not</span> <span class="op">$</span> doesFileExist smallerPath</span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a>         when notExist <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a>           (status,_,bs) <span class="ot">&lt;-</span>  runShellCommand <span class="st">&quot;./&quot;</span> <span class="dt">Nothing</span> <span class="st">&quot;convert&quot;</span> [<span class="fu">tail</span> target&#39;, <span class="st">&quot;-resize&quot;</span>, <span class="st">&quot;768x768&quot;</span>, smallerPath]</span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a>           <span class="kw">case</span> status <span class="kw">of</span></span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a>             <span class="dt">ExitFailure</span> _ <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="op">$</span> <span class="fu">show</span> status <span class="op">++</span> <span class="fu">show</span> bs</span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a>             _ <span class="ot">-&gt;</span> <span class="kw">do</span> <span class="kw">if</span> ext <span class="op">==</span> <span class="st">&quot;.png&quot;</span> <span class="kw">then</span> <span class="co">-- lossily optimize using my pngnq/mozjpeg scripts:</span></span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a>                         void <span class="op">$</span> runShellCommand <span class="st">&quot;./&quot;</span> <span class="dt">Nothing</span> <span class="st">&quot;compresspng&quot;</span> [smallerPath]</span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a>                       <span class="kw">else</span></span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a>                         void <span class="op">$</span> runShellCommand <span class="st">&quot;./&quot;</span> <span class="dt">Nothing</span> <span class="st">&quot;compressjpg&quot;</span> [smallerPath]</span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true" tabindex="-1"></a>                     void <span class="op">$</span> <span class="fu">print</span> (<span class="st">&quot;Created smaller image: &quot;</span> <span class="op">++</span> smallerPath)</span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true" tabindex="-1"></a>         <span class="kw">let</span> srcset <span class="ot">=</span> T.pack (<span class="st">&quot;/&quot;</span><span class="op">++</span>smallerPath<span class="op">++</span><span class="st">&quot; 768w, &quot;</span> <span class="op">++</span> target&#39;<span class="op">++</span><span class="st">&quot; &quot;</span><span class="op">++</span>w<span class="op">++</span><span class="st">&quot;w&quot;</span>)</span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span> <span class="op">$</span> <span class="dt">Image</span> (c, t, pairs<span class="op">++</span>[(<span class="st">&quot;srcset&quot;</span>, srcset), (<span class="st">&quot;sizes&quot;</span>, T.pack (<span class="st">&quot;(max-width: 768px) 100vw, &quot;</span><span class="op">++</span>w<span class="op">++</span><span class="st">&quot;px&quot;</span>))])</span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a>                        inlines (target, title)</span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a><span class="co">-- For Links to images rather than regular Images, which are not displayed (but left for the user to hover over or click-through), we still get their height/width but inline it as data-* attributes for popups.js to avoid having to reflow as the page loads. (A minor point, to be sure, but it&#39;s nicer when everything is laid out correctly from the start &amp; doesn&#39;t reflow.)</span></span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a>imageSrcset x<span class="op">@</span>(<span class="dt">Link</span> (htmlid, classes, kvs) xs (p,t)) <span class="ot">=</span> <span class="kw">if</span> (<span class="st">&quot;.png&quot;</span> <span class="ot">`T.isSuffixOf`</span> p <span class="op">||</span> <span class="st">&quot;.jpg&quot;</span> <span class="ot">`T.isSuffixOf`</span> p) <span class="op">&amp;&amp;</span></span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a>                                                          (<span class="st">&quot;https://www.gwern.net/&quot;</span> <span class="ot">`T.isPrefixOf`</span> p <span class="op">||</span> <span class="st">&quot;/&quot;</span> <span class="ot">`T.isPrefixOf`</span> p) <span class="kw">then</span></span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a>                                                         <span class="kw">do</span> (h,w) <span class="ot">&lt;-</span> imageMagickDimensions <span class="op">$</span> T.unpack p</span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a>                                                            <span class="fu">return</span> (<span class="dt">Link</span> (htmlid, classes,</span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a>                                                                            kvs<span class="op">++</span>[(<span class="st">&quot;image-height&quot;</span>,(T.pack h)),(<span class="st">&quot;image-width&quot;</span>,(T.pack w))])</span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a>                                                                      xs (p,t))</span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a>                                                       <span class="kw">else</span> <span class="fu">return</span> x</span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a>imageSrcset x <span class="ot">=</span> <span class="fu">return</span> x</span>
<span id="cb1-288"><a href="#cb1-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-289"><a href="#cb1-289" aria-hidden="true" tabindex="-1"></a><span class="co">-- For Amazon links, there are two scenarios: there are parameters (denoted by a</span></span>
<span id="cb1-290"><a href="#cb1-290" aria-hidden="true" tabindex="-1"></a><span class="co">-- &#39;?&#39; in the URL), or there are not. In the former, we need to append the tag as</span></span>
<span id="cb1-291"><a href="#cb1-291" aria-hidden="true" tabindex="-1"></a><span class="co">-- another item (&#39;&amp;tag=&#39;), while in the latter, we need to set up our own</span></span>
<span id="cb1-292"><a href="#cb1-292" aria-hidden="true" tabindex="-1"></a><span class="co">-- parameter (&#39;?tag=&#39;). The transform may be run many times since</span></span>
<span id="cb1-293"><a href="#cb1-293" aria-hidden="true" tabindex="-1"></a><span class="co">-- they are supposed to be pure, so we</span></span>
<span id="cb1-294"><a href="#cb1-294" aria-hidden="true" tabindex="-1"></a><span class="co">-- need to also check a tag hasn&#39;t already been appended.</span></span>
<span id="cb1-295"><a href="#cb1-295" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-296"><a href="#cb1-296" aria-hidden="true" tabindex="-1"></a><span class="co">-- For non-Amazon links, we just return them unchanged.</span></span>
<span id="cb1-297"><a href="#cb1-297" aria-hidden="true" tabindex="-1"></a><span class="ot">addAmazonAffiliate ::</span> <span class="dt">Inline</span> <span class="ot">-&gt;</span> <span class="dt">Inline</span></span>
<span id="cb1-298"><a href="#cb1-298" aria-hidden="true" tabindex="-1"></a>addAmazonAffiliate x<span class="op">@</span>(<span class="dt">Link</span> attr r (l, t)) <span class="ot">=</span> <span class="kw">if</span> ((<span class="st">&quot;www.amazon.com/&quot;</span> <span class="ot">`T.isInfixOf`</span> l) <span class="op">&amp;&amp;</span> <span class="fu">not</span> (<span class="st">&quot;tag=gwernnet-20&quot;</span> <span class="ot">`T.isInfixOf`</span> l)) <span class="kw">then</span></span>
<span id="cb1-299"><a href="#cb1-299" aria-hidden="true" tabindex="-1"></a>                                        <span class="kw">if</span> (<span class="st">&quot;?&quot;</span> <span class="ot">`T.isInfixOf`</span> l) <span class="kw">then</span> <span class="dt">Link</span> attr r (l <span class="ot">`T.append`</span> <span class="st">&quot;&amp;tag=gwernnet-20&quot;</span>, t) <span class="kw">else</span> <span class="dt">Link</span> attr r (l <span class="ot">`T.append`</span> <span class="st">&quot;?tag=gwernnet-20&quot;</span>, t)</span>
<span id="cb1-300"><a href="#cb1-300" aria-hidden="true" tabindex="-1"></a>                                       <span class="kw">else</span> x</span>
<span id="cb1-301"><a href="#cb1-301" aria-hidden="true" tabindex="-1"></a>addAmazonAffiliate x <span class="ot">=</span> x</span>
<span id="cb1-302"><a href="#cb1-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-303"><a href="#cb1-303" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Make headers into links to themselves, so they can be clicked on or copy-pasted easily.</span></span>
<span id="cb1-304"><a href="#cb1-304" aria-hidden="true" tabindex="-1"></a><span class="ot">headerSelflink ::</span> <span class="dt">Block</span> <span class="ot">-&gt;</span> <span class="dt">Block</span></span>
<span id="cb1-305"><a href="#cb1-305" aria-hidden="true" tabindex="-1"></a>headerSelflink (<span class="dt">Header</span> a (href,b,c) d) <span class="ot">=</span> <span class="dt">Header</span> a (href,b,c) [<span class="dt">Link</span> nullAttr d (<span class="st">&quot;#&quot;</span><span class="ot">`T.append`</span>href, <span class="st">&quot;Link to section: § &#39;&quot;</span><span class="ot">`T.append`</span>inlinesToString(d)<span class="ot">`T.append`</span><span class="st">&quot;&#39;&quot;</span>)]</span>
<span id="cb1-306"><a href="#cb1-306" aria-hidden="true" tabindex="-1"></a>headerSelflink x <span class="ot">=</span> x</span>
<span id="cb1-307"><a href="#cb1-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-308"><a href="#cb1-308" aria-hidden="true" tabindex="-1"></a><span class="co">-- FASTER HTML RENDERING BY STATICLY SPECIFYING ALL IMAGE DIMENSIONS</span></span>
<span id="cb1-309"><a href="#cb1-309" aria-hidden="true" tabindex="-1"></a><span class="co">-- read HTML string with TagSoup, process `&lt;img&gt;` tags to read the file&#39;s dimensions, and hardwire them;</span></span>
<span id="cb1-310"><a href="#cb1-310" aria-hidden="true" tabindex="-1"></a><span class="co">-- this optimizes HTML rendering since browsers know before downloading the image how to layout the page.</span></span>
<span id="cb1-311"><a href="#cb1-311" aria-hidden="true" tabindex="-1"></a><span class="co">-- Further, specify &#39;lazy-loading&#39; for all images: the lazy attribute was introduced by Chrome 76 ~August 2019, and adopted by Firefox 75 ~February 2020 (https://bugzilla.mozilla.org/show_bug.cgi?id=1542784), standardized as https://html.spec.whatwg.org/multipage/urls-and-fetching.html#lazy-loading-attributes with &gt;63% global availability + backwards compatibility (https://www.caniuse.com/#feat=loading-lazy-attr https://github.com/whatwg/html/pull/3752  https://web.dev/native-lazy-loading/).</span></span>
<span id="cb1-312"><a href="#cb1-312" aria-hidden="true" tabindex="-1"></a><span class="co">-- Pandoc feature request to push the lazy loading upstream: https://github.com/jgm/pandoc/issues/6197</span></span>
<span id="cb1-313"><a href="#cb1-313" aria-hidden="true" tabindex="-1"></a><span class="ot">addImgDimensions ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">String</span></span>
<span id="cb1-314"><a href="#cb1-314" aria-hidden="true" tabindex="-1"></a>addImgDimensions <span class="ot">=</span> <span class="fu">fmap</span> (renderTagsOptions renderOptions{optMinimize<span class="ot">=</span>whitelist, optRawTag <span class="ot">=</span> (<span class="ot">`elem`</span> [<span class="st">&quot;script&quot;</span>, <span class="st">&quot;style&quot;</span>]) <span class="op">.</span> <span class="fu">map</span> <span class="fu">toLower</span>}) <span class="op">.</span> <span class="fu">mapM</span> staticImg <span class="op">.</span> parseTags</span>
<span id="cb1-315"><a href="#cb1-315" aria-hidden="true" tabindex="-1"></a>                 <span class="kw">where</span> whitelist s <span class="ot">=</span> s <span class="op">/=</span> <span class="st">&quot;div&quot;</span> <span class="op">&amp;&amp;</span> s <span class="op">/=</span> <span class="st">&quot;script&quot;</span> <span class="op">&amp;&amp;</span> s <span class="op">/=</span> <span class="st">&quot;style&quot;</span></span>
<span id="cb1-316"><a href="#cb1-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-317"><a href="#cb1-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-318"><a href="#cb1-318" aria-hidden="true" tabindex="-1"></a><span class="co">{- example illustration:</span></span>
<span id="cb1-319"><a href="#cb1-319" aria-hidden="true" tabindex="-1"></a><span class="co"> TagOpen &quot;img&quot; [(&quot;src&quot;,&quot;/images/traffic/201201-201207-traffic-history.png&quot;)</span></span>
<span id="cb1-320"><a href="#cb1-320" aria-hidden="true" tabindex="-1"></a><span class="co">                (&quot;alt&quot;,&quot;Plot of page-hits (y-axis) versus date (x-axis)&quot;)],</span></span>
<span id="cb1-321"><a href="#cb1-321" aria-hidden="true" tabindex="-1"></a><span class="co"> TagOpen &quot;figcaption&quot; [],TagText &quot;Plot of page-hits (y-axis) versus date (x-axis)&quot;,</span></span>
<span id="cb1-322"><a href="#cb1-322" aria-hidden="true" tabindex="-1"></a><span class="co"> TagClose &quot;figcaption&quot;,TagText &quot;\n&quot;,TagClose &quot;figure&quot; -}</span></span>
<span id="cb1-323"><a href="#cb1-323" aria-hidden="true" tabindex="-1"></a><span class="ot">staticImg ::</span> <span class="dt">Tag</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Tag</span> <span class="dt">String</span>)</span>
<span id="cb1-324"><a href="#cb1-324" aria-hidden="true" tabindex="-1"></a>staticImg x<span class="op">@</span>(<span class="dt">TagOpen</span> <span class="st">&quot;img&quot;</span> xs) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-325"><a href="#cb1-325" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> h <span class="ot">=</span> <span class="fu">lookup</span> <span class="st">&quot;height&quot;</span> xs</span>
<span id="cb1-326"><a href="#cb1-326" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> w <span class="ot">=</span> <span class="fu">lookup</span> <span class="st">&quot;width&quot;</span> xs</span>
<span id="cb1-327"><a href="#cb1-327" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> lazy <span class="ot">=</span> <span class="fu">lookup</span> <span class="st">&quot;loading&quot;</span> xs</span>
<span id="cb1-328"><a href="#cb1-328" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> <span class="dt">Just</span> p <span class="ot">=</span> <span class="fu">lookup</span> <span class="st">&quot;src&quot;</span> xs</span>
<span id="cb1-329"><a href="#cb1-329" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> (isNothing h <span class="op">||</span> isNothing w <span class="op">||</span> isNothing lazy) <span class="op">&amp;&amp;</span></span>
<span id="cb1-330"><a href="#cb1-330" aria-hidden="true" tabindex="-1"></a>     <span class="fu">not</span> (<span class="st">&quot;//&quot;</span> <span class="ot">`isPrefixOf`</span> p <span class="op">||</span> <span class="st">&quot;http&quot;</span> <span class="ot">`isPrefixOf`</span> p) <span class="op">&amp;&amp;</span></span>
<span id="cb1-331"><a href="#cb1-331" aria-hidden="true" tabindex="-1"></a>     (<span class="st">&quot;/&quot;</span> <span class="ot">`isPrefixOf`</span> p <span class="op">&amp;&amp;</span> <span class="fu">not</span> (<span class="st">&quot;data:image/&quot;</span> <span class="ot">`isPrefixOf`</span> p)) <span class="kw">then</span></span>
<span id="cb1-332"><a href="#cb1-332" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> (takeExtension p <span class="op">==</span> <span class="st">&quot;.svg&quot;</span>) <span class="kw">then</span></span>
<span id="cb1-333"><a href="#cb1-333" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- for SVGs, only set the lazy-loading attribute, since height/width is not necessarily meaningful for vector graphics</span></span>
<span id="cb1-334"><a href="#cb1-334" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span> (<span class="dt">TagOpen</span> <span class="st">&quot;img&quot;</span> (uniq ([(<span class="st">&quot;loading&quot;</span>, <span class="st">&quot;lazy&quot;</span>)]<span class="op">++</span>xs)))</span>
<span id="cb1-335"><a href="#cb1-335" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span></span>
<span id="cb1-336"><a href="#cb1-336" aria-hidden="true" tabindex="-1"></a>       <span class="kw">do</span></span>
<span id="cb1-337"><a href="#cb1-337" aria-hidden="true" tabindex="-1"></a>         <span class="kw">let</span> p&#39; <span class="ot">=</span> urlDecode <span class="op">$</span> <span class="kw">if</span> <span class="fu">head</span> p <span class="op">==</span> <span class="ch">&#39;/&#39;</span> <span class="kw">then</span> <span class="fu">tail</span> p <span class="kw">else</span> p</span>
<span id="cb1-338"><a href="#cb1-338" aria-hidden="true" tabindex="-1"></a>         (height,width) <span class="ot">&lt;-</span> imageMagickDimensions p&#39; <span class="ot">`onException`</span> (<span class="fu">putStrLn</span> p)</span>
<span id="cb1-339"><a href="#cb1-339" aria-hidden="true" tabindex="-1"></a>         <span class="co">-- body max-width is 1600 px, sidebar is 150px, so any image wider than ~1400px</span></span>
<span id="cb1-340"><a href="#cb1-340" aria-hidden="true" tabindex="-1"></a>         <span class="co">-- will wind up being reflowed by the &#39;img { max-width: 100%; }&#39; responsive-image CSS declaration;</span></span>
<span id="cb1-341"><a href="#cb1-341" aria-hidden="true" tabindex="-1"></a>         <span class="co">-- let&#39;s avoid that specific case by lying about its width, although this doesn&#39;t fix all the reflowing.</span></span>
<span id="cb1-342"><a href="#cb1-342" aria-hidden="true" tabindex="-1"></a>         <span class="co">-- No images should be more than a screen in height either, so we&#39;ll set a maximum of 1400</span></span>
<span id="cb1-343"><a href="#cb1-343" aria-hidden="true" tabindex="-1"></a>         <span class="kw">let</span> width&#39; <span class="ot">=</span>  <span class="fu">show</span> ((<span class="fu">read</span><span class="ot"> width::</span><span class="dt">Int</span>) <span class="ot">`min`</span> <span class="dv">1400</span>)</span>
<span id="cb1-344"><a href="#cb1-344" aria-hidden="true" tabindex="-1"></a>         <span class="kw">let</span> height&#39; <span class="ot">=</span> <span class="fu">show</span> ((<span class="fu">read</span><span class="ot"> height::</span><span class="dt">Int</span>) <span class="ot">`min`</span> <span class="dv">1400</span>)</span>
<span id="cb1-345"><a href="#cb1-345" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span> (<span class="dt">TagOpen</span> <span class="st">&quot;img&quot;</span> (uniq ([(<span class="st">&quot;loading&quot;</span>, <span class="st">&quot;lazy&quot;</span>), <span class="co">-- lazy load &amp; async render all images</span></span>
<span id="cb1-346"><a href="#cb1-346" aria-hidden="true" tabindex="-1"></a>                                        (<span class="st">&quot;decoding&quot;</span>, <span class="st">&quot;async&quot;</span>),</span>
<span id="cb1-347"><a href="#cb1-347" aria-hidden="true" tabindex="-1"></a>                                        (<span class="st">&quot;height&quot;</span>, height&#39;), (<span class="st">&quot;width&quot;</span>, width&#39;)]<span class="op">++</span>xs)))</span>
<span id="cb1-348"><a href="#cb1-348" aria-hidden="true" tabindex="-1"></a>      <span class="kw">else</span> <span class="fu">return</span> x</span>
<span id="cb1-349"><a href="#cb1-349" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> uniq <span class="ot">=</span> nubBy (\a b <span class="ot">-&gt;</span> <span class="fu">fst</span> a <span class="op">==</span> <span class="fu">fst</span> b) <span class="op">.</span> <span class="fu">sort</span></span>
<span id="cb1-350"><a href="#cb1-350" aria-hidden="true" tabindex="-1"></a>staticImg x <span class="ot">=</span> <span class="fu">return</span> x</span>
<span id="cb1-351"><a href="#cb1-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-352"><a href="#cb1-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-353"><a href="#cb1-353" aria-hidden="true" tabindex="-1"></a><span class="co">-- https://edwardtufte.github.io/tufte-css/#sidenotes</span></span>
<span id="cb1-354"><a href="#cb1-354" aria-hidden="true" tabindex="-1"></a><span class="co">-- support Tufte-CSS-style margin notes with a syntax like</span></span>
<span id="cb1-355"><a href="#cb1-355" aria-hidden="true" tabindex="-1"></a><span class="co">-- &#39;Foo bar.^[!Margin: Short explanation.] Baz quux burble...&#39;</span></span>
<span id="cb1-356"><a href="#cb1-356" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-357"><a href="#cb1-357" aria-hidden="true" tabindex="-1"></a><span class="co">-- &gt; marginNotes (Note [Para [Str &quot;!Margin:&quot;, Space, Str &quot;Test.&quot;]])</span></span>
<span id="cb1-358"><a href="#cb1-358" aria-hidden="true" tabindex="-1"></a><span class="co">-- → Span (&quot;&quot;,[&quot;marginnote&quot;],[]) [Para [Space, Str &quot;Test.&quot;]]</span></span>
<span id="cb1-359"><a href="#cb1-359" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-360"><a href="#cb1-360" aria-hidden="true" tabindex="-1"></a><span class="co">-- This sets a &#39;marginnote&#39; HTML class on the footnote anchor. `sidenotes.js` specially supports these and renders them differently, removing the numerals. We strip the &#39;Note&#39; because otherwise it will get a number despite being hidden, and that&#39;s confusing.</span></span>
<span id="cb1-361"><a href="#cb1-361" aria-hidden="true" tabindex="-1"></a><span class="co">-- Margin notes can be used for general comments on a region of text which aren&#39;t intended to refer to a specific word or sentence, and avoiding spurious precision makes it a little easier for the reader.</span></span>
<span id="cb1-362"><a href="#cb1-362" aria-hidden="true" tabindex="-1"></a><span class="co">-- I intend to experiment with them as a way to summarize paragraphs in a short sentence, somewhat like http://www.pgbovine.net/PhD-memoir/pguo-PhD-grind.pdf or how https://ebooks.adelaide.edu.au/c/coleridge/samuel_taylor/rime/#part1 glosses each section of verse, which can be a little tricky to follow.</span></span>
<span id="cb1-363"><a href="#cb1-363" aria-hidden="true" tabindex="-1"></a><span class="ot">marginNotes ::</span> <span class="dt">Inline</span> <span class="ot">-&gt;</span> <span class="dt">Inline</span></span>
<span id="cb1-364"><a href="#cb1-364" aria-hidden="true" tabindex="-1"></a>marginNotes x<span class="op">@</span>(<span class="dt">Note</span> (bs<span class="op">:</span>cs)) <span class="ot">=</span></span>
<span id="cb1-365"><a href="#cb1-365" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> bs <span class="kw">of</span></span>
<span id="cb1-366"><a href="#cb1-366" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Para</span> ((<span class="dt">Str</span> m)<span class="op">:</span>ms) <span class="ot">-&gt;</span> <span class="kw">if</span> <span class="fu">not</span> (<span class="st">&quot;!Margin:&quot;</span> <span class="op">==</span> m) <span class="kw">then</span> x <span class="kw">else</span></span>
<span id="cb1-367"><a href="#cb1-367" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">Span</span> (<span class="st">&quot;&quot;</span>, [<span class="st">&quot;marginnote&quot;</span>], []) (blocksToInlines <span class="op">$</span> (<span class="dt">Para</span> ms)<span class="op">:</span>cs)</span>
<span id="cb1-368"><a href="#cb1-368" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">-&gt;</span> x</span>
<span id="cb1-369"><a href="#cb1-369" aria-hidden="true" tabindex="-1"></a>marginNotes x <span class="ot">=</span> x</span></code></pre></div>
