<div class="sourceCode" id="cb1"><pre class="sourceCode Bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Sync:</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">bold ()</span> <span class="kw">{</span> <span class="bu">echo</span> <span class="at">-e</span> <span class="st">&quot;\033[1m</span><span class="va">$@</span><span class="st">\033[0m&quot;</span><span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">## sync to Hetzner server: (`--size-only` because Hakyll rebuilds mean that timestamps will always be different, forcing a slower rsync)</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">## If any links are symbolic links (such as to make the build smaller/faster), we make rsync follow the symbolic link (as if it were a hard link) and copy the file using `--copy-links`.</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">## </span><span class="al">NOTE</span><span class="co">: we skip time/size syncs because sometimes the infrastructure changes values but not file size, and it&#39;s confusing when JS/CSS doesn&#39;t get updated; since the infrastructure is so small (compared to eg docs/*), just force a hash-based sync every time:</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="ex">bold</span> <span class="st">&quot;Syncing static/…&quot;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">rsync</span> <span class="at">--exclude</span><span class="op">=</span><span class="st">&quot;.*&quot;</span> <span class="at">--chmod</span><span class="op">=</span><span class="st">&#39;a+r&#39;</span> <span class="at">--recursive</span> <span class="at">--checksum</span> <span class="at">--copy-links</span> <span class="at">--verbose</span> <span class="at">--itemize-changes</span> <span class="at">--stats</span> ./static/ root@149.248.6.135:<span class="st">&quot;/home/thursday/www/wiki/static&quot;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">## Likewise, force checks of the Markdown pages but skip symlinks (ie non-generated files):</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="ex">bold</span> <span class="st">&quot;Syncing pages…&quot;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">rsync</span> <span class="at">--exclude</span><span class="op">=</span><span class="st">&quot;.*&quot;</span> <span class="at">--chmod</span><span class="op">=</span><span class="st">&#39;a+r&#39;</span> <span class="at">--recursive</span> <span class="at">--checksum</span> <span class="at">--quiet</span> <span class="at">--info</span><span class="op">=</span>skip0 ./_site/  root@149.248.6.135:<span class="st">&quot;/home/thursday/www/wiki/&quot;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">## Randomize sync type—usually, fast, but occasionally do a regular slow hash-based rsync which deletes old files:</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="ex">bold</span> <span class="st">&quot;Syncing everything else…&quot;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="va">SPEED</span><span class="op">=</span><span class="st">&quot;&quot;</span><span class="kw">;</span> <span class="cf">if</span> <span class="kw">((</span><span class="va">RANDOM</span> <span class="op">%</span> <span class="dv">100</span> <span class="op">&lt;</span> <span class="dv">99</span><span class="kw">));</span> <span class="cf">then</span> <span class="va">SPEED</span><span class="op">=</span><span class="st">&quot;--size-only&quot;</span><span class="kw">;</span> <span class="cf">else</span> <span class="va">SPEED</span><span class="op">=</span><span class="st">&quot;--delete --checksum&quot;</span><span class="kw">;</span> <span class="cf">fi</span><span class="kw">;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">rsync</span> <span class="at">--exclude</span><span class="op">=</span><span class="st">&quot;.*&quot;</span> <span class="at">--chmod</span><span class="op">=</span><span class="st">&#39;a+r&#39;</span> <span class="at">--recursive</span> <span class="va">$SPEED</span> <span class="at">--copy-links</span> <span class="at">--verbose</span> <span class="at">--itemize-changes</span> <span class="at">--stats</span> ./_site/  root@149.248.6.135:<span class="st">&quot;/home/thursday/www/wiki/&quot;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> +e</span></code></pre></div>
