<div class="sourceCode" id="cb1"><pre class="sourceCode Haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Interwiki</span> (convertInterwikiLinks, inlinesToString) <span class="kw">where</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">M</span> (fromList, lookup, <span class="dt">Map</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.Pandoc</span> (<span class="dt">Inline</span>(..))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span> (append, concat, head, tail, take, toUpper, pack, unpack, <span class="dt">Text</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.List.Utils</span> (replace)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.HTTP</span> (urlEncode)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- INTERWIKI PLUGIN</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- This is a simplification of the original interwiki plugin I wrote for Gitit: &lt;https://github.com/jgm/gitit/blob/master/plugins/Interwiki.hs&gt;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- It&#39;s more or less the same thing, but the interwiki mapping is cut down to only the ones I use, and it avoids a dependency on Gitit.</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Convert a list of inlines into a string.</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="ot">inlinesToString ::</span> [<span class="dt">Inline</span>] <span class="ot">-&gt;</span> <span class="dt">T.Text</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>inlinesToString <span class="ot">=</span> T.concat <span class="op">.</span> <span class="fu">map</span> go</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> go x <span class="ot">=</span> <span class="kw">case</span> x <span class="kw">of</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>               <span class="co">-- reached the literal T.Text:</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>               <span class="dt">Str</span> s    <span class="ot">-&gt;</span> s</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>               <span class="co">-- strip &amp; recurse on the [Inline]:</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>               <span class="dt">Emph</span>        x&#39; <span class="ot">-&gt;</span> inlinesToString x&#39;</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>               <span class="dt">Underline</span>   x&#39; <span class="ot">-&gt;</span> inlinesToString x&#39;</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>               <span class="dt">Strong</span>      x&#39; <span class="ot">-&gt;</span> inlinesToString x&#39;</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>               <span class="dt">Strikeout</span>   x&#39; <span class="ot">-&gt;</span> inlinesToString x&#39;</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>               <span class="dt">Superscript</span> x&#39; <span class="ot">-&gt;</span> inlinesToString x&#39;</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>               <span class="dt">Subscript</span>   x&#39; <span class="ot">-&gt;</span> inlinesToString x&#39;</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>               <span class="dt">SmallCaps</span>   x&#39; <span class="ot">-&gt;</span> inlinesToString x&#39;</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>               <span class="co">-- throw away attributes and recurse on the [Inline]:</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>               <span class="dt">Span</span> _      x&#39; <span class="ot">-&gt;</span> inlinesToString x&#39; <span class="co">-- eg [foo]{.smallcaps} -&gt; foo</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>               <span class="dt">Quoted</span> _    x&#39; <span class="ot">-&gt;</span> inlinesToString x&#39;</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>               <span class="dt">Cite</span> _      x&#39; <span class="ot">-&gt;</span> inlinesToString x&#39;</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>               <span class="dt">Link</span> _   x&#39; _  <span class="ot">-&gt;</span> inlinesToString x&#39;</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>               <span class="dt">Image</span> _  x&#39; _  <span class="ot">-&gt;</span> inlinesToString x&#39;</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>               <span class="co">-- throw away attributes, return the literal T.Text:</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>               <span class="dt">Math</span> _      x&#39; <span class="ot">-&gt;</span> x&#39;</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>               <span class="dt">RawInline</span> _ x&#39; <span class="ot">-&gt;</span> x&#39;</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>               <span class="dt">Code</span> _      x&#39; <span class="ot">-&gt;</span> x&#39;</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>               <span class="co">-- fall through with a blank:</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>               _        <span class="ot">-&gt;</span> <span class="st">&quot; &quot;</span><span class="ot">::</span><span class="dt">T.Text</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="ot">convertInterwikiLinks ::</span> <span class="dt">Inline</span> <span class="ot">-&gt;</span> <span class="dt">Inline</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>convertInterwikiLinks x<span class="op">@</span>(<span class="dt">Link</span> attr<span class="op">@</span>(ident, classes, kvs) ref (interwiki, article)) <span class="ot">=</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> T.head interwiki <span class="op">==</span> <span class="ch">&#39;!&#39;</span> <span class="kw">then</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">case</span> M.lookup (T.tail interwiki) interwikiMap <span class="kw">of</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>                <span class="dt">Just</span> url  <span class="ot">-&gt;</span> <span class="kw">case</span> article <span class="kw">of</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&quot;&quot;</span> <span class="ot">-&gt;</span> <span class="dt">Link</span> attr&#39; ref (url <span class="ot">`interwikiurl`</span> inlinesToString ref, <span class="st">&quot;&quot;</span>) <span class="co">-- tooltip is now handled by LinkMetadata.hs</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>                                  _  <span class="ot">-&gt;</span> <span class="dt">Link</span> attr&#39; ref (url <span class="ot">`interwikiurl`</span> article, <span class="st">&quot;&quot;</span>)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>                <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="op">$</span> <span class="st">&quot;Attempted to use an interwiki link with no defined interwiki: &quot;</span> <span class="op">++</span> <span class="fu">show</span> x</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="kw">else</span> x</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>            <span class="kw">where</span> <span class="co">-- &#39;https://starwars.wikia.com/wiki/Emperor_Palpatine&#39;</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>              <span class="co">--</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="ot">                  interwikiurl ::</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">T.Text</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>                  <span class="co">-- normalize links; MediaWiki requires first letter to be capitalized</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>                  interwikiurl u a <span class="ot">=</span> <span class="kw">let</span> a&#39; <span class="ot">=</span> <span class="kw">if</span> u<span class="op">==</span><span class="st">&quot;https://en.wikipedia.org/wiki/&quot;</span> <span class="kw">then</span> T.toUpper (T.take <span class="dv">1</span> a) <span class="ot">`T.append`</span> T.tail a <span class="kw">else</span> a <span class="kw">in</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>                                       u <span class="ot">`T.append`</span> T.pack (replace <span class="st">&quot;%20&quot;</span> <span class="st">&quot;_&quot;</span> <span class="op">$</span> replace <span class="st">&quot;%23&quot;</span> <span class="st">&quot;#&quot;</span> <span class="op">$</span> urlEncode (deunicode (T.unpack a&#39;)))</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="ot">                  deunicode ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>                  deunicode <span class="ot">=</span> <span class="fu">map</span> (\c <span class="ot">-&gt;</span> <span class="kw">if</span> c <span class="op">==</span> <span class="ch">&#39;’&#39;</span> <span class="kw">then</span> <span class="ch">&#39;\&#39;&#39;</span> <span class="kw">else</span> c)</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>                  attr&#39; <span class="ot">=</span> <span class="kw">if</span> <span class="st">&quot;docMetadata&quot;</span> <span class="ot">`elem`</span> classes <span class="kw">then</span> attr <span class="kw">else</span> (ident, <span class="st">&quot;docMetadata&quot;</span><span class="op">:</span>classes, kvs)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>convertInterwikiLinks x <span class="ot">=</span> x</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Large table of constants; this is a mapping from shortcuts to a URL. The URL can be used by</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="co">--   appending to it the article name (suitably URL-escaped, of course).</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="ot">interwikiMap ::</span> <span class="dt">M.Map</span> <span class="dt">T.Text</span> <span class="dt">T.Text</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>interwikiMap <span class="ot">=</span> M.fromList <span class="op">$</span> wpInterwikiMap <span class="op">++</span> customInterwikiMap</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>wpInterwikiMap,<span class="ot"> customInterwikiMap ::</span> [(<span class="dt">T.Text</span>, <span class="dt">T.Text</span>)]</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>customInterwikiMap <span class="ot">=</span> [(<span class="st">&quot;Hackage&quot;</span>, <span class="st">&quot;https://hackage.haskell.org/package/&quot;</span>),</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>                      (<span class="st">&quot;Hawiki&quot;</span>, <span class="st">&quot;https://haskell.org/haskellwiki/&quot;</span>),</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>                      (<span class="st">&quot;Hoogle&quot;</span>, <span class="st">&quot;https://www.haskell.org/hoogle/?hoogle=&quot;</span>),</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>                      <span class="co">-- shortcuts</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>                      (<span class="st">&quot;W&quot;</span>, <span class="st">&quot;https://en.wikipedia.org/wiki/&quot;</span>),</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>                      (<span class="st">&quot;WP&quot;</span>, <span class="st">&quot;https://en.wikipedia.org/wiki/&quot;</span>)]</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>wpInterwikiMap <span class="ot">=</span> [(<span class="st">&quot;Wikipedia&quot;</span>, <span class="st">&quot;https://en.wikipedia.org/wiki/&quot;</span>),</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>                  (<span class="st">&quot;Wikiquote&quot;</span>, <span class="st">&quot;https://en.wikiquote.org/wiki/&quot;</span>),</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>                  (<span class="st">&quot;Wiktionary&quot;</span>, <span class="st">&quot;https://en.wiktionary.org/wiki/&quot;</span>)]</span></code></pre></div>
