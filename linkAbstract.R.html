<div class="sourceCode" id="cb1"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env Rscript</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># LinkAbstracter</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Author: gwern</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Date: 2019-08-29</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># When:  Time-stamp: &quot;2021-04-29 15:26:41 gwern&quot;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># License: CC-0</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Read a PLOS or PMCID URL, and return the parsed fulltext as newline-delimited Title/Author/Date/DOI/Abstract.</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Pubmed Central example:</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># $ Rscript linkAbstract.R &quot;https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2793346/&quot;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># The physiological effects of Shinrin-yoku (taking in the forest atmosphere or forest bathing): evidence from field experiments in 24 forests across Japan</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Bum Jin Park, Yuko Tsunetsugu, Tamami Kasetani, Takahide Kagawa, Yoshifumi Miyazaki</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 2000-12-01</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 10.1007/s12199-009-0086-9</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># This paper reviews previous research on the physiological effects of Shinrin-yoku (taking in the forest atmosphere or forest bathing), and presents new results from field experiments conducted in 24 forests across Japan. The term Shinrin-yoku was coined by the Japanese Ministry of Agriculture, Forestry, and Fisheries in 1982, and can be defined as making contact with and taking in the atmosphere of the forest. In order to clarify the physiological effects of Shinrin-yoku, we conducted field experiments in 24 forests across Japan. In each experiment, 12 subjects (280 total; ages 21.7 ± 1.5 year) walked in and viewed a forest or city area. On the first day, six subjects were sent to a forest area, and the others to a city area. On the second day, each group was sent to the other area as a cross-check. Salivary cortisol, blood pressure, pulse rate, and heart rate variability were used as indices. These indices were measured in the morning at the accommodation facility before breakfast and also both before and after the walking (for 16 ± 5 min) and viewing (for 14 ± 2 min). The R–R interval was also measured during the walking and viewing periods. The results show that forest environments promote lower concentrations of cortisol, lower pulse rate, lower blood pressure, greater parasympathetic nerve activity, and lower sympathetic nerve activity than do city environments. These results will contribute to the development of a research field dedicated to forest medicine, which may be used as a strategy for preventive medicine.</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: Pubmed rate-limits the public API; to reduce the risk of being blacklisted, get an API key and set it in R with something lik `Sys.setenv(ENTREZ_KEY=&quot;fe7ca39604a5de176be4c2a1cbd2b2902108&quot;)`</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># PLOS example (</span><span class="al">NOTE</span><span class="co">: &#39; &#39; thin spaces are used in the formatting):</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># $ Rscript  linkAbstract.R &#39;http://www.plosone.org/article/info%3Adoi%2F10.1371%2Fjournal.pone.0100248&#39;</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Genetic Variation Associated with Differential Educational Attainment in Adults Has Anticipated Associations with School Performance in Children</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Mary E. Ward, George McMahon, Beate St Pourcain, David M. Evans, Cornelius A. Rietveld, Daniel J. Benjamin, Philipp D. Koellinger, David Cesarini, NA NA, George Davey Smith, Nicholas J. Timpson</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2014-05-22</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 10.1371/journal.pone.0100248</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt;abstract&gt;</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co">#   &lt;p&gt;Genome-wide association study results have yielded evidence for the association of common genetic variants with crude measures of completed educational attainment in adults. Whilst informative, these results do not inform as to the mechanism of these effects or their presence at earlier ages and where educational performance is more routinely and more precisely assessed. Single nucleotide polymorphisms exhibiting genome-wide significant associations with adult educational attainment were combined to derive an unweighted allele score in 5,979 and 6,145 young participants from the Avon Longitudinal Study of Parents and Children with key stage 3 national curriculum test results (SATS results) available at age 13 to 14 years in English and mathematics respectively. Standardised (z-scored) results for English and mathematics showed an expected relationship with sex, with girls exhibiting an advantage over boys in English (0.433 SD (95%CI 0.395, 0.470), p&amp;lt;10&lt;sup&gt;−10&lt;/sup&gt;) with more similar results (though in the opposite direction) in mathematics (0.042 SD (95%CI 0.004, 0.080), p = 0.030). Each additional adult educational attainment increasing allele was associated with 0.041 SD (95%CI 0.020, 0.063), p = 1.79×10&lt;sup&gt;−04&lt;/sup&gt; and 0.028 SD (95%CI 0.007, 0.050), p = 0.01 increases in standardised SATS score for English and mathematics respectively. Educational attainment is a complex multifactorial behavioural trait which has not had heritable contributions to it fully characterised. We were able to apply the results from a large study of adult educational attainment to a study of child exam performance marking events in the process of learning rather than realised adult end product. Our results support evidence for common, small genetic contributions to educational attainment, but also emphasise the likely lifecourse nature of this genetic effect. Results here also, by an alternative route, suggest that existing methods for child examination are able to recognise early life variation likely to be related to ultimate educational attainment.&lt;/p&gt;</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>args <span class="ot">=</span> <span class="fu">commandArgs</span>(<span class="at">trailingOnly=</span><span class="cn">TRUE</span>)[<span class="dv">1</span>]</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">&quot;plos&quot;</span>,args)) {</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>   <span class="co"># assume easy PLOS case:</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># handle cases like &#39;http://www.plosone.org/article/info%3Adoi%2F10.1371%2Fjournal.pone.0100248&#39; where the DOI is URL-encoded</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    url <span class="ot">&lt;-</span> <span class="fu">URLdecode</span>(args[<span class="dv">1</span>])</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extract DOI, handling any anchors or query parameters:</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># &quot;http://www.plosone.org/article/info:doi/10.1371/journal.pone.0100248#close&quot; → [1] &quot;10.1371/journal.pone.0100248&quot;</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># &quot;https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0100248#close&quot; → [1] &quot;10.1371/journal.pone.0100248&quot;</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    doi <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;.*info:doi/(.*/.*[[:digit:]]).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>,</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">gsub</span>(<span class="st">&quot;.*id=(.*/.*[[:digit:]]).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, url))</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># look up in PLOS:</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(fulltext)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: a PLOS DOI might not have fulltext, even if it&#39;s a valid DOI: PLOS assigns individual DOIs to *parts of articles* like figures or tables or supplements. See `ft_get-warnings` documentation.</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    fulltext <span class="ot">&lt;-</span>  <span class="fu">tryCatch</span>(<span class="fu">ft_get</span>(doi), <span class="at">warning=</span><span class="cf">function</span>(w) { <span class="fu">print</span>(w); <span class="fu">cat</span>(doi); <span class="fu">cat</span>(args[<span class="dv">1</span>]); <span class="fu">quit</span>(<span class="at">status=</span><span class="dv">1</span>) })</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(pubchunks)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> (fulltext <span class="sc">%&gt;%</span> <span class="fu">ft_collect</span>(<span class="st">&quot;author&quot;</span>, <span class="st">&quot;title&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pub_chunks</span>())<span class="sc">$</span>plos[[<span class="dv">1</span>]]</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: we preserve XML/HTML formatting in the abstract (but not other fields), such as headers or subscripts, by using &#39;as.character&#39; option</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    abstract <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">*&quot;</span>, <span class="st">&quot;×&quot;</span>, (fulltext <span class="sc">%&gt;%</span> <span class="fu">ft_collect</span>(<span class="st">&quot;abstract&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pub_chunks</span>(<span class="at">extract=</span><span class="st">&quot;as.character&quot;</span>))<span class="sc">$</span>plos[[<span class="dv">1</span>]]<span class="sc">$</span>abstract)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>    title <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st"> *&quot;</span>, <span class="st">&quot; &quot;</span>, y<span class="sc">$</span>title)</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>    author <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">sapply</span>(y<span class="sc">$</span>authors, <span class="cf">function</span>(a) { <span class="fu">paste</span>(a<span class="sc">$</span>given_names, a<span class="sc">$</span>surname)}), <span class="at">collapse=</span><span class="st">&quot;, &quot;</span>)</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># doi</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>    date <span class="ot">&lt;-</span> y<span class="sc">$</span>history<span class="sc">$</span>accepted</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DOIs are optional since so many fulltext PMC papers are still missing them</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">c</span>(<span class="fu">is.list</span>(title), <span class="fu">is.list</span>(author), <span class="fu">is.list</span>(date), <span class="fu">is.list</span>(abstract)))) {</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fallback to the other fulltext/rentrez path:</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if the backup query fails, fail out:</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">c</span>(<span class="fu">is.list</span>(title), <span class="fu">is.list</span>(author), <span class="fu">is.list</span>(date), <span class="fu">is.list</span>(abstract), (<span class="fu">nchar</span>(abstract) <span class="sc">&lt;</span> <span class="dv">50</span>)))) {</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;Some medata missing, exiting with error:&quot;</span>, args[<span class="dv">1</span>], title, author, date, doi, abstract, <span class="at">sep=</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>          <span class="fu">quit</span>(<span class="at">status=</span><span class="dv">1</span>)  }</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">c</span>(title, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">c</span>(author, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">c</span>(<span class="fu">as.character</span>(date), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.list</span>(doi)) { <span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>); } <span class="cf">else</span> { <span class="fu">cat</span>(<span class="fu">c</span>(doi, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)) }</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">c</span>(abstract, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># assume PMC</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    pmcid <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">&quot;/&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="fu">sub</span>(<span class="st">&quot;/pdf/.*&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="fu">sub</span>(<span class="st">&quot;https?://www.ncbi.nlm.nih.gov/pmc/articles/PMC&quot;</span>, <span class="st">&quot;&quot;</span>, args[<span class="dv">1</span>])))</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(fulltext)</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(rentrez)</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(pubchunks)</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    pmcidSearch <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">&quot;PMC&quot;</span>, pmcid, <span class="st">&quot;[pmcid]&quot;</span>)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>    paper    <span class="ot">&lt;-</span> <span class="fu">entrez_search</span>(<span class="at">db=</span><span class="st">&quot;pubmed&quot;</span>, <span class="at">term=</span>pmcidSearch)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>    rawXML   <span class="ot">&lt;-</span> <span class="fu">entrez_fetch</span>(<span class="at">db=</span><span class="st">&quot;pubmed&quot;</span>, <span class="at">id=</span>paper<span class="sc">$</span>id, <span class="at">rettype=</span><span class="st">&quot;xml&quot;</span>)</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>    fulltext <span class="ot">&lt;-</span> <span class="fu">parse_pubmed_xml</span>(rawXML)</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># handle section labels, like &#39;Methods and Materials&#39;, &#39;Conclusion&#39;, etc: https://github.com/ropensci/rentrez/issues/170</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PMC, turns out, encodes those descriptions into all-uppercase XML &#39;labels&#39; which are not payload/text, and rentrez by default strips them like it would any other bit of XML metadata. The different sections are then by default collapsed into a single run-on paragraph.</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to deal with this, we parse out the special labels, convert them to mixed-case (because `toTitlecase` preserves all-uppercase, we force to lowercase first), surround them with &lt;strong&gt;&lt;/strong&gt; per gwern.net house style for inline-headings, and combine the section header label and section text pairwise, and intersperse double-newlines to force separate paragraphs when parsed by LinkMetadata.hs as Markdown.</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># And if there are no section headers, then we just use the abstract as is.</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(XML)</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(tools)</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>    parsed_XML <span class="ot">&lt;-</span> <span class="fu">entrez_fetch</span>(<span class="at">db=</span><span class="st">&quot;pubmed&quot;</span>, <span class="at">id=</span>paper<span class="sc">$</span>id, <span class="at">rettype=</span><span class="st">&quot;xml&quot;</span>, <span class="at">parsed=</span><span class="cn">TRUE</span>)</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>    labels     <span class="ot">&lt;-</span> <span class="fu">sapply</span>(parsed_XML[<span class="st">&quot;//Abstract/AbstractText&quot;</span>], xmlGetAttr, <span class="st">&quot;Label&quot;</span>)</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>    labelsFormatted <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">tolower</span>(labels), <span class="cf">function</span>(s) { <span class="fu">paste0</span>(<span class="st">&quot;&lt;strong&gt;&quot;</span>, <span class="fu">toTitleCase</span>(s), <span class="st">&quot;&lt;/strong&gt;&quot;</span>); })</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>    text       <span class="ot">&lt;-</span> <span class="fu">sapply</span>(parsed_XML[<span class="st">&quot;//Abstract/AbstractText&quot;</span>], xmlValue)</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>    combined        <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">paste0</span>(labelsFormatted, <span class="fu">rep</span>(<span class="st">&quot;: &quot;</span>, <span class="fu">length</span>(labelsFormatted)), text), <span class="at">collapse=</span><span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">&quot;</span>)</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>    title    <span class="ot">&lt;-</span> fulltext<span class="sc">$</span>title</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>    author   <span class="ot">&lt;-</span> fulltext<span class="sc">$</span>author</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>    date     <span class="ot">&lt;-</span> fulltext<span class="sc">$</span>year</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>    doi      <span class="ot">&lt;-</span> fulltext<span class="sc">$</span>doi</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>    abstract <span class="ot">&lt;-</span> { <span class="cf">if</span> (<span class="fu">length</span>(labels) <span class="sc">&gt;</span> <span class="dv">1</span>) { combined; } <span class="cf">else</span> { fulltext<span class="sc">$</span>abstract; } }</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DOIs are optional since so many fulltext PMC papers are still missing them</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">c</span>(<span class="fu">is.list</span>(title), <span class="fu">is.list</span>(author), <span class="fu">is.list</span>(date), <span class="fu">is.list</span>(abstract)))) {</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fallback to the other fulltext/rentrez path:</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>        pmid <span class="ot">&lt;-</span> <span class="fu">entrez_search</span>(<span class="at">db =</span> <span class="st">&quot;pubmed&quot;</span>, <span class="at">term =</span> pmcidSearch)<span class="sc">$</span>ids</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>        ids <span class="ot">&lt;-</span> <span class="fu">entrez_summary</span>(<span class="at">db=</span><span class="st">&quot;pubmed&quot;</span>, <span class="at">id=</span>pmid)<span class="sc">$</span>articleids</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>        doi <span class="ot">&lt;-</span> ids[ids<span class="sc">$</span>idtype<span class="sc">==</span><span class="st">&quot;doi&quot;</span>,]<span class="sc">$</span>value</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>        f <span class="ot">&lt;-</span> <span class="fu">ft_get</span>(doi, <span class="at">from=</span><span class="st">&quot;entrez&quot;</span>, <span class="at">callopts=</span><span class="fu">list</span>(<span class="at">http_version =</span> 0L))</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>        f2 <span class="ot">&lt;-</span> f <span class="sc">%&gt;%</span> <span class="fu">ft_collect</span>()</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>        fulltext <span class="ot">&lt;-</span> (f <span class="sc">%&gt;%</span> <span class="fu">ft_collect</span>() <span class="sc">%&gt;%</span> <span class="fu">pub_chunks</span>(<span class="fu">c</span>(<span class="st">&quot;title&quot;</span>,<span class="st">&quot;authors&quot;</span>,<span class="st">&quot;front&quot;</span>)))<span class="sc">$</span>entrez[[<span class="dv">1</span>]]</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>        fulltextXML <span class="ot">&lt;-</span> (f <span class="sc">%&gt;%</span> <span class="fu">ft_collect</span>() <span class="sc">%&gt;%</span> <span class="fu">pub_chunks</span>(<span class="fu">c</span>(<span class="st">&quot;abstract&quot;</span>), <span class="at">extract=</span><span class="st">&quot;as.character&quot;</span>))<span class="sc">$</span>entrez[[<span class="dv">1</span>]]</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>        title    <span class="ot">&lt;-</span> fulltext<span class="sc">$</span>title</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>        author   <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">sapply</span>(fulltext<span class="sc">$</span>authors, <span class="cf">function</span>(a) { <span class="fu">paste</span>(a<span class="sc">$</span>given_names, a<span class="sc">$</span>surname)}), <span class="at">collapse=</span><span class="st">&quot;, &quot;</span>)</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>        date     <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">as.data.frame</span>(fulltext<span class="sc">$</span>front)<span class="sc">$</span>pub.date[<span class="dv">1</span>])</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>        date     <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.list</span>(date)) { <span class="st">&quot;&quot;</span> } <span class="cf">else</span> { date }</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>        doi      <span class="ot">&lt;-</span> fulltext<span class="sc">$</span>doi</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>        doi      <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.list</span>(doi)) { <span class="st">&quot;&quot;</span> } <span class="cf">else</span> { doi }</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>        abstract <span class="ot">&lt;-</span> fulltextXML<span class="sc">$</span>abstract</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if the backup query fails, fail out:</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">c</span>(<span class="fu">is.list</span>(title), <span class="fu">is.list</span>(author), <span class="fu">is.list</span>(date), <span class="fu">is.list</span>(abstract)))) {</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;Some medata missing, exiting with error:&quot;</span>, args[<span class="dv">1</span>], pmcid, title, author, date, doi, abstract, <span class="at">sep=</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>          <span class="fu">quit</span>(<span class="at">status=</span><span class="dv">1</span>)  }</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">c</span>(title, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">c</span>(author, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">c</span>(<span class="fu">as.character</span>(date), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.list</span>(doi)) { <span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>); } <span class="cf">else</span> { <span class="fu">cat</span>(<span class="fu">c</span>(doi, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)) }</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste0</span>(abstract, <span class="at">sep=</span><span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">&quot;</span>))</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
