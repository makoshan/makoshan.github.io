<div class="sourceCode" id="cb1"><pre class="sourceCode Javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Miscellaneous JS functions which run after the page loads to rewrite or adjust parts of the page. */</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">/* author: Said Achmiz */</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">/* license: MIT */</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">rewriteFunctions</span> <span class="op">=</span> { }<span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">/**********/</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">/* TABLES */</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">/**********/</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">/****************************************************************/</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Wrap each table in a div.table-wrapper (for layout purposes).</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">wrapTables</span>(loadEventInfo) {</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;wrapTables&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> wrapperClass <span class="op">=</span> <span class="st">&quot;table-wrapper&quot;</span><span class="op">;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;table&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(table <span class="kw">=&gt;</span> {</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (table<span class="op">.</span><span class="at">parentElement</span><span class="op">.</span><span class="at">tagName</span> <span class="op">==</span> <span class="st">&quot;DIV&quot;</span> <span class="op">&amp;&amp;</span> table<span class="op">.</span><span class="at">parentElement</span><span class="op">.</span><span class="at">children</span><span class="op">.</span><span class="at">length</span> <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>            table<span class="op">.</span><span class="at">parentElement</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(wrapperClass<span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>            table<span class="op">.</span><span class="at">outerHTML</span> <span class="op">=</span> <span class="vs">`&lt;div class=&quot;</span><span class="sc">${</span>wrapperClass<span class="sc">}</span><span class="vs">&quot;&gt;`</span> <span class="op">+</span> table<span class="op">.</span><span class="at">outerHTML</span> <span class="op">+</span> <span class="vs">`&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co">/******************************************************************************/</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Wrap each full-width table in a div.full-width-table-wrapper, and also move</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co">    the .collapse class (if any) from the outer wrapper to the table (for</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co">    consistency).</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">wrapFullWidthTables</span>(loadEventInfo) {</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;wrapFullWidthTables&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> fullWidthClass <span class="op">=</span> <span class="st">&quot;full-width&quot;</span><span class="op">;</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> fullWidthInnerWrapperClass <span class="op">=</span> <span class="st">&quot;full-width-table-inner-wrapper&quot;</span><span class="op">;</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="vs">`.table-wrapper.</span><span class="sc">${</span>fullWidthClass<span class="sc">}</span><span class="vs">`</span>)<span class="op">.</span><span class="fu">forEach</span>(fullWidthTableWrapper <span class="kw">=&gt;</span> {</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (fullWidthTableWrapper<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&quot;collapse&quot;</span>)) {</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>            fullWidthTableWrapper<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&quot;collapse&quot;</span>)<span class="op">;</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>            fullWidthTableWrapper<span class="op">.</span><span class="at">firstElementChild</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&quot;collapse&quot;</span>)<span class="op">;</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        fullWidthTableWrapper<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;div class=&quot;</span><span class="sc">${</span>fullWidthInnerWrapperClass<span class="sc">}</span><span class="vs">&quot;&gt;`</span> <span class="op">+</span> fullWidthTableWrapper<span class="op">.</span><span class="at">innerHTML</span> <span class="op">+</span> <span class="vs">`&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="co">/**********************************************/</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Add content load handler to process tables.</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> GW<span class="op">.</span><span class="at">rewriteFunctions</span><span class="op">.</span><span class="at">processTables</span> <span class="op">=</span> (info) <span class="kw">=&gt;</span> {</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;GW.rewriteFunctions.processTables&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wrapTables</span>(info)<span class="op">;</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (info<span class="op">.</span><span class="at">fullWidthPossible</span>)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>        <span class="fu">wrapFullWidthTables</span>(info)<span class="op">;</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">phase</span><span class="op">:</span> <span class="st">&quot;rewrite&quot;</span><span class="op">,</span> <span class="dt">condition</span><span class="op">:</span> (info) <span class="kw">=&gt;</span> info<span class="op">.</span><span class="at">needsRewrite</span> })<span class="op">;</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="co">/***********/</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="co">/* FIGURES */</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="co">/***********/</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="co">/********************************/</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Inject wrappers into figures.</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">wrapFigures</span>(loadEventInfo) {</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;wrapFigures&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;figure&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(figure <span class="kw">=&gt;</span> {</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> media <span class="op">=</span> figure<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;img, audio, video&quot;</span>)<span class="op">;</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caption <span class="op">=</span> figure<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;figcaption&quot;</span>)<span class="op">;</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span>(media <span class="op">&amp;&amp;</span> caption))</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Create an inner wrapper for the figure contents.</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> innerWrapper <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&quot;span&quot;</span>)<span class="op">;</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>        innerWrapper<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&quot;figure-inner-wrapper&quot;</span>)<span class="op">;</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>        figure<span class="op">.</span><span class="fu">appendChild</span>(innerWrapper)<span class="op">;</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Wrap the caption in the wrapper span.</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> wrapper <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&quot;span&quot;</span>)<span class="op">;</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>        wrapper<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&quot;caption-wrapper&quot;</span>)<span class="op">;</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>        wrapper<span class="op">.</span><span class="fu">appendChild</span>(caption)<span class="op">;</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Get the media, or (if any) the image wrapper.</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> mediaBlock <span class="op">=</span> media<span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;.image-wrapper&quot;</span>) <span class="op">||</span> media<span class="op">;</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Re-insert the (possibly wrapped) media and the wrapped caption into</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  the figure.</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>        innerWrapper<span class="op">.</span><span class="fu">appendChild</span>(mediaBlock)<span class="op">;</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>        innerWrapper<span class="op">.</span><span class="fu">appendChild</span>(wrapper)<span class="op">;</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Tag the figure with the image’s float class.</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (media<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&quot;float-left&quot;</span>))</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>            media<span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;figure&quot;</span>)<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&quot;float-left&quot;</span>)<span class="op">;</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (media<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&quot;float-right&quot;</span>))</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>            media<span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;figure&quot;</span>)<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&quot;float-right&quot;</span>)<span class="op">;</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a><span class="co">/********************************************************************/</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Designate full-width figures as such (with a ‘full-width’ class).</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">markFullWidthFigures</span>(loadEventInfo) {</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;markFullWidthFigures&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> fullWidthClass <span class="op">=</span> <span class="st">&quot;full-width&quot;</span><span class="op">;</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> allFullWidthMedia <span class="op">=</span> loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="vs">`img.</span><span class="sc">${</span>fullWidthClass<span class="sc">}</span><span class="vs">, video.</span><span class="sc">${</span>fullWidthClass<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>    allFullWidthMedia<span class="op">.</span><span class="fu">forEach</span>(fullWidthMedia <span class="kw">=&gt;</span> {</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>        fullWidthMedia<span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;figure&quot;</span>)<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(fullWidthClass<span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Add ‘load’ listener for lazy-loaded media (as it might cause re-layout</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a><span class="co">        of e.g. sidenotes). Do this only after page loads, to avoid spurious</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a><span class="co">        re-layout at initial page load.</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">doWhenPageLoaded</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>        allFullWidthMedia<span class="op">.</span><span class="fu">forEach</span>(fullWidthMedia <span class="kw">=&gt;</span> {</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>            fullWidthMedia<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;load&quot;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>                GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">fireEvent</span>(<span class="st">&quot;Rewrite.fullWidthMediaDidLoad&quot;</span>)<span class="op">;</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a><span class="co">/***********************************************/</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Add content load handler to process figures.</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> GW<span class="op">.</span><span class="at">rewriteFunctions</span><span class="op">.</span><span class="at">processFigures</span> <span class="op">=</span> (info) <span class="kw">=&gt;</span> {</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;GW.rewriteFunctions.processFigures&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wrapFigures</span>(info)<span class="op">;</span></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (info<span class="op">.</span><span class="at">fullWidthPossible</span>)</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>        <span class="fu">markFullWidthFigures</span>(info)<span class="op">;</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">phase</span><span class="op">:</span> <span class="st">&quot;rewrite&quot;</span><span class="op">,</span> <span class="dt">condition</span><span class="op">:</span> (info) <span class="kw">=&gt;</span> info<span class="op">.</span><span class="at">needsRewrite</span> })<span class="op">;</span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a><span class="co">/***************/</span></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a><span class="co">/* CODE BLOCKS */</span></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a><span class="co">/***************/</span></span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a><span class="co">/***********************************************************/</span></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Wrap each pre.full-width in a div.full-width and a</span></span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a><span class="co">    div.full-width-code-block-wrapper (for layout purposes).</span></span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">wrapFullWidthPreBlocks</span>(loadEventInfo) {</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;wrapFullWidthPreBlocks&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> fullWidthClass <span class="op">=</span> <span class="st">&quot;full-width&quot;</span><span class="op">;</span></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> fullWidthInnerWrapperClass <span class="op">=</span> <span class="st">&quot;full-width-code-block-wrapper&quot;</span><span class="op">;</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>    loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="vs">`pre.</span><span class="sc">${</span>fullWidthClass<span class="sc">}</span><span class="vs">`</span>)<span class="op">.</span><span class="fu">forEach</span>(fullWidthPre <span class="kw">=&gt;</span> {</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (fullWidthPre<span class="op">.</span><span class="at">parentElement</span><span class="op">.</span><span class="at">tagName</span> <span class="op">==</span> <span class="st">&quot;DIV&quot;</span> <span class="op">&amp;&amp;</span> fullWidthPre<span class="op">.</span><span class="at">parentElement</span><span class="op">.</span><span class="at">children</span><span class="op">.</span><span class="at">length</span> <span class="op">==</span> <span class="dv">1</span>) {</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>            fullWidthPre<span class="op">.</span><span class="at">parentElement</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(fullWidthClass<span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>            fullWidthPre<span class="op">.</span><span class="at">parentElement</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;div class=&quot;</span><span class="sc">${</span>fullWidthInnerWrapperClass<span class="sc">}</span><span class="vs">&quot;&gt;`</span> <span class="op">+</span> fullWidthPre<span class="op">.</span><span class="at">parentElement</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">+</span> <span class="vs">`&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>            fullWidthPre<span class="op">.</span><span class="at">parentElement</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>                  <span class="vs">`&lt;div class=&quot;</span><span class="sc">${</span>fullWidthInnerWrapperClass<span class="sc">}</span><span class="vs">&quot;&gt;`</span></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span> <span class="vs">`&lt;div class=&quot;</span><span class="sc">${</span>fullWidthClass<span class="sc">}</span><span class="vs">&quot;&gt;`</span></span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span> fullWidthPre<span class="op">.</span><span class="at">parentElement</span><span class="op">.</span><span class="at">innerHTML</span></span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span> <span class="vs">`&lt;/div&gt;`</span></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span> <span class="vs">`&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a><span class="co">/***************************************************/</span></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Add content load handler to process code blocks.</span></span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> GW<span class="op">.</span><span class="at">rewriteFunctions</span><span class="op">.</span><span class="at">processCodeBlocks</span> <span class="op">=</span> (info) <span class="kw">=&gt;</span> {</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;GW.rewriteFunctions.processCodeBlocks&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (info<span class="op">.</span><span class="at">fullWidthPossible</span>)</span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>        <span class="fu">wrapFullWidthPreBlocks</span>(info)<span class="op">;</span></span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">phase</span><span class="op">:</span> <span class="st">&quot;rewrite&quot;</span><span class="op">,</span> <span class="dt">condition</span><span class="op">:</span> (info) <span class="kw">=&gt;</span> info<span class="op">.</span><span class="at">needsRewrite</span> })<span class="op">;</span></span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a><span class="co">/**************/</span></span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a><span class="co">/* TYPOGRAPHY */</span></span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a><span class="co">/**************/</span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a><span class="co">/*****************************************/</span></span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Returns the current selection as HTML.</span></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">getSelectionHTML</span>() {</span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> container <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>    container<span class="op">.</span><span class="fu">appendChild</span>(<span class="bu">window</span><span class="op">.</span><span class="fu">getSelection</span>()<span class="op">.</span><span class="fu">getRangeAt</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">cloneContents</span>())<span class="op">;</span></span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> container<span class="op">.</span><span class="at">innerHTML</span><span class="op">;</span></span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a><span class="co">/*********************/</span></span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a><span class="co">/* FULL-WIDTH BLOCKS */</span></span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a><span class="co">/*********************/</span></span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a><span class="co">/*******************************************************************************/</span></span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Expands all tables (&amp; other blocks) whose wrapper block is marked with class</span></span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a><span class="co">    ‘full-width’, and all figures marked with class ‘full-width’, to span the</span></span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a><span class="co">    viewport (minus a specified margin on both sides).</span></span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createFullWidthBlockLayoutStyles</span>() {</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;createFullWidthBlockLayoutStyles&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Configuration and dynamic value storage.</span></span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>    GW<span class="op">.</span><span class="at">fullWidthBlockLayout</span> <span class="op">=</span> {</span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>        <span class="dt">sideMargin</span><span class="op">:</span> <span class="dv">25</span><span class="op">,</span></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>        <span class="dt">pageWidth</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>        <span class="dt">leftAdjustment</span><span class="op">:</span> <span class="dv">0</span></span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Pre-query key elements, to save performance on resize.</span></span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> rootElement <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;html&quot;</span>)<span class="op">;</span></span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> markdownBody <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;#markdownBody&quot;</span>)<span class="op">;</span></span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Inject styles block to hold dynamically updated layout variables.</span></span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;head&quot;</span>)<span class="op">.</span><span class="fu">insertAdjacentHTML</span>(<span class="st">&quot;beforeend&quot;</span><span class="op">,</span> <span class="vs">`&lt;style id=&quot;full-width-block-layout-styles&quot;&gt;&lt;/style&gt;`</span>)<span class="op">;</span></span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> fullWidthBlockLayoutStyles <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;#full-width-block-layout-styles&quot;</span>)<span class="op">;</span></span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Function to update layout variables (called immediately and on resize).</span></span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> updateFullWidthBlockLayoutStyles <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;updateFullWidthBlockLayoutStyles&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>        GW<span class="op">.</span><span class="at">fullWidthBlockLayout</span><span class="op">.</span><span class="at">pageWidth</span> <span class="op">=</span> rootElement<span class="op">.</span><span class="at">offsetWidth</span><span class="op">;</span></span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> markdownBodyRect <span class="op">=</span> markdownBody<span class="op">.</span><span class="fu">getBoundingClientRect</span>()<span class="op">;</span></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> markdownBodyRightMargin <span class="op">=</span> GW<span class="op">.</span><span class="at">fullWidthBlockLayout</span><span class="op">.</span><span class="at">pageWidth</span> <span class="op">-</span> markdownBodyRect<span class="op">.</span><span class="at">right</span><span class="op">;</span></span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>        GW<span class="op">.</span><span class="at">fullWidthBlockLayout</span><span class="op">.</span><span class="at">leftAdjustment</span> <span class="op">=</span> markdownBodyRect<span class="op">.</span><span class="at">left</span> <span class="op">-</span> markdownBodyRightMargin<span class="op">;</span></span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>        fullWidthBlockLayoutStyles<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`:root {</span></span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a><span class="vs">            --GW-full-width-block-layout-side-margin: </span><span class="sc">${</span>GW<span class="op">.</span><span class="at">fullWidthBlockLayout</span><span class="op">.</span><span class="at">sideMargin</span><span class="sc">}</span><span class="vs">px;</span></span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a><span class="vs">            --GW-full-width-block-layout-page-width: </span><span class="sc">${</span>GW<span class="op">.</span><span class="at">fullWidthBlockLayout</span><span class="op">.</span><span class="at">pageWidth</span><span class="sc">}</span><span class="vs">px;</span></span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a><span class="vs">            --GW-full-width-block-layout-left-adjustment: </span><span class="sc">${</span>GW<span class="op">.</span><span class="at">fullWidthBlockLayout</span><span class="op">.</span><span class="at">leftAdjustment</span><span class="sc">}</span><span class="vs">px;</span></span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a><span class="vs">        }`</span><span class="op">;</span></span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateFullWidthBlockLayoutStyles</span>()<span class="op">;</span></span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Add listener to update layout variables on window resize.</span></span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;resize&quot;</span><span class="op">,</span> updateFullWidthBlockLayoutStyles)<span class="op">;</span></span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a><span class="fu">doWhenPageLoaded</span>(createFullWidthBlockLayoutStyles)<span class="op">;</span></span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a><span class="co">/************************************/</span></span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Set margins of full-width blocks.</span></span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">setMarginsOnFullWidthBlocks</span>(loadEventInfo) {</span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;setMarginsOnFullWidthBlocks&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Get all full-width blocks in the given document.</span></span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> allFullWidthBlocks <span class="op">=</span> loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;div.full-width, figure.full-width&quot;</span>)<span class="op">;</span></span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> removeFullWidthBlockMargins <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a>        allFullWidthBlocks<span class="op">.</span><span class="fu">forEach</span>(fullWidthBlock <span class="kw">=&gt;</span> {</span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>            fullWidthBlock<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">marginLeft</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a>            fullWidthBlock<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">marginRight</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>loadEventInfo<span class="op">.</span><span class="at">fullWidthPossible</span>) {</span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a>        <span class="fu">removeFullWidthBlockMargins</span>()<span class="op">;</span></span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Un-expand when mobile width, expand otherwise.</span></span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a>    <span class="fu">doWhenMatchMedia</span>(GW<span class="op">.</span><span class="at">mediaQueries</span><span class="op">.</span><span class="at">mobileWidth</span><span class="op">,</span> <span class="st">&quot;updateFullWidthBlockExpansionForCurrentWidthClass&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a>        <span class="fu">removeFullWidthBlockMargins</span>()<span class="op">;</span></span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a>        allFullWidthBlocks<span class="op">.</span><span class="fu">forEach</span>(fullWidthBlock <span class="kw">=&gt;</span> {</span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a>            fullWidthBlock<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">marginLeft</span> <span class="op">=</span> <span class="vs">`calc(</span></span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a><span class="vs">                                                    (-1 * (var(--GW-full-width-block-layout-left-adjustment) / 2.0))</span></span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a><span class="vs">                                                  + (var(--GW-full-width-block-layout-side-margin))</span></span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a><span class="vs">                                                  - ((var(--GW-full-width-block-layout-page-width) - 100%) / 2.0)</span></span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a><span class="vs">                                                )`</span><span class="op">;</span></span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a>            fullWidthBlock<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">marginRight</span> <span class="op">=</span> <span class="vs">`calc(</span></span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a><span class="vs">                                                     (var(--GW-full-width-block-layout-left-adjustment) / 2.0)</span></span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true" tabindex="-1"></a><span class="vs">                                                   + (var(--GW-full-width-block-layout-side-margin))</span></span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true" tabindex="-1"></a><span class="vs">                                                   - ((var(--GW-full-width-block-layout-page-width) - 100%) / 2.0)</span></span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a><span class="vs">                                                )`</span><span class="op">;</span></span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a><span class="co">/*********************************************************/</span></span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Add content load handler to process full-width blocks.</span></span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> GW<span class="op">.</span><span class="at">rewriteFunctions</span><span class="op">.</span><span class="at">processFullWidthBlocks</span> <span class="op">=</span> (info) <span class="kw">=&gt;</span> {</span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;GW.rewriteFunctions.processFullWidthBlocks&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-288"><a href="#cb1-288" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setMarginsOnFullWidthBlocks</span>(info)<span class="op">;</span></span>
<span id="cb1-289"><a href="#cb1-289" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">phase</span><span class="op">:</span> <span class="st">&quot;&gt;rewrite&quot;</span> })<span class="op">;</span></span>
<span id="cb1-290"><a href="#cb1-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-291"><a href="#cb1-291" aria-hidden="true" tabindex="-1"></a><span class="co">/***************************/</span></span>
<span id="cb1-292"><a href="#cb1-292" aria-hidden="true" tabindex="-1"></a><span class="co">/* ANNOTATIONS (FRAGMENTS) */</span></span>
<span id="cb1-293"><a href="#cb1-293" aria-hidden="true" tabindex="-1"></a><span class="co">/***************************/</span></span>
<span id="cb1-294"><a href="#cb1-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-295"><a href="#cb1-295" aria-hidden="true" tabindex="-1"></a><span class="co">/*******************************************************************************/</span></span>
<span id="cb1-296"><a href="#cb1-296" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Apply various typographic fixes (educate quotes, inject &lt;wbr&gt; elements after</span></span>
<span id="cb1-297"><a href="#cb1-297" aria-hidden="true" tabindex="-1"></a><span class="co">    certain problematic characters, etc.).</span></span>
<span id="cb1-298"><a href="#cb1-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-299"><a href="#cb1-299" aria-hidden="true" tabindex="-1"></a><span class="co">    Requires typography.js to be loaded prior to this file.</span></span>
<span id="cb1-300"><a href="#cb1-300" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-301"><a href="#cb1-301" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">rectifyTypographyInAnnotation</span>(loadEventInfo) {</span>
<span id="cb1-302"><a href="#cb1-302" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;rectifyTypographyInAnnotation&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-303"><a href="#cb1-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-304"><a href="#cb1-304" aria-hidden="true" tabindex="-1"></a>    Typography<span class="op">.</span><span class="fu">processElement</span>(loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">,</span></span>
<span id="cb1-305"><a href="#cb1-305" aria-hidden="true" tabindex="-1"></a>          Typography<span class="op">.</span><span class="at">replacementTypes</span><span class="op">.</span><span class="at">QUOTES</span></span>
<span id="cb1-306"><a href="#cb1-306" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> Typography<span class="op">.</span><span class="at">replacementTypes</span><span class="op">.</span><span class="at">WORDBREAKS</span></span>
<span id="cb1-307"><a href="#cb1-307" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> Typography<span class="op">.</span><span class="at">replacementTypes</span><span class="op">.</span><span class="at">ELLIPSES</span></span>
<span id="cb1-308"><a href="#cb1-308" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb1-309"><a href="#cb1-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-310"><a href="#cb1-310" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Educate quotes in image alt-text.</span></span>
<span id="cb1-311"><a href="#cb1-311" aria-hidden="true" tabindex="-1"></a>    loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;img&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(image <span class="kw">=&gt;</span> {</span>
<span id="cb1-312"><a href="#cb1-312" aria-hidden="true" tabindex="-1"></a>        image<span class="op">.</span><span class="at">alt</span> <span class="op">=</span> Typography<span class="op">.</span><span class="fu">processString</span>(image<span class="op">.</span><span class="at">alt</span><span class="op">,</span> Typography<span class="op">.</span><span class="at">replacementTypes</span><span class="op">.</span><span class="at">QUOTES</span>)<span class="op">;</span></span>
<span id="cb1-313"><a href="#cb1-313" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-314"><a href="#cb1-314" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-315"><a href="#cb1-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-316"><a href="#cb1-316" aria-hidden="true" tabindex="-1"></a><span class="co">/*****************************************************************************/</span></span>
<span id="cb1-317"><a href="#cb1-317" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Sets, in CSS, the image dimensions that are specified in HTML.</span></span>
<span id="cb1-318"><a href="#cb1-318" aria-hidden="true" tabindex="-1"></a><span class="co">    (This is to ensure no reflow when annotation popups are spawned.)</span></span>
<span id="cb1-319"><a href="#cb1-319" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-320"><a href="#cb1-320" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">setImageDimensionsInAnnotation</span>(loadEventInfo) {</span>
<span id="cb1-321"><a href="#cb1-321" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;setImageDimensionsInAnnotation&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-322"><a href="#cb1-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-323"><a href="#cb1-323" aria-hidden="true" tabindex="-1"></a>    loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;figure img[width]&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(image <span class="kw">=&gt;</span> {</span>
<span id="cb1-324"><a href="#cb1-324" aria-hidden="true" tabindex="-1"></a>        image<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">width</span> <span class="op">=</span> image<span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&quot;width&quot;</span>) <span class="op">+</span> <span class="st">&quot;px&quot;</span><span class="op">;</span></span>
<span id="cb1-325"><a href="#cb1-325" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-326"><a href="#cb1-326" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-327"><a href="#cb1-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-328"><a href="#cb1-328" aria-hidden="true" tabindex="-1"></a><span class="co">/**************************************************************************/</span></span>
<span id="cb1-329"><a href="#cb1-329" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Add content load handler for processing a loaded annotation (fragment).</span></span>
<span id="cb1-330"><a href="#cb1-330" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-331"><a href="#cb1-331" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> GW<span class="op">.</span><span class="at">rewriteFunctions</span><span class="op">.</span><span class="at">processAnnotation</span> <span class="op">=</span> (info) <span class="kw">=&gt;</span> {</span>
<span id="cb1-332"><a href="#cb1-332" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;GW.rewriteFunctions.processAnnotation&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-333"><a href="#cb1-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-334"><a href="#cb1-334" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rectifyTypographyInAnnotation</span>(info)<span class="op">;</span></span>
<span id="cb1-335"><a href="#cb1-335" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setImageDimensionsInAnnotation</span>(info)<span class="op">;</span></span>
<span id="cb1-336"><a href="#cb1-336" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">phase</span><span class="op">:</span> <span class="st">&quot;rewrite&quot;</span><span class="op">,</span> <span class="dt">condition</span><span class="op">:</span> (info) <span class="kw">=&gt;</span> (info<span class="op">.</span><span class="at">isMainDocument</span> <span class="op">==</span> <span class="kw">false</span> <span class="op">&amp;&amp;</span> info<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="at">parentElement</span><span class="op">.</span><span class="at">id</span> <span class="op">==</span> <span class="st">&quot;annotations-workspace&quot;</span>) })<span class="op">;</span></span>
<span id="cb1-337"><a href="#cb1-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-338"><a href="#cb1-338" aria-hidden="true" tabindex="-1"></a><span class="co">/*************/</span></span>
<span id="cb1-339"><a href="#cb1-339" aria-hidden="true" tabindex="-1"></a><span class="co">/* FOOTNOTES */</span></span>
<span id="cb1-340"><a href="#cb1-340" aria-hidden="true" tabindex="-1"></a><span class="co">/*************/</span></span>
<span id="cb1-341"><a href="#cb1-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-342"><a href="#cb1-342" aria-hidden="true" tabindex="-1"></a><span class="co">/************************************************************************/</span></span>
<span id="cb1-343"><a href="#cb1-343" aria-hidden="true" tabindex="-1"></a><span class="co">/*  The footnotes section has no ID because Pandoc is weird. Give it one.</span></span>
<span id="cb1-344"><a href="#cb1-344" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-345"><a href="#cb1-345" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">identifyFootnotesSection</span>(loadEventInfo) {</span>
<span id="cb1-346"><a href="#cb1-346" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;identifyFootnotesSection&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-347"><a href="#cb1-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-348"><a href="#cb1-348" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> footnotesSection <span class="op">=</span> loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;section.footnotes&quot;</span>)<span class="op">;</span></span>
<span id="cb1-349"><a href="#cb1-349" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (footnotesSection)</span>
<span id="cb1-350"><a href="#cb1-350" aria-hidden="true" tabindex="-1"></a>        footnotesSection<span class="op">.</span><span class="at">id</span> <span class="op">=</span> <span class="st">&quot;footnotes&quot;</span><span class="op">;</span></span>
<span id="cb1-351"><a href="#cb1-351" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-352"><a href="#cb1-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-353"><a href="#cb1-353" aria-hidden="true" tabindex="-1"></a><span class="co">/******************************/</span></span>
<span id="cb1-354"><a href="#cb1-354" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Inject footnote self-links.</span></span>
<span id="cb1-355"><a href="#cb1-355" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-356"><a href="#cb1-356" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">injectFootnoteSelfLinks</span>(loadEventInfo) {</span>
<span id="cb1-357"><a href="#cb1-357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;injectFootnoteSelfLinks&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-358"><a href="#cb1-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-359"><a href="#cb1-359" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> footnotesSection <span class="op">=</span> loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;#footnotes&quot;</span>)<span class="op">;</span></span>
<span id="cb1-360"><a href="#cb1-360" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>footnotesSection)</span>
<span id="cb1-361"><a href="#cb1-361" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb1-362"><a href="#cb1-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-363"><a href="#cb1-363" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> footnotes <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(footnotesSection<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;#footnotes &gt; ol&quot;</span>)<span class="op">.</span><span class="at">children</span>)<span class="op">;</span></span>
<span id="cb1-364"><a href="#cb1-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-365"><a href="#cb1-365" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> footnotes<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>)</span>
<span id="cb1-366"><a href="#cb1-366" aria-hidden="true" tabindex="-1"></a>        footnotes[i]<span class="op">.</span><span class="fu">insertAdjacentHTML</span>(<span class="st">&quot;afterbegin&quot;</span><span class="op">,</span> <span class="vs">`&lt;a href=&quot;#fn</span><span class="sc">${</span>(i <span class="op">+</span> <span class="dv">1</span>)<span class="sc">}</span><span class="vs">&quot; title=&quot;Link to footnote </span><span class="sc">${</span>(i <span class="op">+</span> <span class="dv">1</span>)<span class="sc">}</span><span class="vs">&quot; class=&quot;footnote-self-link&quot;&gt;&amp;nbsp;&lt;/a&gt;`</span>)<span class="op">;</span></span>
<span id="cb1-367"><a href="#cb1-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-368"><a href="#cb1-368" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Highlight footnote on hover over self-link.</span></span>
<span id="cb1-369"><a href="#cb1-369" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;.footnote-self-link&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(footnoteSelfLink <span class="kw">=&gt;</span> {</span>
<span id="cb1-370"><a href="#cb1-370" aria-hidden="true" tabindex="-1"></a>        footnoteSelfLink<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;mouseenter&quot;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-371"><a href="#cb1-371" aria-hidden="true" tabindex="-1"></a>            footnoteSelfLink<span class="op">.</span><span class="at">parentElement</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;highlighted&quot;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb1-372"><a href="#cb1-372" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-373"><a href="#cb1-373" aria-hidden="true" tabindex="-1"></a>        footnoteSelfLink<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;mouseleave&quot;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-374"><a href="#cb1-374" aria-hidden="true" tabindex="-1"></a>            footnoteSelfLink<span class="op">.</span><span class="at">parentElement</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;highlighted&quot;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb1-375"><a href="#cb1-375" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-376"><a href="#cb1-376" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-377"><a href="#cb1-377" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-378"><a href="#cb1-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-379"><a href="#cb1-379" aria-hidden="true" tabindex="-1"></a><span class="co">/*****************************************************/</span></span>
<span id="cb1-380"><a href="#cb1-380" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Inject self-link for the footnotes section itself.</span></span>
<span id="cb1-381"><a href="#cb1-381" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-382"><a href="#cb1-382" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">injectFootnoteSectionSelfLink</span>(loadEventInfo) {</span>
<span id="cb1-383"><a href="#cb1-383" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;injectFootnoteSectionSelfLink&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-384"><a href="#cb1-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-385"><a href="#cb1-385" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> footnotesSection <span class="op">=</span> loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;#footnotes&quot;</span>)<span class="op">;</span></span>
<span id="cb1-386"><a href="#cb1-386" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>footnotesSection)</span>
<span id="cb1-387"><a href="#cb1-387" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb1-388"><a href="#cb1-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-389"><a href="#cb1-389" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> footnotesSectionSelfLink <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&quot;A&quot;</span>)<span class="op">;</span></span>
<span id="cb1-390"><a href="#cb1-390" aria-hidden="true" tabindex="-1"></a>    footnotesSectionSelfLink<span class="op">.</span><span class="at">href</span> <span class="op">=</span> <span class="st">&quot;#footnotes&quot;</span><span class="op">;</span></span>
<span id="cb1-391"><a href="#cb1-391" aria-hidden="true" tabindex="-1"></a>    footnotesSectionSelfLink<span class="op">.</span><span class="at">title</span> <span class="op">=</span> <span class="st">&quot;Link to section: § ‘Footnotes’&quot;</span><span class="op">;</span></span>
<span id="cb1-392"><a href="#cb1-392" aria-hidden="true" tabindex="-1"></a>    footnotesSectionSelfLink<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&quot;section-self-link&quot;</span>)<span class="op">;</span></span>
<span id="cb1-393"><a href="#cb1-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-394"><a href="#cb1-394" aria-hidden="true" tabindex="-1"></a>    footnotesSection<span class="op">.</span><span class="fu">insertBefore</span>(footnotesSectionSelfLink<span class="op">,</span> footnotesSection<span class="op">.</span><span class="at">firstElementChild</span><span class="op">.</span><span class="at">nextElementSibling</span>)<span class="op">;</span></span>
<span id="cb1-395"><a href="#cb1-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-396"><a href="#cb1-396" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Highlight on hover.</span></span>
<span id="cb1-397"><a href="#cb1-397" aria-hidden="true" tabindex="-1"></a>    footnotesSectionSelfLink<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;mouseenter&quot;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-398"><a href="#cb1-398" aria-hidden="true" tabindex="-1"></a>        footnotesSectionSelfLink<span class="op">.</span><span class="at">previousElementSibling</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;highlighted&quot;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb1-399"><a href="#cb1-399" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-400"><a href="#cb1-400" aria-hidden="true" tabindex="-1"></a>    footnotesSectionSelfLink<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;mouseleave&quot;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-401"><a href="#cb1-401" aria-hidden="true" tabindex="-1"></a>        footnotesSectionSelfLink<span class="op">.</span><span class="at">previousElementSibling</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;highlighted&quot;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb1-402"><a href="#cb1-402" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-403"><a href="#cb1-403" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-404"><a href="#cb1-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-405"><a href="#cb1-405" aria-hidden="true" tabindex="-1"></a><span class="co">/**************************************************************************/</span></span>
<span id="cb1-406"><a href="#cb1-406" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Return all {side|foot}note elements associated with the given citation.</span></span>
<span id="cb1-407"><a href="#cb1-407" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-408"><a href="#cb1-408" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">allNotesForCitation</span>(citation) {</span>
<span id="cb1-409"><a href="#cb1-409" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>citation<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&quot;footnote-ref&quot;</span>))</span>
<span id="cb1-410"><a href="#cb1-410" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb1-411"><a href="#cb1-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-412"><a href="#cb1-412" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> citationNumber <span class="op">=</span> citation<span class="op">.</span><span class="at">id</span><span class="op">.</span><span class="fu">substr</span>(<span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb1-413"><a href="#cb1-413" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  We must check to ensure that the note in question is from the same</span></span>
<span id="cb1-414"><a href="#cb1-414" aria-hidden="true" tabindex="-1"></a><span class="co">        page as the citation (to distinguish between main document and any</span></span>
<span id="cb1-415"><a href="#cb1-415" aria-hidden="true" tabindex="-1"></a><span class="co">        full-page embeds that may be spawned).</span></span>
<span id="cb1-416"><a href="#cb1-416" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-417"><a href="#cb1-417" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="vs">`#fn</span><span class="sc">${</span>citationNumber<span class="sc">}</span><span class="vs">, #sn</span><span class="sc">${</span>citationNumber<span class="sc">}</span><span class="vs">`</span>))<span class="op">.</span><span class="fu">filter</span>(note <span class="kw">=&gt;</span> note<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;.footnote-back&quot;</span>)<span class="op">.</span><span class="at">pathname</span> <span class="op">==</span> citation<span class="op">.</span><span class="at">pathname</span>)<span class="op">;</span></span>
<span id="cb1-418"><a href="#cb1-418" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-419"><a href="#cb1-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-420"><a href="#cb1-420" aria-hidden="true" tabindex="-1"></a><span class="co">/***************************************************************************/</span></span>
<span id="cb1-421"><a href="#cb1-421" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Bind mouse hover events to, when hovering over a citation, highlight all</span></span>
<span id="cb1-422"><a href="#cb1-422" aria-hidden="true" tabindex="-1"></a><span class="co">    {side|foot}notes associated with that citation.</span></span>
<span id="cb1-423"><a href="#cb1-423" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-424"><a href="#cb1-424" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">bindNoteHighlightEventsToCitations</span>(loadEventInfo) {</span>
<span id="cb1-425"><a href="#cb1-425" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;bindNoteHighlightEventsToCitations&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-426"><a href="#cb1-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-427"><a href="#cb1-427" aria-hidden="true" tabindex="-1"></a>    loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;.footnote-ref&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(citation <span class="kw">=&gt;</span> {</span>
<span id="cb1-428"><a href="#cb1-428" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Unbind existing events, if any.</span></span>
<span id="cb1-429"><a href="#cb1-429" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (citation<span class="op">.</span><span class="at">citationMouseEnter</span>) citation<span class="op">.</span><span class="fu">removeEventListener</span>(<span class="st">&quot;mouseenter&quot;</span><span class="op">,</span> citation<span class="op">.</span><span class="at">citationMouseEnter</span>)<span class="op">;</span></span>
<span id="cb1-430"><a href="#cb1-430" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (citation<span class="op">.</span><span class="at">citationMouseLeave</span>) citation<span class="op">.</span><span class="fu">removeEventListener</span>(<span class="st">&quot;mouseleave&quot;</span><span class="op">,</span> citation<span class="op">.</span><span class="at">citationMouseLeave</span>)<span class="op">;</span></span>
<span id="cb1-431"><a href="#cb1-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-432"><a href="#cb1-432" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Bind events.</span></span>
<span id="cb1-433"><a href="#cb1-433" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> notesForCitation <span class="op">=</span> <span class="fu">allNotesForCitation</span>(citation)<span class="op">;</span></span>
<span id="cb1-434"><a href="#cb1-434" aria-hidden="true" tabindex="-1"></a>        citation<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;mouseenter&quot;</span><span class="op">,</span> citation<span class="op">.</span><span class="at">citationMouseEnter</span> <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-435"><a href="#cb1-435" aria-hidden="true" tabindex="-1"></a>            notesForCitation<span class="op">.</span><span class="fu">forEach</span>(note <span class="kw">=&gt;</span> {</span>
<span id="cb1-436"><a href="#cb1-436" aria-hidden="true" tabindex="-1"></a>                note<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;highlighted&quot;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb1-437"><a href="#cb1-437" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb1-438"><a href="#cb1-438" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-439"><a href="#cb1-439" aria-hidden="true" tabindex="-1"></a>        citation<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;mouseleave&quot;</span><span class="op">,</span> citation<span class="op">.</span><span class="at">citationMouseLeave</span> <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-440"><a href="#cb1-440" aria-hidden="true" tabindex="-1"></a>            notesForCitation<span class="op">.</span><span class="fu">forEach</span>(note <span class="kw">=&gt;</span> {</span>
<span id="cb1-441"><a href="#cb1-441" aria-hidden="true" tabindex="-1"></a>                note<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;highlighted&quot;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb1-442"><a href="#cb1-442" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb1-443"><a href="#cb1-443" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-444"><a href="#cb1-444" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-445"><a href="#cb1-445" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-446"><a href="#cb1-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-447"><a href="#cb1-447" aria-hidden="true" tabindex="-1"></a><span class="co">/*******************************************/</span></span>
<span id="cb1-448"><a href="#cb1-448" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Add a TOC link to the footnotes section.</span></span>
<span id="cb1-449"><a href="#cb1-449" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-450"><a href="#cb1-450" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">injectFootnotesTOCLink</span>(loadEventInfo) {</span>
<span id="cb1-451"><a href="#cb1-451" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;injectFootnotesTOCLink&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-452"><a href="#cb1-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-453"><a href="#cb1-453" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> TOCList <span class="op">=</span> loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;#TOC &gt; ul&quot;</span>)<span class="op">;</span></span>
<span id="cb1-454"><a href="#cb1-454" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (TOCList)</span>
<span id="cb1-455"><a href="#cb1-455" aria-hidden="true" tabindex="-1"></a>        TOCList<span class="op">.</span><span class="fu">insertAdjacentHTML</span>(<span class="st">&quot;beforeend&quot;</span><span class="op">,</span> <span class="vs">`&lt;li&gt;&lt;a href=&quot;#footnotes&quot;&gt;&lt;span&gt;Footnotes&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;</span><span class="sc">\n</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb1-456"><a href="#cb1-456" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-457"><a href="#cb1-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-458"><a href="#cb1-458" aria-hidden="true" tabindex="-1"></a><span class="co">/**************************************************************/</span></span>
<span id="cb1-459"><a href="#cb1-459" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Add content load handlers for processing footnotes section.</span></span>
<span id="cb1-460"><a href="#cb1-460" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-461"><a href="#cb1-461" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> GW<span class="op">.</span><span class="at">rewriteFunctions</span><span class="op">.</span><span class="at">processFootnotes</span> <span class="op">=</span> (info) <span class="kw">=&gt;</span> {</span>
<span id="cb1-462"><a href="#cb1-462" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;GW.rewriteFunctions.processFootnotes&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-463"><a href="#cb1-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-464"><a href="#cb1-464" aria-hidden="true" tabindex="-1"></a>    <span class="fu">identifyFootnotesSection</span>(info)<span class="op">;</span></span>
<span id="cb1-465"><a href="#cb1-465" aria-hidden="true" tabindex="-1"></a>    <span class="fu">injectFootnoteSectionSelfLink</span>(info)<span class="op">;</span></span>
<span id="cb1-466"><a href="#cb1-466" aria-hidden="true" tabindex="-1"></a>    <span class="fu">injectFootnoteSelfLinks</span>(info)<span class="op">;</span></span>
<span id="cb1-467"><a href="#cb1-467" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">phase</span><span class="op">:</span> <span class="st">&quot;rewrite&quot;</span><span class="op">,</span> <span class="dt">condition</span><span class="op">:</span> (info) <span class="kw">=&gt;</span> (info<span class="op">.</span><span class="at">needsRewrite</span> <span class="op">&amp;&amp;</span> info<span class="op">.</span><span class="at">isFullPage</span>) })<span class="op">;</span></span>
<span id="cb1-468"><a href="#cb1-468" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> GW<span class="op">.</span><span class="at">rewriteFunctions</span><span class="op">.</span><span class="at">injectFootnotesTOCLink</span> <span class="op">=</span> (info) <span class="kw">=&gt;</span> {</span>
<span id="cb1-469"><a href="#cb1-469" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;GW.rewriteFunctions.injectFootnotesTOCLink&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-470"><a href="#cb1-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-471"><a href="#cb1-471" aria-hidden="true" tabindex="-1"></a>    <span class="fu">injectFootnotesTOCLink</span>(info)<span class="op">;</span></span>
<span id="cb1-472"><a href="#cb1-472" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">phase</span><span class="op">:</span> <span class="st">&quot;rewrite&quot;</span><span class="op">,</span> <span class="dt">condition</span><span class="op">:</span> (info) <span class="kw">=&gt;</span> info<span class="op">.</span><span class="at">isMainDocument</span> })<span class="op">;</span></span>
<span id="cb1-473"><a href="#cb1-473" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> GW<span class="op">.</span><span class="at">rewriteFunctions</span><span class="op">.</span><span class="at">processCitations</span> <span class="op">=</span> (info) <span class="kw">=&gt;</span> {</span>
<span id="cb1-474"><a href="#cb1-474" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;GW.rewriteFunctions.processCitations&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-475"><a href="#cb1-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-476"><a href="#cb1-476" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bindNoteHighlightEventsToCitations</span>(info)<span class="op">;</span></span>
<span id="cb1-477"><a href="#cb1-477" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">phase</span><span class="op">:</span> <span class="st">&quot;eventListeners&quot;</span> })<span class="op">;</span></span>
<span id="cb1-478"><a href="#cb1-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-479"><a href="#cb1-479" aria-hidden="true" tabindex="-1"></a><span class="co">/*********/</span></span>
<span id="cb1-480"><a href="#cb1-480" aria-hidden="true" tabindex="-1"></a><span class="co">/* LINKS */</span></span>
<span id="cb1-481"><a href="#cb1-481" aria-hidden="true" tabindex="-1"></a><span class="co">/*********/</span></span>
<span id="cb1-482"><a href="#cb1-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-483"><a href="#cb1-483" aria-hidden="true" tabindex="-1"></a><span class="co">/********************************************************************/</span></span>
<span id="cb1-484"><a href="#cb1-484" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Designate self-links (a.k.a. anchorlinks) and local links (a.k.a.</span></span>
<span id="cb1-485"><a href="#cb1-485" aria-hidden="true" tabindex="-1"></a><span class="co">    within-site links) as such.</span></span>
<span id="cb1-486"><a href="#cb1-486" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-487"><a href="#cb1-487" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addSpecialLinkClasses</span>(loadEventInfo) {</span>
<span id="cb1-488"><a href="#cb1-488" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;addSpecialLinkClasses&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-489"><a href="#cb1-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-490"><a href="#cb1-490" aria-hidden="true" tabindex="-1"></a>    loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;.markdownBody a[href]&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(link <span class="kw">=&gt;</span> {</span>
<span id="cb1-491"><a href="#cb1-491" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (   link<span class="op">.</span><span class="at">hostname</span> <span class="op">!=</span> location<span class="op">.</span><span class="at">hostname</span></span>
<span id="cb1-492"><a href="#cb1-492" aria-hidden="true" tabindex="-1"></a>            <span class="op">||</span> link<span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;h1, h2, h3, h4, h5, h6&quot;</span>)</span>
<span id="cb1-493"><a href="#cb1-493" aria-hidden="true" tabindex="-1"></a>            <span class="op">||</span> link<span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;.section-self-link, .footnote-ref, .footnote-back, .footnote-self-link, .sidenote-self-link&quot;</span>))</span>
<span id="cb1-494"><a href="#cb1-494" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb1-495"><a href="#cb1-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-496"><a href="#cb1-496" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (   loadEventInfo<span class="op">.</span><span class="at">location</span></span>
<span id="cb1-497"><a href="#cb1-497" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;&amp;</span> link<span class="op">.</span><span class="at">pathname</span> <span class="op">==</span> loadEventInfo<span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span></span>
<span id="cb1-498"><a href="#cb1-498" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;&amp;</span> (   loadEventInfo<span class="op">.</span><span class="at">document</span> <span class="op">==</span> Extracts<span class="op">.</span><span class="at">rootDocument</span></span>
<span id="cb1-499"><a href="#cb1-499" aria-hidden="true" tabindex="-1"></a>                <span class="op">||</span> loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;.popframe&quot;</span>)<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&quot;local-transclude&quot;</span>))) {</span>
<span id="cb1-500"><a href="#cb1-500" aria-hidden="true" tabindex="-1"></a>            link<span class="op">.</span><span class="fu">swapClasses</span>([ <span class="st">&quot;link-self&quot;</span><span class="op">,</span> <span class="st">&quot;link-local&quot;</span> ]<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb1-501"><a href="#cb1-501" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (link<span class="op">.</span><span class="at">pathname</span><span class="op">.</span><span class="fu">substr</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">match</span>(<span class="ss">/</span><span class="sc">[\.]</span><span class="ss">/</span>) <span class="op">==</span> <span class="kw">null</span>) {</span>
<span id="cb1-502"><a href="#cb1-502" aria-hidden="true" tabindex="-1"></a>            link<span class="op">.</span><span class="fu">swapClasses</span>([ <span class="st">&quot;link-self&quot;</span><span class="op">,</span> <span class="st">&quot;link-local&quot;</span> ]<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-503"><a href="#cb1-503" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-504"><a href="#cb1-504" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-505"><a href="#cb1-505" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-506"><a href="#cb1-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-507"><a href="#cb1-507" aria-hidden="true" tabindex="-1"></a><span class="co">/*****************************************************************************/</span></span>
<span id="cb1-508"><a href="#cb1-508" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Directional navigation links on self-links: for each self-link like</span></span>
<span id="cb1-509"><a href="#cb1-509" aria-hidden="true" tabindex="-1"></a><span class="co">    “see [later](#later-identifier)”, find the linked identifier, whether it’s</span></span>
<span id="cb1-510"><a href="#cb1-510" aria-hidden="true" tabindex="-1"></a><span class="co">    before or after, and if it is before/previously, annotate the self-link</span></span>
<span id="cb1-511"><a href="#cb1-511" aria-hidden="true" tabindex="-1"></a><span class="co">    with ‘↑’ and if after/later, ‘↓’. This helps the reader know if it’s a</span></span>
<span id="cb1-512"><a href="#cb1-512" aria-hidden="true" tabindex="-1"></a><span class="co">    backwards link to a identifier already read, or an unread identifier.</span></span>
<span id="cb1-513"><a href="#cb1-513" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-514"><a href="#cb1-514" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">directionalizeAnchorLinks</span>(loadEventInfo) {</span>
<span id="cb1-515"><a href="#cb1-515" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;directionalizeAnchorLinks&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-516"><a href="#cb1-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-517"><a href="#cb1-517" aria-hidden="true" tabindex="-1"></a>    loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;a.link-self&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(identifierLink <span class="kw">=&gt;</span> {</span>
<span id="cb1-518"><a href="#cb1-518" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span>identifierLink<span class="op">.</span><span class="at">hash</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb1-519"><a href="#cb1-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-520"><a href="#cb1-520" aria-hidden="true" tabindex="-1"></a>        target <span class="op">=</span> loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="pp">decodeURIComponent</span>(identifierLink<span class="op">.</span><span class="at">hash</span>))<span class="op">;</span></span>
<span id="cb1-521"><a href="#cb1-521" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span>target) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb1-522"><a href="#cb1-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-523"><a href="#cb1-523" aria-hidden="true" tabindex="-1"></a>        identifierLink<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(</span>
<span id="cb1-524"><a href="#cb1-524" aria-hidden="true" tabindex="-1"></a>            identifierLink<span class="op">.</span><span class="fu">compareDocumentPosition</span>(target) <span class="op">==</span> <span class="bu">Node</span><span class="op">.</span><span class="at">DOCUMENT_POSITION_FOLLOWING</span></span>
<span id="cb1-525"><a href="#cb1-525" aria-hidden="true" tabindex="-1"></a>            <span class="op">?</span> <span class="st">&#39;identifier-link-down&#39;</span></span>
<span id="cb1-526"><a href="#cb1-526" aria-hidden="true" tabindex="-1"></a>            <span class="op">:</span> <span class="st">&#39;identifier-link-up&#39;</span></span>
<span id="cb1-527"><a href="#cb1-527" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb1-528"><a href="#cb1-528" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-529"><a href="#cb1-529" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-530"><a href="#cb1-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-531"><a href="#cb1-531" aria-hidden="true" tabindex="-1"></a><span class="co">/************************************************/</span></span>
<span id="cb1-532"><a href="#cb1-532" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Add content load handler for link processing.</span></span>
<span id="cb1-533"><a href="#cb1-533" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-534"><a href="#cb1-534" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> GW<span class="op">.</span><span class="at">rewriteFunctions</span><span class="op">.</span><span class="at">processLinks</span> <span class="op">=</span> (info) <span class="kw">=&gt;</span> {</span>
<span id="cb1-535"><a href="#cb1-535" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;GW.rewriteFunctions.processLinks&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-536"><a href="#cb1-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-537"><a href="#cb1-537" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addSpecialLinkClasses</span>(info)<span class="op">;</span></span>
<span id="cb1-538"><a href="#cb1-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-539"><a href="#cb1-539" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (info<span class="op">.</span><span class="at">needsRewrite</span>) {</span>
<span id="cb1-540"><a href="#cb1-540" aria-hidden="true" tabindex="-1"></a>        <span class="fu">directionalizeAnchorLinks</span>(info)<span class="op">;</span></span>
<span id="cb1-541"><a href="#cb1-541" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-542"><a href="#cb1-542" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">phase</span><span class="op">:</span> <span class="st">&quot;rewrite&quot;</span> })<span class="op">;</span></span>
<span id="cb1-543"><a href="#cb1-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-544"><a href="#cb1-544" aria-hidden="true" tabindex="-1"></a><span class="co">/*****************/</span></span>
<span id="cb1-545"><a href="#cb1-545" aria-hidden="true" tabindex="-1"></a><span class="co">/* PAGE METADATA */</span></span>
<span id="cb1-546"><a href="#cb1-546" aria-hidden="true" tabindex="-1"></a><span class="co">/*****************/</span></span>
<span id="cb1-547"><a href="#cb1-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-548"><a href="#cb1-548" aria-hidden="true" tabindex="-1"></a><span class="co">/********************************************************************/</span></span>
<span id="cb1-549"><a href="#cb1-549" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Add ‘markdownBody’ class to #page-metadata, for styling purposes.</span></span>
<span id="cb1-550"><a href="#cb1-550" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-551"><a href="#cb1-551" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">fixPageMetadataClass</span>(loadEventInfo) {</span>
<span id="cb1-552"><a href="#cb1-552" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;fixPageMetadataClass&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-553"><a href="#cb1-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-554"><a href="#cb1-554" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> pageMetadataSection <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;#page-metadata&quot;</span>)<span class="op">;</span></span>
<span id="cb1-555"><a href="#cb1-555" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (pageMetadataSection)</span>
<span id="cb1-556"><a href="#cb1-556" aria-hidden="true" tabindex="-1"></a>        pageMetadataSection<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&quot;markdownBody&quot;</span>)<span class="op">;</span></span>
<span id="cb1-557"><a href="#cb1-557" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-558"><a href="#cb1-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-559"><a href="#cb1-559" aria-hidden="true" tabindex="-1"></a><span class="co">/*****************************************************************/</span></span>
<span id="cb1-560"><a href="#cb1-560" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Add content load handler for processing page metadata section.</span></span>
<span id="cb1-561"><a href="#cb1-561" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-562"><a href="#cb1-562" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> GW<span class="op">.</span><span class="at">rewriteFunctions</span><span class="op">.</span><span class="at">processPageMetadata</span> <span class="op">=</span> (info) <span class="kw">=&gt;</span> {</span>
<span id="cb1-563"><a href="#cb1-563" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;GW.rewriteFunctions.processPageMetadata&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-564"><a href="#cb1-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-565"><a href="#cb1-565" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fixPageMetadataClass</span>(info)<span class="op">;</span></span>
<span id="cb1-566"><a href="#cb1-566" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">phase</span><span class="op">:</span> <span class="st">&quot;&gt;rewrite&quot;</span><span class="op">,</span> <span class="dt">condition</span><span class="op">:</span> (info) <span class="kw">=&gt;</span> info<span class="op">.</span><span class="at">isMainDocument</span> })<span class="op">;</span></span>
<span id="cb1-567"><a href="#cb1-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-568"><a href="#cb1-568" aria-hidden="true" tabindex="-1"></a><span class="co">/*********/</span></span>
<span id="cb1-569"><a href="#cb1-569" aria-hidden="true" tabindex="-1"></a><span class="co">/* MISC. */</span></span>
<span id="cb1-570"><a href="#cb1-570" aria-hidden="true" tabindex="-1"></a><span class="co">/*********/</span></span>
<span id="cb1-571"><a href="#cb1-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-572"><a href="#cb1-572" aria-hidden="true" tabindex="-1"></a><span class="co">/***************************************************************************/</span></span>
<span id="cb1-573"><a href="#cb1-573" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Clean up image alt-text. (Shouldn’t matter, because all image URLs work,</span></span>
<span id="cb1-574"><a href="#cb1-574" aria-hidden="true" tabindex="-1"></a><span class="co">    right? Yeah, right...)</span></span>
<span id="cb1-575"><a href="#cb1-575" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-576"><a href="#cb1-576" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">cleanUpImageAltText</span>(loadEventInfo) {</span>
<span id="cb1-577"><a href="#cb1-577" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;cleanUpImageAltText&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-578"><a href="#cb1-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-579"><a href="#cb1-579" aria-hidden="true" tabindex="-1"></a>    loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;img[alt]&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(image <span class="kw">=&gt;</span> {</span>
<span id="cb1-580"><a href="#cb1-580" aria-hidden="true" tabindex="-1"></a>        image<span class="op">.</span><span class="at">alt</span> <span class="op">=</span> <span class="pp">decodeURIComponent</span>(image<span class="op">.</span><span class="at">alt</span><span class="op">.</span><span class="fu">replace</span>(<span class="ss">/%</span><span class="sc">(?</span><span class="ss">!</span><span class="sc">[A-Fa-f0-9]{2})</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&quot;%25&quot;</span>))<span class="op">;</span></span>
<span id="cb1-581"><a href="#cb1-581" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-582"><a href="#cb1-582" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-583"><a href="#cb1-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-584"><a href="#cb1-584" aria-hidden="true" tabindex="-1"></a><span class="co">/**************************************************************/</span></span>
<span id="cb1-585"><a href="#cb1-585" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Add content load handler for doing miscellaneous rewriting.</span></span>
<span id="cb1-586"><a href="#cb1-586" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-587"><a href="#cb1-587" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> GW<span class="op">.</span><span class="at">rewriteFunctions</span><span class="op">.</span><span class="at">processMiscellaneousRewrites</span> <span class="op">=</span> (info) <span class="kw">=&gt;</span> {</span>
<span id="cb1-588"><a href="#cb1-588" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;GW.rewriteFunctions.processMiscellaneousRewrites&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-589"><a href="#cb1-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-590"><a href="#cb1-590" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cleanUpImageAltText</span>(info)<span class="op">;</span></span>
<span id="cb1-591"><a href="#cb1-591" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">phase</span><span class="op">:</span> <span class="st">&quot;rewrite&quot;</span><span class="op">,</span> <span class="dt">condition</span><span class="op">:</span> (info) <span class="kw">=&gt;</span> info<span class="op">.</span><span class="at">needsRewrite</span> })<span class="op">;</span></span>
<span id="cb1-592"><a href="#cb1-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-593"><a href="#cb1-593" aria-hidden="true" tabindex="-1"></a><span class="co">/*************/</span></span>
<span id="cb1-594"><a href="#cb1-594" aria-hidden="true" tabindex="-1"></a><span class="co">/* DROP CAPS */</span></span>
<span id="cb1-595"><a href="#cb1-595" aria-hidden="true" tabindex="-1"></a><span class="co">/*************/</span></span>
<span id="cb1-596"><a href="#cb1-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-597"><a href="#cb1-597" aria-hidden="true" tabindex="-1"></a><span class="co">/*******************************************************/</span></span>
<span id="cb1-598"><a href="#cb1-598" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Apply classes to blocks that should have a drop cap.</span></span>
<span id="cb1-599"><a href="#cb1-599" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-600"><a href="#cb1-600" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">applyDropCapsClasses</span>(loadEventInfo) {</span>
<span id="cb1-601"><a href="#cb1-601" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;applyDropCapsClasses&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-602"><a href="#cb1-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-603"><a href="#cb1-603" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Add ‘drop-cap-’ class to requisite blocks.</span></span>
<span id="cb1-604"><a href="#cb1-604" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> dropCapBlocksSelector <span class="op">=</span> <span class="st">&quot;.markdownBody &gt; p:first-child, .markdownBody &gt; .epigraph:first-child + p, .markdownBody .abstract + p&quot;</span><span class="op">;</span></span>
<span id="cb1-605"><a href="#cb1-605" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> dropCapClass <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;body&quot;</span>)<span class="op">.</span><span class="at">classList</span>)<span class="op">.</span><span class="fu">find</span>(cssClass <span class="kw">=&gt;</span> cssClass<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&quot;drop-caps-&quot;</span>))<span class="op">;</span></span>
<span id="cb1-606"><a href="#cb1-606" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (dropCapClass) {</span>
<span id="cb1-607"><a href="#cb1-607" aria-hidden="true" tabindex="-1"></a>        dropCapClass <span class="op">=</span> dropCapClass<span class="op">.</span><span class="fu">replace</span>(<span class="st">&quot;-caps-&quot;</span><span class="op">,</span> <span class="st">&quot;-cap-&quot;</span>)<span class="op">;</span></span>
<span id="cb1-608"><a href="#cb1-608" aria-hidden="true" tabindex="-1"></a>        loadEventInfo<span class="op">.</span><span class="at">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(dropCapBlocksSelector)<span class="op">.</span><span class="fu">forEach</span>(dropCapBlock <span class="kw">=&gt;</span> {</span>
<span id="cb1-609"><a href="#cb1-609" aria-hidden="true" tabindex="-1"></a>            <span class="co">/*  Only add page-global drop cap class to blocks that don’t</span></span>
<span id="cb1-610"><a href="#cb1-610" aria-hidden="true" tabindex="-1"></a><span class="co">                already have a drop cap class of their own.</span></span>
<span id="cb1-611"><a href="#cb1-611" aria-hidden="true" tabindex="-1"></a><span class="co">                */</span></span>
<span id="cb1-612"><a href="#cb1-612" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(dropCapBlock<span class="op">.</span><span class="at">classList</span>)<span class="op">.</span><span class="fu">findIndex</span>(cssClass <span class="kw">=&gt;</span> cssClass<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&quot;drop-cap-&quot;</span>)) <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb1-613"><a href="#cb1-613" aria-hidden="true" tabindex="-1"></a>                dropCapBlock<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(dropCapClass)<span class="op">;</span></span>
<span id="cb1-614"><a href="#cb1-614" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-615"><a href="#cb1-615" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-616"><a href="#cb1-616" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-617"><a href="#cb1-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-618"><a href="#cb1-618" aria-hidden="true" tabindex="-1"></a><span class="co">/******************************************/</span></span>
<span id="cb1-619"><a href="#cb1-619" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Add content load handler for drop caps.</span></span>
<span id="cb1-620"><a href="#cb1-620" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-621"><a href="#cb1-621" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> GW<span class="op">.</span><span class="at">rewriteFunctions</span><span class="op">.</span><span class="at">processDropCaps</span> <span class="op">=</span> (info) <span class="kw">=&gt;</span> {</span>
<span id="cb1-622"><a href="#cb1-622" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;GW.rewriteFunctions.processDropCaps&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-623"><a href="#cb1-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-624"><a href="#cb1-624" aria-hidden="true" tabindex="-1"></a>    <span class="fu">applyDropCapsClasses</span>(info)<span class="op">;</span></span>
<span id="cb1-625"><a href="#cb1-625" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">phase</span><span class="op">:</span> <span class="st">&quot;rewrite&quot;</span><span class="op">,</span> <span class="dt">condition</span><span class="op">:</span> (info) <span class="kw">=&gt;</span> (info<span class="op">.</span><span class="at">needsRewrite</span> <span class="op">&amp;&amp;</span> info<span class="op">.</span><span class="at">isMainDocument</span>) })<span class="op">;</span></span>
<span id="cb1-626"><a href="#cb1-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-627"><a href="#cb1-627" aria-hidden="true" tabindex="-1"></a><span class="co">/********************/</span></span>
<span id="cb1-628"><a href="#cb1-628" aria-hidden="true" tabindex="-1"></a><span class="co">/* BACK TO TOP LINK */</span></span>
<span id="cb1-629"><a href="#cb1-629" aria-hidden="true" tabindex="-1"></a><span class="co">/********************/</span></span>
<span id="cb1-630"><a href="#cb1-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-631"><a href="#cb1-631" aria-hidden="true" tabindex="-1"></a><span class="co">/***********************************************************************/</span></span>
<span id="cb1-632"><a href="#cb1-632" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Injects the “back to top” link. (Called only for the main document.)</span></span>
<span id="cb1-633"><a href="#cb1-633" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-634"><a href="#cb1-634" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">injectBackToTopLink</span>(loadEventInfo) {</span>
<span id="cb1-635"><a href="#cb1-635" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;injectBackToTopLink&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-636"><a href="#cb1-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-637"><a href="#cb1-637" aria-hidden="true" tabindex="-1"></a>    GW<span class="op">.</span><span class="at">backToTop</span> <span class="op">=</span> <span class="fu">addUIElement</span>(<span class="vs">`&lt;div id=&quot;back-to-top&quot;&gt;&lt;a href=&quot;#top&quot; tabindex=&quot;-1&quot; title=&quot;Back to top&quot;&gt;`</span> <span class="op">+</span></span>
<span id="cb1-638"><a href="#cb1-638" aria-hidden="true" tabindex="-1"></a>        <span class="vs">`&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 448 512&quot;&gt;&lt;path d=&quot;M6.1 422.3l209.4-209.4c4.7-4.7 12.3-4.7 17 0l209.4 209.4c4.7 4.7 4.7 12.3 0 17l-19.8 19.8c-4.7 4.7-12.3 4.7-17 0L224 278.4 42.9 459.1c-4.7 4.7-12.3 4.7-17 0L6.1 439.3c-4.7-4.7-4.7-12.3 0-17zm0-143l19.8 19.8c4.7 4.7 12.3 4.7 17 0L224 118.4l181.1 180.7c4.7 4.7 12.3 4.7 17 0l19.8-19.8c4.7-4.7 4.7-12.3 0-17L232.5 52.9c-4.7-4.7-12.3-4.7-17 0L6.1 262.3c-4.7 4.7-4.7 12.3 0 17z&quot;/&gt;&lt;/svg&gt;`</span></span>
<span id="cb1-639"><a href="#cb1-639" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> <span class="vs">`&lt;/a&gt;&lt;/div&gt;`</span>)<span class="op">;</span></span>
<span id="cb1-640"><a href="#cb1-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-641"><a href="#cb1-641" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  On mobile, show/hide the back-to-top link on scroll up/down.</span></span>
<span id="cb1-642"><a href="#cb1-642" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addScrollListener</span>(updateBackToTopLinkVisibility<span class="op">,</span> <span class="st">&quot;updateBackToTopLinkVisibilityScrollListener&quot;</span>)<span class="op">;</span></span>
<span id="cb1-643"><a href="#cb1-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-644"><a href="#cb1-644" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Update state immediately.</span></span>
<span id="cb1-645"><a href="#cb1-645" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateBackToTopLinkVisibility</span>()<span class="op">;</span></span>
<span id="cb1-646"><a href="#cb1-646" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-647"><a href="#cb1-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-648"><a href="#cb1-648" aria-hidden="true" tabindex="-1"></a><span class="co">/***********************************************************/</span></span>
<span id="cb1-649"><a href="#cb1-649" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Add content load handler to inject the back-to-top link.</span></span>
<span id="cb1-650"><a href="#cb1-650" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-651"><a href="#cb1-651" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> GW<span class="op">.</span><span class="at">rewriteFunctions</span><span class="op">.</span><span class="at">injectBackToTopLink</span> <span class="op">=</span> (info) <span class="kw">=&gt;</span> {</span>
<span id="cb1-652"><a href="#cb1-652" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;GW.rewriteFunctions.injectBackToTopLink&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-653"><a href="#cb1-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-654"><a href="#cb1-654" aria-hidden="true" tabindex="-1"></a>    <span class="fu">injectBackToTopLink</span>(info)<span class="op">;</span></span>
<span id="cb1-655"><a href="#cb1-655" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">phase</span><span class="op">:</span> <span class="st">&quot;rewrite&quot;</span><span class="op">,</span> <span class="dt">condition</span><span class="op">:</span> (info) <span class="kw">=&gt;</span> info<span class="op">.</span><span class="at">isMainDocument</span> })<span class="op">;</span></span>
<span id="cb1-656"><a href="#cb1-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-657"><a href="#cb1-657" aria-hidden="true" tabindex="-1"></a><span class="co">/*******************************************************************************/</span></span>
<span id="cb1-658"><a href="#cb1-658" aria-hidden="true" tabindex="-1"></a><span class="co">/*  Show/hide the back-to-top link in response to scrolling.</span></span>
<span id="cb1-659"><a href="#cb1-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-660"><a href="#cb1-660" aria-hidden="true" tabindex="-1"></a><span class="co">    Called by the ‘updateBackToTopLinkVisibilityScrollListener’ scroll listener.</span></span>
<span id="cb1-661"><a href="#cb1-661" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-662"><a href="#cb1-662" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">updateBackToTopLinkVisibility</span>(<span class="bu">event</span>) {</span>
<span id="cb1-663"><a href="#cb1-663" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;updateBackToTopLinkVisibility&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb1-664"><a href="#cb1-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-665"><a href="#cb1-665" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Show back-to-top link on ANY scroll up, or when scrolling a full page</span></span>
<span id="cb1-666"><a href="#cb1-666" aria-hidden="true" tabindex="-1"></a><span class="co">        down from the top.</span></span>
<span id="cb1-667"><a href="#cb1-667" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-668"><a href="#cb1-668" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (GW<span class="op">.</span><span class="at">scrollState</span><span class="op">.</span><span class="at">unbrokenUpScrollDistance</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">||</span> GW<span class="op">.</span><span class="at">scrollState</span><span class="op">.</span><span class="at">unbrokenDownScrollDistance</span> <span class="op">&gt;</span> <span class="bu">window</span><span class="op">.</span><span class="at">innerHeight</span>)</span>
<span id="cb1-669"><a href="#cb1-669" aria-hidden="true" tabindex="-1"></a>        GW<span class="op">.</span><span class="at">backToTop</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;hidden&quot;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb1-670"><a href="#cb1-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-671"><a href="#cb1-671" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Hide back-to-top link when scrolling to top.</span></span>
<span id="cb1-672"><a href="#cb1-672" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (GW<span class="op">.</span><span class="at">scrollState</span><span class="op">.</span><span class="at">lastScrollTop</span> <span class="op">&lt;=</span> <span class="dv">0</span>)</span>
<span id="cb1-673"><a href="#cb1-673" aria-hidden="true" tabindex="-1"></a>        GW<span class="op">.</span><span class="at">backToTop</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;hidden&quot;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb1-674"><a href="#cb1-674" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-675"><a href="#cb1-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-676"><a href="#cb1-676" aria-hidden="true" tabindex="-1"></a><span class="co">/*****************/</span></span>
<span id="cb1-677"><a href="#cb1-677" aria-hidden="true" tabindex="-1"></a><span class="co">/* </span><span class="re">END</span><span class="co"> OF LAYOUT */</span></span>
<span id="cb1-678"><a href="#cb1-678" aria-hidden="true" tabindex="-1"></a><span class="co">/*****************/</span></span>
<span id="cb1-679"><a href="#cb1-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-680"><a href="#cb1-680" aria-hidden="true" tabindex="-1"></a><span class="fu">doWhenPageLoaded</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb1-681"><a href="#cb1-681" aria-hidden="true" tabindex="-1"></a>    GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">fireEvent</span>(<span class="st">&quot;Rewrite.pageLayoutWillComplete&quot;</span>)<span class="op">;</span></span>
<span id="cb1-682"><a href="#cb1-682" aria-hidden="true" tabindex="-1"></a>    <span class="fu">requestAnimationFrame</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb1-683"><a href="#cb1-683" aria-hidden="true" tabindex="-1"></a>        GW<span class="op">.</span><span class="at">pageLayoutComplete</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb1-684"><a href="#cb1-684" aria-hidden="true" tabindex="-1"></a>        GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">fireEvent</span>(<span class="st">&quot;Rewrite.pageLayoutDidComplete&quot;</span>)<span class="op">;</span></span>
<span id="cb1-685"><a href="#cb1-685" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-686"><a href="#cb1-686" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">once</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb1-687"><a href="#cb1-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-688"><a href="#cb1-688" aria-hidden="true" tabindex="-1"></a><span class="co">/********************/</span></span>
<span id="cb1-689"><a href="#cb1-689" aria-hidden="true" tabindex="-1"></a><span class="co">/* HASH REALIGNMENT */</span></span>
<span id="cb1-690"><a href="#cb1-690" aria-hidden="true" tabindex="-1"></a><span class="co">/********************/</span></span>
<span id="cb1-691"><a href="#cb1-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-692"><a href="#cb1-692" aria-hidden="true" tabindex="-1"></a><span class="co">/*  This is necessary to defeat a bug where if the page is loaded with the URL</span></span>
<span id="cb1-693"><a href="#cb1-693" aria-hidden="true" tabindex="-1"></a><span class="co">    hash targeting some element, the element does not match the :target CSS</span></span>
<span id="cb1-694"><a href="#cb1-694" aria-hidden="true" tabindex="-1"></a><span class="co">    pseudo-class.</span></span>
<span id="cb1-695"><a href="#cb1-695" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb1-696"><a href="#cb1-696" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">realignHash</span>() {</span>
<span id="cb1-697"><a href="#cb1-697" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GWLog</span>(<span class="st">&quot;realignHash&quot;</span><span class="op">,</span> <span class="st">&quot;rewrite.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-698"><a href="#cb1-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-699"><a href="#cb1-699" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Chrome’s fancy new “scroll to text fragment”. Deal with it in Firefox.</span></span>
<span id="cb1-700"><a href="#cb1-700" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (GW<span class="op">.</span><span class="fu">isFirefox</span>()) {</span>
<span id="cb1-701"><a href="#cb1-701" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (location<span class="op">.</span><span class="at">hash</span><span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&quot;#:~:&quot;</span>)) {</span>
<span id="cb1-702"><a href="#cb1-702" aria-hidden="true" tabindex="-1"></a>            GW<span class="op">.</span><span class="at">hashRealignValue</span> <span class="op">=</span> GW<span class="op">.</span><span class="at">hashRealignValue</span> <span class="op">||</span> <span class="st">&quot;#&quot;</span><span class="op">;</span></span>
<span id="cb1-703"><a href="#cb1-703" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (location<span class="op">.</span><span class="at">hash</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">&quot;:~:&quot;</span>)) {</span>
<span id="cb1-704"><a href="#cb1-704" aria-hidden="true" tabindex="-1"></a>            GW<span class="op">.</span><span class="at">hashRealignValue</span> <span class="op">=</span> GW<span class="op">.</span><span class="at">hashRealignValue</span> <span class="op">||</span> location<span class="op">.</span><span class="at">hash</span><span class="op">.</span><span class="fu">replace</span>(<span class="ss">/:~:.</span><span class="sc">*$</span><span class="ss">/</span><span class="op">,</span> <span class="st">&quot;&quot;</span>)<span class="op">;</span></span>
<span id="cb1-705"><a href="#cb1-705" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-706"><a href="#cb1-706" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-707"><a href="#cb1-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-708"><a href="#cb1-708" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> hash <span class="op">=</span> GW<span class="op">.</span><span class="at">hashRealignValue</span> <span class="op">||</span> location<span class="op">.</span><span class="at">hash</span><span class="op">;</span></span>
<span id="cb1-709"><a href="#cb1-709" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (hash <span class="op">&gt;</span> <span class="st">&quot;&quot;</span>) {</span>
<span id="cb1-710"><a href="#cb1-710" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Strip hash.</span></span>
<span id="cb1-711"><a href="#cb1-711" aria-hidden="true" tabindex="-1"></a>        history<span class="op">.</span><span class="fu">replaceState</span>(<span class="kw">null</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="st">&quot;#&quot;</span>)<span class="op">;</span></span>
<span id="cb1-712"><a href="#cb1-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-713"><a href="#cb1-713" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Reset hash.</span></span>
<span id="cb1-714"><a href="#cb1-714" aria-hidden="true" tabindex="-1"></a>        location<span class="op">.</span><span class="at">hash</span> <span class="op">=</span> hash<span class="op">;</span></span>
<span id="cb1-715"><a href="#cb1-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-716"><a href="#cb1-716" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Prevent redundant realignment.</span></span>
<span id="cb1-717"><a href="#cb1-717" aria-hidden="true" tabindex="-1"></a>        GW<span class="op">.</span><span class="at">hashRealignValue</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb1-718"><a href="#cb1-718" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-719"><a href="#cb1-719" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-720"><a href="#cb1-720" aria-hidden="true" tabindex="-1"></a><span class="fu">doWhenDOMContentLoaded</span>(realignHash)<span class="op">;</span></span>
<span id="cb1-721"><a href="#cb1-721" aria-hidden="true" tabindex="-1"></a><span class="fu">doWhenPageLoaded</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb1-722"><a href="#cb1-722" aria-hidden="true" tabindex="-1"></a>    <span class="fu">requestAnimationFrame</span>(realignHash)<span class="op">;</span></span>
<span id="cb1-723"><a href="#cb1-723" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb1-724"><a href="#cb1-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-725"><a href="#cb1-725" aria-hidden="true" tabindex="-1"></a><span class="co">/*! instant.page v5.1.0 - (C) 2019-2020 Alexandre Dieulot - https://instant.page/license */</span></span>
<span id="cb1-726"><a href="#cb1-726" aria-hidden="true" tabindex="-1"></a><span class="co">/* Settings: &#39;prefetch&#39; (loads HTML of target) after 800ms hover (desktop) or mouse-down-click (mobile); </span><span class="al">TODO</span><span class="co">: left in logging for testing during experiment */</span></span>
<span id="cb1-727"><a href="#cb1-727" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> t<span class="op">,</span>e<span class="op">;</span><span class="kw">const</span> n<span class="op">=</span><span class="kw">new</span> <span class="bu">Set</span><span class="op">,</span>o<span class="op">=</span><span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&quot;link&quot;</span>)<span class="op">,</span>z<span class="op">=</span>o<span class="op">.</span><span class="at">relList</span><span class="op">&amp;&amp;</span>o<span class="op">.</span><span class="at">relList</span><span class="op">.</span><span class="at">supports</span><span class="op">&amp;&amp;</span>o<span class="op">.</span><span class="at">relList</span><span class="op">.</span><span class="fu">supports</span>(<span class="st">&quot;prefetch&quot;</span>)<span class="op">&amp;&amp;</span><span class="bu">window</span><span class="op">.</span><span class="at">IntersectionObserver</span><span class="op">&amp;&amp;</span><span class="st">&quot;isIntersecting&quot;</span>in IntersectionObserverEntry<span class="op">.</span><span class="at">prototype</span><span class="op">,</span>s<span class="op">=</span><span class="st">&quot;instantAllowQueryString&quot;</span>in <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">dataset</span><span class="op">,</span>a<span class="op">=</span><span class="kw">true</span><span class="op">,</span>r<span class="op">=</span><span class="st">&quot;instantWhitelist&quot;</span>in <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">dataset</span><span class="op">,</span>c<span class="op">=</span><span class="st">&quot;instantMousedownShortcut&quot;</span>in <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">dataset</span><span class="op">,</span>d<span class="op">=</span><span class="dv">1111</span><span class="op">;</span><span class="kw">let</span> l<span class="op">=</span><span class="dv">800</span><span class="op">,</span>u<span class="op">=!</span><span class="dv">1</span><span class="op">,</span>f<span class="op">=!</span><span class="dv">1</span><span class="op">,</span>m<span class="op">=!</span><span class="dv">1</span><span class="op">;</span><span class="cf">if</span>(<span class="st">&quot;instantIntensity&quot;</span>in <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">dataset</span>){<span class="kw">const</span> t<span class="op">=</span><span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">instantIntensity</span><span class="op">;</span><span class="cf">if</span>(<span class="st">&quot;mousedown&quot;</span><span class="op">==</span>t<span class="op">.</span><span class="fu">substr</span>(<span class="dv">0</span><span class="op">,</span><span class="st">&quot;mousedown&quot;</span><span class="op">.</span><span class="at">length</span>))u<span class="op">=!</span><span class="dv">0</span><span class="op">,</span><span class="st">&quot;mousedown-only&quot;</span><span class="op">==</span>t<span class="op">&amp;&amp;</span>(f<span class="op">=!</span><span class="dv">0</span>)<span class="op">;</span><span class="cf">else</span> <span class="cf">if</span>(<span class="st">&quot;viewport&quot;</span><span class="op">==</span>t<span class="op">.</span><span class="fu">substr</span>(<span class="dv">0</span><span class="op">,</span><span class="st">&quot;viewport&quot;</span><span class="op">.</span><span class="at">length</span>))<span class="bu">navigator</span><span class="op">.</span><span class="at">connection</span><span class="op">&amp;&amp;</span>(<span class="bu">navigator</span><span class="op">.</span><span class="at">connection</span><span class="op">.</span><span class="at">saveData</span><span class="op">||</span><span class="bu">navigator</span><span class="op">.</span><span class="at">connection</span><span class="op">.</span><span class="at">effectiveType</span><span class="op">&amp;&amp;</span><span class="bu">navigator</span><span class="op">.</span><span class="at">connection</span><span class="op">.</span><span class="at">effectiveType</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">&quot;2g&quot;</span>))<span class="op">||</span>(<span class="st">&quot;viewport&quot;</span><span class="op">==</span>t<span class="op">?</span><span class="bu">document</span><span class="op">.</span><span class="at">documentElement</span><span class="op">.</span><span class="at">clientWidth</span><span class="op">*</span><span class="bu">document</span><span class="op">.</span><span class="at">documentElement</span><span class="op">.</span><span class="at">clientHeight</span><span class="op">&lt;</span><span class="fl">45e4</span><span class="op">&amp;&amp;</span>(m<span class="op">=!</span><span class="dv">0</span>)<span class="op">:</span><span class="st">&quot;viewport-all&quot;</span><span class="op">==</span>t<span class="op">&amp;&amp;</span>(m<span class="op">=!</span><span class="dv">0</span>))<span class="op">;</span><span class="cf">else</span>{<span class="kw">const</span> e<span class="op">=</span><span class="pp">parseInt</span>(t)<span class="op">;</span><span class="pp">isNaN</span>(e)<span class="op">||</span>(l<span class="op">=</span>e)}}<span class="cf">if</span>(z){<span class="kw">const</span> n<span class="op">=</span>{<span class="dt">capture</span><span class="op">:!</span><span class="dv">0</span><span class="op">,</span><span class="dt">passive</span><span class="op">:!</span><span class="dv">0</span>}<span class="op">;</span><span class="cf">if</span>(f<span class="op">||</span><span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;touchstart&quot;</span><span class="op">,</span><span class="kw">function</span>(t){e<span class="op">=</span><span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span><span class="kw">const</span> n<span class="op">=</span>t<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;a&quot;</span>)<span class="op">;</span><span class="cf">if</span>(<span class="op">!</span><span class="fu">h</span>(n))<span class="cf">return</span><span class="op">;</span><span class="fu">v</span>(n<span class="op">.</span><span class="at">href</span>)}<span class="op">,</span>n)<span class="op">,</span>u<span class="op">?</span>c<span class="op">||</span><span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;mousedown&quot;</span><span class="op">,</span><span class="kw">function</span>(t){<span class="kw">const</span> e<span class="op">=</span>t<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;a&quot;</span>)<span class="op">;</span><span class="cf">if</span>(<span class="op">!</span><span class="fu">h</span>(e))<span class="cf">return</span><span class="op">;</span><span class="fu">v</span>(e<span class="op">.</span><span class="at">href</span>)}<span class="op">,</span>n)<span class="op">:</span><span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;mouseover&quot;</span><span class="op">,</span><span class="kw">function</span>(n){<span class="cf">if</span>(<span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">-</span>e<span class="op">&lt;</span>d)<span class="cf">return</span><span class="op">;</span><span class="kw">const</span> o<span class="op">=</span>n<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;a&quot;</span>)<span class="op">;</span><span class="cf">if</span>(<span class="op">!</span><span class="fu">h</span>(o))<span class="cf">return</span><span class="op">;</span>o<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;mouseout&quot;</span><span class="op">,</span>p<span class="op">,</span>{<span class="dt">passive</span><span class="op">:!</span><span class="dv">0</span>})<span class="op">,</span>t<span class="op">=</span><span class="pp">setTimeout</span>(()<span class="kw">=&gt;</span>{<span class="fu">v</span>(o<span class="op">.</span><span class="at">href</span>)<span class="op">,</span>t<span class="op">=</span><span class="kw">void</span> <span class="dv">0</span>}<span class="op">,</span>l)}<span class="op">,</span>n)<span class="op">,</span>c<span class="op">&amp;&amp;</span><span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;mousedown&quot;</span><span class="op">,</span><span class="kw">function</span>(t){<span class="cf">if</span>(<span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">-</span>e<span class="op">&lt;</span>d)<span class="cf">return</span><span class="op">;</span><span class="kw">const</span> n<span class="op">=</span>t<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;a&quot;</span>)<span class="op">;</span><span class="cf">if</span>(t<span class="op">.</span><span class="at">which</span><span class="op">&gt;</span><span class="dv">1</span><span class="op">||</span>t<span class="op">.</span><span class="at">metaKey</span><span class="op">||</span>t<span class="op">.</span><span class="at">ctrlKey</span>)<span class="cf">return</span><span class="op">;</span><span class="cf">if</span>(<span class="op">!</span>n)<span class="cf">return</span><span class="op">;</span>n<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;click&quot;</span><span class="op">,</span><span class="kw">function</span>(t){<span class="dv">1337</span><span class="op">!=</span>t<span class="op">.</span><span class="at">detail</span><span class="op">&amp;&amp;</span>t<span class="op">.</span><span class="fu">preventDefault</span>()}<span class="op">,</span>{<span class="dt">capture</span><span class="op">:!</span><span class="dv">0</span><span class="op">,</span><span class="dt">passive</span><span class="op">:!</span><span class="dv">1</span><span class="op">,</span><span class="dt">once</span><span class="op">:!</span><span class="dv">0</span>})<span class="op">;</span><span class="kw">const</span> o<span class="op">=</span><span class="kw">new</span> <span class="bu">MouseEvent</span>(<span class="st">&quot;click&quot;</span><span class="op">,</span>{<span class="dt">view</span><span class="op">:</span><span class="bu">window</span><span class="op">,</span><span class="dt">bubbles</span><span class="op">:!</span><span class="dv">0</span><span class="op">,</span><span class="dt">cancelable</span><span class="op">:!</span><span class="dv">1</span><span class="op">,</span><span class="dt">detail</span><span class="op">:</span><span class="dv">1337</span>})<span class="op">;</span>n<span class="op">.</span><span class="fu">dispatchEvent</span>(o)}<span class="op">,</span>n)<span class="op">,</span>m){<span class="kw">let</span> t<span class="op">;</span>(t<span class="op">=</span><span class="bu">window</span><span class="op">.</span><span class="at">requestIdleCallback</span><span class="op">?</span>t<span class="kw">=&gt;</span>{<span class="fu">requestIdleCallback</span>(t<span class="op">,</span>{<span class="dt">timeout</span><span class="op">:</span><span class="dv">1500</span>})}<span class="op">:</span>t<span class="kw">=&gt;</span>{<span class="fu">t</span>()})(()<span class="kw">=&gt;</span>{<span class="kw">const</span> t<span class="op">=</span><span class="kw">new</span> <span class="fu">IntersectionObserver</span>(e<span class="kw">=&gt;</span>{e<span class="op">.</span><span class="fu">forEach</span>(e<span class="kw">=&gt;</span>{<span class="cf">if</span>(e<span class="op">.</span><span class="at">isIntersecting</span>){<span class="kw">const</span> n<span class="op">=</span>e<span class="op">.</span><span class="at">target</span><span class="op">;</span>t<span class="op">.</span><span class="fu">unobserve</span>(n)<span class="op">,</span><span class="fu">v</span>(n<span class="op">.</span><span class="at">href</span>)}})})<span class="op">;</span><span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;a&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(e<span class="kw">=&gt;</span>{<span class="fu">h</span>(e)<span class="op">&amp;&amp;</span>t<span class="op">.</span><span class="fu">observe</span>(e)})})}}<span class="kw">function</span> <span class="fu">p</span>(e){e<span class="op">.</span><span class="at">relatedTarget</span><span class="op">&amp;&amp;</span>e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;a&quot;</span>)<span class="op">==</span>e<span class="op">.</span><span class="at">relatedTarget</span><span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;a&quot;</span>)<span class="op">||</span>t<span class="op">&amp;&amp;</span>(<span class="pp">clearTimeout</span>(t)<span class="op">,</span>t<span class="op">=</span><span class="kw">void</span> <span class="dv">0</span>)}<span class="kw">function</span> <span class="fu">h</span>(t){<span class="cf">if</span>(t<span class="op">&amp;&amp;</span>t<span class="op">.</span><span class="at">href</span><span class="op">&amp;&amp;</span>(<span class="op">!</span>r<span class="op">||</span><span class="st">&quot;instant&quot;</span>in t<span class="op">.</span><span class="at">dataset</span>)<span class="op">&amp;&amp;</span>(a<span class="op">||</span>t<span class="op">.</span><span class="at">origin</span><span class="op">==</span>location<span class="op">.</span><span class="at">origin</span><span class="op">||</span><span class="st">&quot;instant&quot;</span>in t<span class="op">.</span><span class="at">dataset</span>)<span class="op">&amp;&amp;</span>[<span class="st">&quot;http:&quot;</span><span class="op">,</span><span class="st">&quot;https:&quot;</span>]<span class="op">.</span><span class="fu">includes</span>(t<span class="op">.</span><span class="at">protocol</span>)<span class="op">&amp;&amp;</span>(<span class="st">&quot;http:&quot;</span><span class="op">!=</span>t<span class="op">.</span><span class="at">protocol</span><span class="op">||</span><span class="st">&quot;https:&quot;</span><span class="op">!=</span>location<span class="op">.</span><span class="at">protocol</span>)<span class="op">&amp;&amp;</span>(s<span class="op">||!</span>t<span class="op">.</span><span class="at">search</span><span class="op">||</span><span class="st">&quot;instant&quot;</span>in t<span class="op">.</span><span class="at">dataset</span>)<span class="op">&amp;&amp;!</span>(t<span class="op">.</span><span class="at">hash</span><span class="op">&amp;&amp;</span>t<span class="op">.</span><span class="at">pathname</span><span class="op">+</span>t<span class="op">.</span><span class="at">search</span><span class="op">==</span>location<span class="op">.</span><span class="at">pathname</span><span class="op">+</span>location<span class="op">.</span><span class="at">search</span><span class="op">||</span><span class="st">&quot;noInstant&quot;</span>in t<span class="op">.</span><span class="at">dataset</span>))<span class="cf">return</span><span class="op">!</span><span class="dv">0</span>}<span class="kw">function</span> <span class="fu">v</span>(t){<span class="cf">if</span>(n<span class="op">.</span><span class="fu">has</span>(t))<span class="cf">return</span><span class="op">;</span><span class="kw">const</span> e<span class="op">=</span><span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&quot;link&quot;</span>)<span class="op">;</span><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Prefetched: &quot;</span><span class="op">+</span>t)<span class="op">;</span>e<span class="op">.</span><span class="at">rel</span><span class="op">=</span><span class="st">&quot;prefetch&quot;</span><span class="op">,</span>e<span class="op">.</span><span class="at">href</span><span class="op">=</span>t<span class="op">,</span><span class="bu">document</span><span class="op">.</span><span class="at">head</span><span class="op">.</span><span class="fu">appendChild</span>(e)<span class="op">,</span>n<span class="op">.</span><span class="fu">add</span>(t)}<span class="op">;</span></span>
<span id="cb1-728"><a href="#cb1-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-729"><a href="#cb1-729" aria-hidden="true" tabindex="-1"></a><span class="co">/* Broken Anchor Checking */</span></span>
<span id="cb1-730"><a href="#cb1-730" aria-hidden="true" tabindex="-1"></a><span class="co">/* If a reader loads a page and the anchor ID/hash does not exist inside the page, fire off a request to the 404 page, whose logs are reviewed manually, with the offending page+anchor ID, for correction (either fixing an outdated link somewhere on gwern.net, or adding a span/div manually to the page to make old inbound links go where they ought to). */</span></span>
<span id="cb1-731"><a href="#cb1-731" aria-hidden="true" tabindex="-1"></a><span class="co">/* Such broken anchors can reflect out of date cross-page references, or reflect incoming URLs from elsewhere on the Internet which are broken/outdated. (Within-page anchor links are checked statically at compile-time, and those errors should never exist.) */</span></span>
<span id="cb1-732"><a href="#cb1-732" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (location<span class="op">.</span><span class="at">hash</span> <span class="op">!=</span> <span class="st">&quot;&quot;</span>) {</span>
<span id="cb1-733"><a href="#cb1-733" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (<span class="kw">null</span> <span class="op">==</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(location<span class="op">.</span><span class="at">hash</span><span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;#&#39;</span>)[<span class="dv">1</span>]))</span>
<span id="cb1-734"><a href="#cb1-734" aria-hidden="true" tabindex="-1"></a>  {  brokenHashLog <span class="op">=</span> <span class="kw">new</span> <span class="fu">URL</span>(<span class="st">&quot;https://&quot;</span> <span class="op">+</span> location<span class="op">.</span><span class="at">hostname</span> <span class="op">+</span> <span class="st">&quot;/static/404.html&quot;</span> <span class="op">+</span></span>
<span id="cb1-735"><a href="#cb1-735" aria-hidden="true" tabindex="-1"></a>                                                        <span class="st">&quot;-error-&quot;</span> <span class="op">+</span></span>
<span id="cb1-736"><a href="#cb1-736" aria-hidden="true" tabindex="-1"></a>                                                        <span class="fu">fixedEncodeURIComponent</span>(location<span class="op">.</span><span class="at">pathname</span>) <span class="op">+</span></span>
<span id="cb1-737"><a href="#cb1-737" aria-hidden="true" tabindex="-1"></a>                                                        <span class="st">&quot;--&quot;</span> <span class="op">+</span></span>
<span id="cb1-738"><a href="#cb1-738" aria-hidden="true" tabindex="-1"></a>                                                        <span class="fu">fixedEncodeURIComponent</span>(location<span class="op">.</span><span class="at">hash</span><span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;#&#39;</span>)[<span class="dv">1</span>]))<span class="op">;</span></span>
<span id="cb1-739"><a href="#cb1-739" aria-hidden="true" tabindex="-1"></a>     <span class="fu">doAjax</span>({ <span class="dt">location</span><span class="op">:</span> brokenHashLog<span class="op">,</span>  <span class="dt">onSuccess</span><span class="op">:</span> (e) <span class="kw">=&gt;</span> {}<span class="op">,</span> <span class="dt">onFailure</span><span class="op">:</span> (e) <span class="kw">=&gt;</span> {} })<span class="op">;</span></span>
<span id="cb1-740"><a href="#cb1-740" aria-hidden="true" tabindex="-1"></a>     <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Reporting broken hash-anchor: &quot;</span> <span class="op">+</span> brokenHashLog)<span class="op">;</span></span>
<span id="cb1-741"><a href="#cb1-741" aria-hidden="true" tabindex="-1"></a>     }</span>
<span id="cb1-742"><a href="#cb1-742" aria-hidden="true" tabindex="-1"></a>     }</span>
<span id="cb1-743"><a href="#cb1-743" aria-hidden="true" tabindex="-1"></a><span class="co">/* Loop over internal page self-links and check that their targets exist; if they do not, report it via 404 like the broken anchors. */</span></span>
<span id="cb1-744"><a href="#cb1-744" aria-hidden="true" tabindex="-1"></a>selfLinks <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;.markdownBody a[href^=&#39;#&#39;]&quot;</span>)<span class="op">;</span></span>
<span id="cb1-745"><a href="#cb1-745" aria-hidden="true" tabindex="-1"></a>selfLinks<span class="op">.</span><span class="fu">forEach</span>(<span class="kw">function</span>(anchor) {</span>
<span id="cb1-746"><a href="#cb1-746" aria-hidden="true" tabindex="-1"></a>    anchorExists <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(anchor<span class="op">.</span><span class="at">hash</span><span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;#&#39;</span>)[<span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb1-747"><a href="#cb1-747" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">null</span> <span class="op">==</span> anchorExists) {</span>
<span id="cb1-748"><a href="#cb1-748" aria-hidden="true" tabindex="-1"></a>     brokenHashLog <span class="op">=</span> <span class="kw">new</span> <span class="fu">URL</span>(<span class="st">&quot;https://&quot;</span> <span class="op">+</span> location<span class="op">.</span><span class="at">hostname</span> <span class="op">+</span> <span class="st">&quot;/static/404.html&quot;</span> <span class="op">+</span></span>
<span id="cb1-749"><a href="#cb1-749" aria-hidden="true" tabindex="-1"></a>                                                        <span class="st">&quot;-error-&quot;</span> <span class="op">+</span></span>
<span id="cb1-750"><a href="#cb1-750" aria-hidden="true" tabindex="-1"></a>                                                        <span class="fu">fixedEncodeURIComponent</span>(anchor<span class="op">.</span><span class="at">pathname</span>) <span class="op">+</span></span>
<span id="cb1-751"><a href="#cb1-751" aria-hidden="true" tabindex="-1"></a>                                                        <span class="st">&quot;--&quot;</span> <span class="op">+</span></span>
<span id="cb1-752"><a href="#cb1-752" aria-hidden="true" tabindex="-1"></a>                                                        <span class="fu">fixedEncodeURIComponent</span>(anchor<span class="op">.</span><span class="at">hash</span><span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;#&#39;</span>)[<span class="dv">1</span>]))<span class="op">;</span></span>
<span id="cb1-753"><a href="#cb1-753" aria-hidden="true" tabindex="-1"></a>     <span class="fu">doAjax</span>({ <span class="dt">location</span><span class="op">:</span> brokenHashLog<span class="op">,</span>  <span class="dt">onSuccess</span><span class="op">:</span> (e) <span class="kw">=&gt;</span> {}<span class="op">,</span> <span class="dt">onFailure</span><span class="op">:</span> (e) <span class="kw">=&gt;</span> {} })<span class="op">;</span></span>
<span id="cb1-754"><a href="#cb1-754" aria-hidden="true" tabindex="-1"></a>     <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Reporting broken hash-anchor: &quot;</span> <span class="op">+</span> brokenHashLog)<span class="op">;</span></span>
<span id="cb1-755"><a href="#cb1-755" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-756"><a href="#cb1-756" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
