<div class="sourceCode" id="cb1"><pre class="sourceCode Javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// popups.js: standalone Javascript library for creating &#39;popups&#39; which display link metadata (typically, title/author/date/summary), for extremely convenient reference/abstract reading.</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Author: Said Achmiz, Shawn Presser (mobile &amp; Youtube support)</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Date: 2019-09-12</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">// When:</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">// license: MIT (derivative of footnotes.js, which is PD)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">// popups.js parses a HTML document and looks for &lt;a&gt; links which have the &#39;docMetadata&#39; attribute class, and the attributes &#39;data-popup-title&#39;, &#39;data-popup-author&#39;, &#39;data-popup-date&#39;, &#39;data-popup-doi&#39;, &#39;data-popup-abstract&#39;.</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">// (These attributes are expected to be populated already by the HTML document&#39;s compiler, however, they can also be done dynamically. See &#39;https://share.obormot.net/misc/gwern/wikipedia-popups.js&#39; for an example of a library which does Wikipedia-only dynamically on page loads.)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Popups are inspired by Wikipedia&#39;s augmented tooltips (originally implemented as editor-built extensions, now available to all readers via https://www.mediawiki.org/wiki/Page_Previews ). Whenever any such link is mouse-overed by the user, popups.js will pop up a large tooltip-like square with the contents of the attributes. This is particularly intended for references, where it is extremely convenient to autopopulate links such as to Arxiv.org/Biorxiv.org/Wikipedia with the link&#39;s title/author/date/abstract, so the reader can see it instantly. Links to &#39;reverse citations&#39; are provided as much as possible: links with DOIs go to a Semantic Scholar search engine query for that DOI, which prioritizes meta-analyses &amp; systematic reviews to provide context for any given paper (particularly whether it has failed to replicate or otherwise been debunked); for URLs ending in &#39;PDF&#39; which probably have Semantic Scholar entries, they go to a title search; and for all other URLs, a Google search using the obscure `link:` operator is provided.. For more details, see `LinkMetadata.hs`.</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">// On mobile, clicking on links (as opposed to hovering over links on desktop) will bring up the annotation or video; another click on it or the popup will then go to it. A click outside it de-activates it.</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">// For an example of a Hakyll library which generates annotations for Wikipedia/Biorxiv/Arxiv/PDFs/arbitrarily-defined links, see https://www.gwern.net/static/build/LinkMetadata.hs ; for a live demonstration, see the links in https://www.gwern.net/newsletter/2019/07</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>Extracts <span class="op">=</span> {</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Target containers.</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">contentContainersSelector</span><span class="op">:</span> <span class="st">&quot;.markdownBody, #TOC, #page-metadata, #sidebar&quot;</span><span class="op">,</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Targets.</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">targets</span><span class="op">:</span> {</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">targetElementsSelector</span><span class="op">:</span> <span class="st">&quot;a[href]&quot;</span><span class="op">,</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">excludedElementsSelector</span><span class="op">:</span> [</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;.section-self-link&quot;</span><span class="op">,</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;.footnote-self-link&quot;</span><span class="op">,</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;.sidenote-self-link&quot;</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        ]<span class="op">.</span><span class="fu">join</span>(<span class="st">&quot;, &quot;</span>)<span class="op">,</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">excludedContainerElementsSelector</span><span class="op">:</span> <span class="st">&quot;h1, h2, h3, h4, h5, h6&quot;</span><span class="op">,</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">testTarget</span><span class="op">:</span> (target) <span class="kw">=&gt;</span> {</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> targetTypeInfo <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">targetTypeInfo</span>(target)<span class="op">;</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (targetTypeInfo) {</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> specialTestFunction <span class="op">=</span> Extracts[<span class="vs">`testTarget_</span><span class="sc">${</span>targetTypeInfo<span class="op">.</span><span class="at">typeName</span><span class="sc">}</span><span class="vs">`</span>]</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (specialTestFunction <span class="op">&amp;&amp;</span> <span class="fu">specialTestFunction</span>(target) <span class="op">==</span> <span class="kw">false</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>                <span class="co">//  Do not allow pop-frames to spawn themselves.</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> containingPopFrame <span class="op">=</span> target<span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;.popframe&quot;</span>)<span class="op">;</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (containingPopFrame <span class="op">&amp;&amp;</span> Extracts<span class="op">.</span><span class="fu">targetsMatch</span>(containingPopFrame<span class="op">.</span><span class="at">spawningTarget</span><span class="op">,</span> target))</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (targetTypeInfo<span class="op">.</span><span class="at">targetClasses</span>)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>                    target<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="op">...</span>(targetTypeInfo<span class="op">.</span><span class="at">targetClasses</span><span class="op">.</span><span class="fu">split</span>(<span class="st">&quot; &quot;</span>)))<span class="op">;</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Misc. configuration.</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">server404PageTitles</span><span class="op">:</span> [</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;404 Not Found&quot;</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>    <span class="dt">pageTitleRegexp</span><span class="op">:</span> <span class="ss">/</span><span class="sc">^(</span><span class="ss">.</span><span class="sc">+?)</span><span class="ss"> · Gwern</span><span class="sc">\.</span><span class="ss">net</span><span class="sc">$</span><span class="ss">/</span><span class="op">,</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    <span class="dt">rootDocument</span><span class="op">:</span> <span class="bu">document</span><span class="op">.</span><span class="at">firstElementChild</span><span class="op">,</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">/******************/</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Infrastructure.</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    <span class="dt">popFrameProviderName</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    <span class="dt">popFrameProvider</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">/***********/</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  General.</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>    <span class="dt">removeTargetsWithin</span><span class="op">:</span> (container) <span class="kw">=&gt;</span> {</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.removeTargetsWithin&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Target restore function (same for popups and popins).</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> restoreTarget <span class="op">=</span> (target) <span class="kw">=&gt;</span> {</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>            <span class="co">//  Restore title attribute, if any.</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (target<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">attributeTitle</span>) {</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>                target<span class="op">.</span><span class="at">title</span> <span class="op">=</span> target<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">attributeTitle</span><span class="op">;</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>                target<span class="op">.</span><span class="fu">removeAttribute</span>(<span class="st">&quot;data-attribute-title&quot;</span>)<span class="op">;</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>            target<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&quot;has-content&quot;</span><span class="op">,</span> <span class="st">&quot;has-annotation&quot;</span>)<span class="op">;</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>        Extracts<span class="op">.</span><span class="at">popFrameProvider</span><span class="op">.</span><span class="fu">removeTargetsWithin</span>(container<span class="op">,</span> Extracts<span class="op">.</span><span class="at">targets</span><span class="op">,</span> restoreTarget)<span class="op">;</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>    <span class="dt">cleanup</span><span class="op">:</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.cleanup&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Unbind event listeners, restore targets, and remove popups.</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(Extracts<span class="op">.</span><span class="at">contentContainersSelector</span>)<span class="op">.</span><span class="fu">forEach</span>(container <span class="kw">=&gt;</span> {</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>            Extracts<span class="op">.</span><span class="fu">removeTargetsWithin</span>(container)<span class="op">;</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Remove content load event handlers.</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>        [ Extracts<span class="op">.</span><span class="at">processTargetsOnContentLoad</span><span class="op">,</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>          Extracts<span class="op">.</span><span class="at">setUpAnnotationLoadEvent</span><span class="op">,</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>          ]<span class="op">.</span><span class="fu">forEach</span>(handler <span class="kw">=&gt;</span> GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">removeHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> handler))<span class="op">;</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (Extracts<span class="op">.</span><span class="at">popFrameProvider</span> <span class="op">==</span> Popups) {</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>            <span class="co">//  Remove “popups disabled” icon/button, if present.</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (Extracts<span class="op">.</span><span class="at">popupOptionsEnabled</span>)</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>                Extracts<span class="op">.</span><span class="fu">removePopupsDisabledShowPopupOptionsDialogButton</span>()<span class="op">;</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Fire cleanup-complete event.</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>        GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">fireEvent</span>(<span class="st">&quot;Extracts.cleanupDidComplete&quot;</span>)<span class="op">;</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>    <span class="dt">addTargetsWithin</span><span class="op">:</span> (container) <span class="kw">=&gt;</span> {</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.addTargetsWithin&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (Extracts<span class="op">.</span><span class="at">popFrameProvider</span> <span class="op">==</span> Popups) {</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>            Popups<span class="op">.</span><span class="fu">addTargetsWithin</span>(container<span class="op">,</span> Extracts<span class="op">.</span><span class="at">targets</span><span class="op">,</span> Extracts<span class="op">.</span><span class="at">preparePopup</span><span class="op">,</span> Extracts<span class="op">.</span><span class="at">preparePopupTarget</span>)<span class="op">;</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (Extracts<span class="op">.</span><span class="at">popFrameProvider</span> <span class="op">==</span> Popins) {</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>            Popins<span class="op">.</span><span class="fu">addTargetsWithin</span>(container<span class="op">,</span> Extracts<span class="op">.</span><span class="at">targets</span><span class="op">,</span> Extracts<span class="op">.</span><span class="at">preparePopin</span>)<span class="op">;</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>    <span class="dt">setup</span><span class="op">:</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.setup&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Set service provider object.</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>        Extracts<span class="op">.</span><span class="at">popFrameProvider</span> <span class="op">=</span> <span class="bu">window</span>[Extracts<span class="op">.</span><span class="at">popFrameProviderName</span>]<span class="op">;</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (Extracts<span class="op">.</span><span class="at">popFrameProvider</span> <span class="op">==</span> Popups) {</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>            <span class="fu">GWLog</span>(<span class="st">&quot;Setting up for popups.&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="op">!</span>Extracts<span class="op">.</span><span class="fu">popupsEnabled</span>()) {</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (Extracts<span class="op">.</span><span class="at">popupOptionsEnabled</span>) {</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>                    <span class="co">//  Inject “popups disabled” icon/button.</span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>                    Extracts<span class="op">.</span><span class="fu">injectPopupsDisabledShowPopupOptionsDialogButton</span>()<span class="op">;</span></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span><span class="op">;</span></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>            <span class="fu">GWLog</span>(<span class="st">&quot;Activating popups.&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>            <span class="fu">GWLog</span>(<span class="st">&quot;Setting up for popins.&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>            <span class="fu">GWLog</span>(<span class="st">&quot;Activating popins.&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*  Add handler to set up targets in loaded content (including</span></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a><span class="co">            newly-spawned pop-frames; this allows for recursion), and to</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a><span class="co">            add hover/click event listeners to annotated targets, to load</span></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a><span class="co">            annotations (fragments).</span></span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a><span class="co">            */</span></span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>        GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> Extracts<span class="op">.</span><span class="at">processTargetsOnContentLoad</span> <span class="op">=</span> (info) <span class="kw">=&gt;</span> {</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>            <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.processTargetsOnContentLoad&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>            Extracts<span class="op">.</span><span class="fu">processTargetsInDocument</span>(info<span class="op">.</span><span class="at">document</span>)<span class="op">;</span></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span> { <span class="dt">phase</span><span class="op">:</span> <span class="st">&quot;eventListeners&quot;</span> })<span class="op">;</span></span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Fire setup-complete event.</span></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>        GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">fireEvent</span>(<span class="st">&quot;Extracts.setupDidComplete&quot;</span>)<span class="op">;</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>    <span class="dt">processTargetsInDocument</span><span class="op">:</span> (doc <span class="op">=</span> Extracts<span class="op">.</span><span class="at">rootDocument</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.processTargetsInDocument&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (doc<span class="op">.</span><span class="fu">closest</span>(Extracts<span class="op">.</span><span class="at">contentContainersSelector</span>)) {</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>            Extracts<span class="op">.</span><span class="fu">addTargetsWithin</span>(doc)<span class="op">;</span></span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>            Extracts<span class="op">.</span><span class="fu">setUpAnnotationLoadEventWithin</span>(doc)<span class="op">;</span></span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>            doc<span class="op">.</span><span class="fu">querySelectorAll</span>(Extracts<span class="op">.</span><span class="at">contentContainersSelector</span>)<span class="op">.</span><span class="fu">forEach</span>(container <span class="kw">=&gt;</span> {</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>                Extracts<span class="op">.</span><span class="fu">addTargetsWithin</span>(container)<span class="op">;</span></span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>                Extracts<span class="op">.</span><span class="fu">setUpAnnotationLoadEventWithin</span>(container)<span class="op">;</span></span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>    <span class="co">/***********/</span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Content.</span></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  This array defines the types of ‘targets’ (i.e., annotated links,</span></span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a><span class="co">        links pointing to available content such as images or code files,</span></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a><span class="co">        citations, etc.) that Extracts supports.</span></span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>    <span class="dt">targetTypeDefinitions</span><span class="op">:</span> [</span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>        [ <span class="st">&quot;LOCAL_PAGE&quot;</span><span class="op">,</span>         <span class="st">&quot;isLocalPageLink&quot;</span><span class="op">,</span>      <span class="st">&quot;has-content&quot;</span><span class="op">,</span>      <span class="st">&quot;localTranscludeForTarget&quot;</span><span class="op">,</span>     <span class="st">&quot;local-transclude&quot;</span>      ]<span class="op">,</span></span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Returns full type info for the given target. This contains the target</span></span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a><span class="co">        type name, the name of the predicate function for identifying targets of</span></span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a><span class="co">        that type (e.g., isAnnotatedLink), classes which should be applied to</span></span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a><span class="co">        targets of that type during initial processing, the fill functions to</span></span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a><span class="co">        fill popups and popins of that type, and the classes which should be</span></span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a><span class="co">        applied to pop-frames of that type.</span></span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>    <span class="dt">targetTypeInfo</span><span class="op">:</span> (target) <span class="kw">=&gt;</span> {</span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> info <span class="op">=</span> { }<span class="op">;</span></span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (definition <span class="kw">of</span> Extracts<span class="op">.</span><span class="at">targetTypeDefinitions</span>) {</span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>            [   info<span class="op">.</span><span class="at">typeName</span><span class="op">,</span></span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>                info<span class="op">.</span><span class="at">predicateFunctionName</span><span class="op">,</span></span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>                info<span class="op">.</span><span class="at">targetClasses</span><span class="op">,</span></span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>                info<span class="op">.</span><span class="at">popFrameFillFunctionName</span><span class="op">,</span></span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>                info<span class="op">.</span><span class="at">popFrameClasses</span></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>            ] <span class="op">=</span> definition<span class="op">;</span></span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (Extracts[info<span class="op">.</span><span class="at">predicateFunctionName</span>](target))</span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> info<span class="op">;</span></span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Returns the target identifier: the original URL (for locally archived</span></span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a><span class="co">        pages), or the relative url (for local links), or the full URL (for</span></span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a><span class="co">        foreign links).</span></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>    <span class="dt">targetIdentifier</span><span class="op">:</span> (target) <span class="kw">=&gt;</span> {</span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span>    target<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">urlOriginal</span></span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>               <span class="op">||</span> (target<span class="op">.</span><span class="at">hostname</span> <span class="op">==</span> location<span class="op">.</span><span class="at">hostname</span></span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a>                   <span class="op">?</span> target<span class="op">.</span><span class="at">pathname</span> <span class="op">+</span> target<span class="op">.</span><span class="at">hash</span></span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>                   <span class="op">:</span> target<span class="op">.</span><span class="at">href</span>)<span class="op">;</span></span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Returns true if the two targets will spawn identical popups</span></span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a><span class="co">        (that is, if they are of the same type, and have the same identifiers).</span></span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>    <span class="dt">targetsMatch</span><span class="op">:</span> (targetA<span class="op">,</span> targetB) <span class="kw">=&gt;</span> {</span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span>    Extracts<span class="op">.</span><span class="fu">targetIdentifier</span>(targetA) <span class="op">==</span> Extracts<span class="op">.</span><span class="fu">targetIdentifier</span>(targetB)</span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a>               <span class="op">&amp;&amp;</span> Extracts<span class="op">.</span><span class="fu">targetTypeInfo</span>(targetA)<span class="op">.</span><span class="at">typeName</span> <span class="op">==</span> Extracts<span class="op">.</span><span class="fu">targetTypeInfo</span>(targetB)<span class="op">.</span><span class="at">typeName</span><span class="op">;</span></span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  This function qualifies anchorlinks in transcluded content (i.e., other</span></span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a><span class="co">        pages on the site, as well as annotations describing other pages on the</span></span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a><span class="co">        site), by rewriting their href attributes to include the path of the</span></span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a><span class="co">        target (link) that spawned the pop-frame that contains the transcluded</span></span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a><span class="co">        content.</span></span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>    <span class="dt">qualifyLinksInPopFrame</span><span class="op">:</span> (popFrame) <span class="kw">=&gt;</span> {</span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>        popFrame<span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;a[href^=&#39;#&#39;]&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(anchorLink <span class="kw">=&gt;</span> {</span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>            anchorLink<span class="op">.</span><span class="at">pathname</span> <span class="op">=</span> popFrame<span class="op">.</span><span class="at">spawningTarget</span><span class="op">.</span><span class="at">pathname</span><span class="op">;</span></span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>    <span class="dt">nearestBlockElement</span><span class="op">:</span> (element) <span class="kw">=&gt;</span> {</span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> element<span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;address, aside, blockquote, dd, div, dt, figure, footer, h1, h2, h3, h4, h5, h6, header, li, p, pre, section, table, tfoot, ol, ul&quot;</span>)<span class="op">;</span></span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  This function fills a pop-frame for a given target with content. It</span></span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a><span class="co">        returns true if the pop-frame successfully filled, false otherwise.</span></span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a>    <span class="dt">fillPopFrame</span><span class="op">:</span> (popFrame) <span class="kw">=&gt;</span> {</span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.fillPopFrame&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> didFill <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> target <span class="op">=</span> popFrame<span class="op">.</span><span class="at">spawningTarget</span><span class="op">;</span></span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> targetTypeInfo <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">targetTypeInfo</span>(target)<span class="op">;</span></span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (targetTypeInfo <span class="op">&amp;&amp;</span> targetTypeInfo<span class="op">.</span><span class="at">popFrameFillFunctionName</span>) {</span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a>            didFill <span class="op">=</span> Extracts<span class="op">.</span><span class="at">popFrameProvider</span><span class="op">.</span><span class="fu">setPopFrameContent</span>(popFrame<span class="op">,</span> Extracts[targetTypeInfo<span class="op">.</span><span class="at">popFrameFillFunctionName</span>](target))<span class="op">;</span></span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (targetTypeInfo<span class="op">.</span><span class="at">popFrameClasses</span>)</span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a>                popFrame<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="op">...</span>(targetTypeInfo<span class="op">.</span><span class="at">popFrameClasses</span><span class="op">.</span><span class="fu">split</span>(<span class="st">&quot; &quot;</span>)))<span class="op">;</span></span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (didFill) {</span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a>            <span class="fu">GWLog</span>(<span class="vs">`Unable to fill pop-frame (</span><span class="sc">${</span>Extracts<span class="op">.</span><span class="fu">targetIdentifier</span>(target)<span class="sc">}</span><span class="vs"> [</span><span class="sc">${</span>(targetTypeInfo <span class="op">?</span> targetTypeInfo<span class="op">.</span><span class="at">typeName</span> <span class="op">:</span> <span class="st">&quot;UNDEFINED&quot;</span>)<span class="sc">}</span><span class="vs">])!`</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a>    <span class="dt">popFrameHasLoaded</span><span class="op">:</span> (popFrame) <span class="kw">=&gt;</span> {</span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">!</span>(popFrame<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&quot;loading&quot;</span>) <span class="op">||</span> popFrame<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&quot;loading-failed&quot;</span>))<span class="op">;</span></span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a>    <span class="dt">standardPopFrameTitleElementForTarget</span><span class="op">:</span> (target<span class="op">,</span> titleText) <span class="kw">=&gt;</span> {</span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="kw">typeof</span> titleText <span class="op">==</span> <span class="st">&quot;undefined&quot;</span>)</span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true" tabindex="-1"></a>            titleText <span class="op">=</span> (target<span class="op">.</span><span class="at">hostname</span> <span class="op">==</span> location<span class="op">.</span><span class="at">hostname</span>)</span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a>                        <span class="op">?</span> target<span class="op">.</span><span class="at">pathname</span> <span class="op">+</span> target<span class="op">.</span><span class="at">hash</span></span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a>                        <span class="op">:</span> target<span class="op">.</span><span class="at">href</span><span class="op">;</span></span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Because tab-handling is bad on mobile, readers expect the original remote URL to open up in-tab, as readers will be single-threaded;</span></span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a>        <span class="co">// on desktop, we can open up in a tab for poweruser-browsing of tab-explosions.</span></span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (Extracts<span class="op">.</span><span class="at">popFrameProvider</span> <span class="op">==</span> Popins) {</span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="vs">`&lt;a</span></span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a><span class="vs">                class=&quot;popframe-title-link&quot;</span></span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a><span class="vs">                href=&quot;</span><span class="sc">${</span>target<span class="op">.</span><span class="at">href</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a><span class="vs">                title=&quot;Open </span><span class="sc">${</span>target<span class="op">.</span><span class="at">href</span><span class="sc">}</span><span class="vs"> in current window&quot;</span></span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a><span class="vs">                target=&quot;_self&quot;</span></span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a><span class="vs">                    &gt;</span><span class="sc">${</span>titleText<span class="sc">}</span><span class="vs">&lt;/a&gt;`</span><span class="op">;</span></span>
<span id="cb1-288"><a href="#cb1-288" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb1-289"><a href="#cb1-289" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="vs">`&lt;a</span></span>
<span id="cb1-290"><a href="#cb1-290" aria-hidden="true" tabindex="-1"></a><span class="vs">                class=&quot;popframe-title-link&quot;</span></span>
<span id="cb1-291"><a href="#cb1-291" aria-hidden="true" tabindex="-1"></a><span class="vs">                href=&quot;</span><span class="sc">${</span>target<span class="op">.</span><span class="at">href</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb1-292"><a href="#cb1-292" aria-hidden="true" tabindex="-1"></a><span class="vs">                title=&quot;Open </span><span class="sc">${</span>target<span class="op">.</span><span class="at">href</span><span class="sc">}</span><span class="vs"> in new window.&quot;</span></span>
<span id="cb1-293"><a href="#cb1-293" aria-hidden="true" tabindex="-1"></a><span class="vs">                target=&quot;_blank&quot;</span></span>
<span id="cb1-294"><a href="#cb1-294" aria-hidden="true" tabindex="-1"></a><span class="vs">                    &gt;</span><span class="sc">${</span>titleText<span class="sc">}</span><span class="vs">&lt;/a&gt;`</span><span class="op">;</span></span>
<span id="cb1-295"><a href="#cb1-295" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-296"><a href="#cb1-296" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-297"><a href="#cb1-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-298"><a href="#cb1-298" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Returns the contents of the title element for a pop-frame.</span></span>
<span id="cb1-299"><a href="#cb1-299" aria-hidden="true" tabindex="-1"></a>    <span class="dt">titleForPopFrame</span><span class="op">:</span> (popFrame) <span class="kw">=&gt;</span> {</span>
<span id="cb1-300"><a href="#cb1-300" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> target <span class="op">=</span> popFrame<span class="op">.</span><span class="at">spawningTarget</span><span class="op">;</span></span>
<span id="cb1-301"><a href="#cb1-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-302"><a href="#cb1-302" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Special handling for certain popup types.</span></span>
<span id="cb1-303"><a href="#cb1-303" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> targetTypeName <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">targetTypeInfo</span>(target)<span class="op">.</span><span class="at">typeName</span><span class="op">;</span></span>
<span id="cb1-304"><a href="#cb1-304" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> specialTitleFunction <span class="op">=</span> (Extracts<span class="op">.</span><span class="at">popFrameProvider</span> <span class="op">==</span> Popups</span>
<span id="cb1-305"><a href="#cb1-305" aria-hidden="true" tabindex="-1"></a>                                    <span class="op">?</span> Extracts[<span class="vs">`titleForPopup_</span><span class="sc">${</span>targetTypeName<span class="sc">}</span><span class="vs">`</span>]</span>
<span id="cb1-306"><a href="#cb1-306" aria-hidden="true" tabindex="-1"></a>                                    <span class="op">:</span> Extracts[<span class="vs">`titleForPopin_</span><span class="sc">${</span>targetTypeName<span class="sc">}</span><span class="vs">`</span>])</span>
<span id="cb1-307"><a href="#cb1-307" aria-hidden="true" tabindex="-1"></a>                                <span class="op">||</span> Extracts[<span class="vs">`titleForPopFrame_</span><span class="sc">${</span>targetTypeName<span class="sc">}</span><span class="vs">`</span>]<span class="op">;</span></span>
<span id="cb1-308"><a href="#cb1-308" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (specialTitleFunction)</span>
<span id="cb1-309"><a href="#cb1-309" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">specialTitleFunction</span>(popFrame)<span class="op">;</span></span>
<span id="cb1-310"><a href="#cb1-310" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb1-311"><a href="#cb1-311" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Extracts<span class="op">.</span><span class="fu">standardPopFrameTitleElementForTarget</span>(target)<span class="op">;</span></span>
<span id="cb1-312"><a href="#cb1-312" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-313"><a href="#cb1-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-314"><a href="#cb1-314" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  This function’s purpose is to allow for the transclusion of entire pages</span></span>
<span id="cb1-315"><a href="#cb1-315" aria-hidden="true" tabindex="-1"></a><span class="co">        on the same website (displayed to the user in popups, or injected in</span></span>
<span id="cb1-316"><a href="#cb1-316" aria-hidden="true" tabindex="-1"></a><span class="co">        block flow as popins), and the (almost-)seamless handling of local links</span></span>
<span id="cb1-317"><a href="#cb1-317" aria-hidden="true" tabindex="-1"></a><span class="co">        in such transcluded content in the same way that they’re handled in the</span></span>
<span id="cb1-318"><a href="#cb1-318" aria-hidden="true" tabindex="-1"></a><span class="co">        root document (i.e., the actual page loaded in the browser window). This</span></span>
<span id="cb1-319"><a href="#cb1-319" aria-hidden="true" tabindex="-1"></a><span class="co">        permits us to have truly recursive popups with unlimited recursion depth</span></span>
<span id="cb1-320"><a href="#cb1-320" aria-hidden="true" tabindex="-1"></a><span class="co">        and no loss of functionality.</span></span>
<span id="cb1-321"><a href="#cb1-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-322"><a href="#cb1-322" aria-hidden="true" tabindex="-1"></a><span class="co">        For any given target element, targetDocument() asks: to what local</span></span>
<span id="cb1-323"><a href="#cb1-323" aria-hidden="true" tabindex="-1"></a><span class="co">        document does the link refer?</span></span>
<span id="cb1-324"><a href="#cb1-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-325"><a href="#cb1-325" aria-hidden="true" tabindex="-1"></a><span class="co">        This may be either the root document, or an entire other page that was</span></span>
<span id="cb1-326"><a href="#cb1-326" aria-hidden="true" tabindex="-1"></a><span class="co">        transcluded wholesale and embedded as a pop-frame (of class</span></span>
<span id="cb1-327"><a href="#cb1-327" aria-hidden="true" tabindex="-1"></a><span class="co">        ‘external-page-embed’).</span></span>
<span id="cb1-328"><a href="#cb1-328" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-329"><a href="#cb1-329" aria-hidden="true" tabindex="-1"></a>    <span class="dt">targetDocument</span><span class="op">:</span> (target) <span class="kw">=&gt;</span> {</span>
<span id="cb1-330"><a href="#cb1-330" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (target<span class="op">.</span><span class="at">hostname</span> <span class="op">!=</span> location<span class="op">.</span><span class="at">hostname</span>)</span>
<span id="cb1-331"><a href="#cb1-331" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb1-332"><a href="#cb1-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-333"><a href="#cb1-333" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (target<span class="op">.</span><span class="at">pathname</span> <span class="op">==</span> location<span class="op">.</span><span class="at">pathname</span>)</span>
<span id="cb1-334"><a href="#cb1-334" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Extracts<span class="op">.</span><span class="at">rootDocument</span><span class="op">;</span></span>
<span id="cb1-335"><a href="#cb1-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-336"><a href="#cb1-336" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (Extracts<span class="op">.</span><span class="at">popFrameProvider</span> <span class="op">==</span> Popups) {</span>
<span id="cb1-337"><a href="#cb1-337" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> popupForTargetDocument <span class="op">=</span> Popups<span class="op">.</span><span class="fu">allSpawnedPopups</span>()<span class="op">.</span><span class="fu">find</span>(popup <span class="kw">=&gt;</span> (   popup<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&quot;external-page-embed&quot;</span>)</span>
<span id="cb1-338"><a href="#cb1-338" aria-hidden="true" tabindex="-1"></a>                                                                                  <span class="op">&amp;&amp;</span> popup<span class="op">.</span><span class="at">spawningTarget</span><span class="op">.</span><span class="at">pathname</span> <span class="op">==</span> target<span class="op">.</span><span class="at">pathname</span>))<span class="op">;</span></span>
<span id="cb1-339"><a href="#cb1-339" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> popupForTargetDocument <span class="op">?</span> popupForTargetDocument<span class="op">.</span><span class="at">contentView</span> <span class="op">:</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb1-340"><a href="#cb1-340" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (Extracts<span class="op">.</span><span class="at">popFrameProvider</span> <span class="op">==</span> Popins) {</span>
<span id="cb1-341"><a href="#cb1-341" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> popinForTargetDocument <span class="op">=</span> Popins<span class="op">.</span><span class="fu">allSpawnedPopins</span>()<span class="op">.</span><span class="fu">find</span>(popin <span class="kw">=&gt;</span> (   popin<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&quot;external-page-embed&quot;</span>)</span>
<span id="cb1-342"><a href="#cb1-342" aria-hidden="true" tabindex="-1"></a>                                                                                  <span class="op">&amp;&amp;</span> popin<span class="op">.</span><span class="at">spawningTarget</span><span class="op">.</span><span class="at">pathname</span> <span class="op">==</span> target<span class="op">.</span><span class="at">pathname</span>)</span>
<span id="cb1-343"><a href="#cb1-343" aria-hidden="true" tabindex="-1"></a>                                                                                  <span class="op">&amp;&amp;</span> Extracts<span class="op">.</span><span class="fu">popFrameHasLoaded</span>(popin))<span class="op">;</span></span>
<span id="cb1-344"><a href="#cb1-344" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> popinForTargetDocument <span class="op">?</span> popinForTargetDocument<span class="op">.</span><span class="at">contentView</span> <span class="op">:</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb1-345"><a href="#cb1-345" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-346"><a href="#cb1-346" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-347"><a href="#cb1-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-348"><a href="#cb1-348" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Returns the location (a URL object) of the document for a given target.</span></span>
<span id="cb1-349"><a href="#cb1-349" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-350"><a href="#cb1-350" aria-hidden="true" tabindex="-1"></a>    <span class="dt">locationForTarget</span><span class="op">:</span> (target) <span class="kw">=&gt;</span> {</span>
<span id="cb1-351"><a href="#cb1-351" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">URL</span>(target<span class="op">.</span><span class="at">href</span>)<span class="op">;</span></span>
<span id="cb1-352"><a href="#cb1-352" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-353"><a href="#cb1-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-354"><a href="#cb1-354" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Activate loading spinner for an object pop-frame.</span></span>
<span id="cb1-355"><a href="#cb1-355" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-356"><a href="#cb1-356" aria-hidden="true" tabindex="-1"></a>    <span class="dt">setLoadingSpinner</span><span class="op">:</span> (popFrame) <span class="kw">=&gt;</span> {</span>
<span id="cb1-357"><a href="#cb1-357" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> target <span class="op">=</span> popFrame<span class="op">.</span><span class="at">spawningTarget</span><span class="op">;</span></span>
<span id="cb1-358"><a href="#cb1-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-359"><a href="#cb1-359" aria-hidden="true" tabindex="-1"></a>        popFrame<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;loading&quot;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb1-360"><a href="#cb1-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-361"><a href="#cb1-361" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  When loading ends (in success or failure)...</span></span>
<span id="cb1-362"><a href="#cb1-362" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> objectOfSomeSort <span class="op">=</span> popFrame<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;iframe, object, img, video&quot;</span>)<span class="op">;</span></span>
<span id="cb1-363"><a href="#cb1-363" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (objectOfSomeSort<span class="op">.</span><span class="at">tagName</span> <span class="op">==</span> <span class="st">&quot;IFRAME&quot;</span>) {</span>
<span id="cb1-364"><a href="#cb1-364" aria-hidden="true" tabindex="-1"></a>            <span class="co">//  Iframes do not fire ‘error’ on server error.</span></span>
<span id="cb1-365"><a href="#cb1-365" aria-hidden="true" tabindex="-1"></a>            objectOfSomeSort<span class="op">.</span><span class="at">onload</span> <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-366"><a href="#cb1-366" aria-hidden="true" tabindex="-1"></a>                popFrame<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;loading&quot;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb1-367"><a href="#cb1-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-368"><a href="#cb1-368" aria-hidden="true" tabindex="-1"></a>                <span class="co">/*  We do this for local documents only. Cross-origin</span></span>
<span id="cb1-369"><a href="#cb1-369" aria-hidden="true" tabindex="-1"></a><span class="co">                    protections prevent us from accessing the content of</span></span>
<span id="cb1-370"><a href="#cb1-370" aria-hidden="true" tabindex="-1"></a><span class="co">                    an iframe with a foreign site, so we do nothing special</span></span>
<span id="cb1-371"><a href="#cb1-371" aria-hidden="true" tabindex="-1"></a><span class="co">                    and simply let the foreign site’s server show its usual</span></span>
<span id="cb1-372"><a href="#cb1-372" aria-hidden="true" tabindex="-1"></a><span class="co">                    404 page (or whatever) if the linked page is not found.</span></span>
<span id="cb1-373"><a href="#cb1-373" aria-hidden="true" tabindex="-1"></a><span class="co">                    */</span></span>
<span id="cb1-374"><a href="#cb1-374" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (   target<span class="op">.</span><span class="at">hostname</span> <span class="op">==</span> location<span class="op">.</span><span class="at">hostname</span></span>
<span id="cb1-375"><a href="#cb1-375" aria-hidden="true" tabindex="-1"></a>                    <span class="op">&amp;&amp;</span> Extracts<span class="op">.</span><span class="at">server404PageTitles</span><span class="op">.</span><span class="fu">includes</span>(objectOfSomeSort<span class="op">.</span><span class="at">contentDocument</span><span class="op">.</span><span class="at">title</span>)) {</span>
<span id="cb1-376"><a href="#cb1-376" aria-hidden="true" tabindex="-1"></a>                    popFrame<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;loading-failed&quot;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb1-377"><a href="#cb1-377" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb1-378"><a href="#cb1-378" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb1-379"><a href="#cb1-379" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb1-380"><a href="#cb1-380" aria-hidden="true" tabindex="-1"></a>            <span class="co">//  Objects &amp; images fire ‘error’ on server error or load fail.</span></span>
<span id="cb1-381"><a href="#cb1-381" aria-hidden="true" tabindex="-1"></a>            objectOfSomeSort<span class="op">.</span><span class="at">onload</span> <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-382"><a href="#cb1-382" aria-hidden="true" tabindex="-1"></a>                popFrame<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;loading&quot;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb1-383"><a href="#cb1-383" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb1-384"><a href="#cb1-384" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-385"><a href="#cb1-385" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*  We set an ‘error’ handler for *all* types of entity, even</span></span>
<span id="cb1-386"><a href="#cb1-386" aria-hidden="true" tabindex="-1"></a><span class="co">            iframes, just in case.</span></span>
<span id="cb1-387"><a href="#cb1-387" aria-hidden="true" tabindex="-1"></a><span class="co">            */</span></span>
<span id="cb1-388"><a href="#cb1-388" aria-hidden="true" tabindex="-1"></a>        objectOfSomeSort<span class="op">.</span><span class="at">onerror</span> <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-389"><a href="#cb1-389" aria-hidden="true" tabindex="-1"></a>            popFrame<span class="op">.</span><span class="fu">swapClasses</span>([ <span class="st">&quot;loading&quot;</span><span class="op">,</span> <span class="st">&quot;loading-failed&quot;</span> ]<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-390"><a href="#cb1-390" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb1-391"><a href="#cb1-391" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-392"><a href="#cb1-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-393"><a href="#cb1-393" aria-hidden="true" tabindex="-1"></a>    <span class="co">/***************************************************************************/</span></span>
<span id="cb1-394"><a href="#cb1-394" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  The target-testing and pop-frame-filling functions in this section</span></span>
<span id="cb1-395"><a href="#cb1-395" aria-hidden="true" tabindex="-1"></a><span class="co">        come in sets, which define and implement classes of pop-frames</span></span>
<span id="cb1-396"><a href="#cb1-396" aria-hidden="true" tabindex="-1"></a><span class="co">        (whether those be popups, or popins, etc.). (These classes are things</span></span>
<span id="cb1-397"><a href="#cb1-397" aria-hidden="true" tabindex="-1"></a><span class="co">        like “a link that has a statically generated extract provided for it”,</span></span>
<span id="cb1-398"><a href="#cb1-398" aria-hidden="true" tabindex="-1"></a><span class="co">        “a link to a locally archived web page”, “an anchorlink to a section of</span></span>
<span id="cb1-399"><a href="#cb1-399" aria-hidden="true" tabindex="-1"></a><span class="co">        the current page”, and so on.)</span></span>
<span id="cb1-400"><a href="#cb1-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-401"><a href="#cb1-401" aria-hidden="true" tabindex="-1"></a><span class="co">        Each set contains a testing function, which is called by</span></span>
<span id="cb1-402"><a href="#cb1-402" aria-hidden="true" tabindex="-1"></a><span class="co">        testTarget() to determine if the target (link, etc.) is eligible for</span></span>
<span id="cb1-403"><a href="#cb1-403" aria-hidden="true" tabindex="-1"></a><span class="co">        processing, and is also called by fillPopFrame() to find the</span></span>
<span id="cb1-404"><a href="#cb1-404" aria-hidden="true" tabindex="-1"></a><span class="co">        appropriate filling function for a pop-frame spawned by a given</span></span>
<span id="cb1-405"><a href="#cb1-405" aria-hidden="true" tabindex="-1"></a><span class="co">        target. The testing function takes a target element and examines its</span></span>
<span id="cb1-406"><a href="#cb1-406" aria-hidden="true" tabindex="-1"></a><span class="co">        href or other properties, and returns true if the target is a member of</span></span>
<span id="cb1-407"><a href="#cb1-407" aria-hidden="true" tabindex="-1"></a><span class="co">        that class of targets, false otherwise.</span></span>
<span id="cb1-408"><a href="#cb1-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-409"><a href="#cb1-409" aria-hidden="true" tabindex="-1"></a><span class="co">        Each set also contains the corresponding filling function, which</span></span>
<span id="cb1-410"><a href="#cb1-410" aria-hidden="true" tabindex="-1"></a><span class="co">        is called by fillPopFrame() (chosen on the basis of the return values</span></span>
<span id="cb1-411"><a href="#cb1-411" aria-hidden="true" tabindex="-1"></a><span class="co">        of the testing functions, and the specified order in which they’re</span></span>
<span id="cb1-412"><a href="#cb1-412" aria-hidden="true" tabindex="-1"></a><span class="co">        called). The filling function takes a target element and returns a</span></span>
<span id="cb1-413"><a href="#cb1-413" aria-hidden="true" tabindex="-1"></a><span class="co">        string which comprises the HTML contents that should be injected into</span></span>
<span id="cb1-414"><a href="#cb1-414" aria-hidden="true" tabindex="-1"></a><span class="co">        the pop-frame spawned by the given target.</span></span>
<span id="cb1-415"><a href="#cb1-415" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-416"><a href="#cb1-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-417"><a href="#cb1-417" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Local links (to sections of the current page, or other site pages).</span></span>
<span id="cb1-418"><a href="#cb1-418" aria-hidden="true" tabindex="-1"></a>    <span class="dt">isLocalPageLink</span><span class="op">:</span> (target) <span class="kw">=&gt;</span> {</span>
<span id="cb1-419"><a href="#cb1-419" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (   target<span class="op">.</span><span class="at">hostname</span> <span class="op">!=</span> location<span class="op">.</span><span class="at">hostname</span></span>
<span id="cb1-420"><a href="#cb1-420" aria-hidden="true" tabindex="-1"></a>            <span class="op">||</span> Extracts<span class="op">.</span><span class="fu">isAnnotatedLink</span>(target))</span>
<span id="cb1-421"><a href="#cb1-421" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-422"><a href="#cb1-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-423"><a href="#cb1-423" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*  If it has a period in it, it’s not a page, but is something else,</span></span>
<span id="cb1-424"><a href="#cb1-424" aria-hidden="true" tabindex="-1"></a><span class="co">            like a file of some sort, or a locally archived document (accounted</span></span>
<span id="cb1-425"><a href="#cb1-425" aria-hidden="true" tabindex="-1"></a><span class="co">            for in the other test functions, if need be).</span></span>
<span id="cb1-426"><a href="#cb1-426" aria-hidden="true" tabindex="-1"></a><span class="co">            */</span></span>
<span id="cb1-427"><a href="#cb1-427" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (target<span class="op">.</span><span class="at">pathname</span><span class="op">.</span><span class="fu">match</span>(<span class="ss">/</span><span class="sc">\.</span><span class="ss">/</span>))</span>
<span id="cb1-428"><a href="#cb1-428" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-429"><a href="#cb1-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-430"><a href="#cb1-430" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (   target<span class="op">.</span><span class="at">pathname</span> <span class="op">!=</span> location<span class="op">.</span><span class="at">pathname</span></span>
<span id="cb1-431"><a href="#cb1-431" aria-hidden="true" tabindex="-1"></a>                <span class="op">||</span> target<span class="op">.</span><span class="at">hash</span> <span class="op">&gt;</span> <span class="st">&quot;&quot;</span>)<span class="op">;</span></span>
<span id="cb1-432"><a href="#cb1-432" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-433"><a href="#cb1-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-434"><a href="#cb1-434" aria-hidden="true" tabindex="-1"></a>    <span class="dt">localTranscludeForTarget</span><span class="op">:</span> (target<span class="op">,</span> unwrapFunction) <span class="kw">=&gt;</span> {</span>
<span id="cb1-435"><a href="#cb1-435" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.localTranscludeForTarget&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-436"><a href="#cb1-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-437"><a href="#cb1-437" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (unwrapFunction <span class="op">==</span> <span class="kw">null</span>)</span>
<span id="cb1-438"><a href="#cb1-438" aria-hidden="true" tabindex="-1"></a>            unwrapFunction <span class="op">=</span> (blockElement) <span class="kw">=&gt;</span> {</span>
<span id="cb1-439"><a href="#cb1-439" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (blockElement<span class="op">.</span><span class="at">tagName</span> <span class="op">==</span> <span class="st">&quot;SECTION&quot;</span>) {</span>
<span id="cb1-440"><a href="#cb1-440" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> blockElement<span class="op">.</span><span class="at">innerHTML</span><span class="op">;</span></span>
<span id="cb1-441"><a href="#cb1-441" aria-hidden="true" tabindex="-1"></a>                } <span class="cf">else</span> {</span>
<span id="cb1-442"><a href="#cb1-442" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> blockElement<span class="op">.</span><span class="at">outerHTML</span><span class="op">;</span></span>
<span id="cb1-443"><a href="#cb1-443" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb1-444"><a href="#cb1-444" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb1-445"><a href="#cb1-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-446"><a href="#cb1-446" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*  Check to see if the target location matches an already-displayed</span></span>
<span id="cb1-447"><a href="#cb1-447" aria-hidden="true" tabindex="-1"></a><span class="co">            page (which can be the root page of the window).</span></span>
<span id="cb1-448"><a href="#cb1-448" aria-hidden="true" tabindex="-1"></a><span class="co">            */</span></span>
<span id="cb1-449"><a href="#cb1-449" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> fullTargetDocument <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">targetDocument</span>(target)<span class="op">;</span></span>
<span id="cb1-450"><a href="#cb1-450" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (fullTargetDocument) {</span>
<span id="cb1-451"><a href="#cb1-451" aria-hidden="true" tabindex="-1"></a>            <span class="co">/*  If it does, display the section. (We know it must be an</span></span>
<span id="cb1-452"><a href="#cb1-452" aria-hidden="true" tabindex="-1"></a><span class="co">                anchorlink because if it were not, the target would not be</span></span>
<span id="cb1-453"><a href="#cb1-453" aria-hidden="true" tabindex="-1"></a><span class="co">                active.)</span></span>
<span id="cb1-454"><a href="#cb1-454" aria-hidden="true" tabindex="-1"></a><span class="co">                */</span></span>
<span id="cb1-455"><a href="#cb1-455" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">unwrapFunction</span>(Extracts<span class="op">.</span><span class="fu">nearestBlockElement</span>(fullTargetDocument<span class="op">.</span><span class="fu">querySelector</span>(<span class="pp">decodeURIComponent</span>(target<span class="op">.</span><span class="at">hash</span>))))<span class="op">;</span></span>
<span id="cb1-456"><a href="#cb1-456" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb1-457"><a href="#cb1-457" aria-hidden="true" tabindex="-1"></a>            <span class="co">//  Otherwise, display the entire linked page.</span></span>
<span id="cb1-458"><a href="#cb1-458" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Extracts<span class="op">.</span><span class="fu">externalPageEmbedForTarget</span>(target)<span class="op">;</span></span>
<span id="cb1-459"><a href="#cb1-459" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-460"><a href="#cb1-460" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-461"><a href="#cb1-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-462"><a href="#cb1-462" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  TOC links.</span></span>
<span id="cb1-463"><a href="#cb1-463" aria-hidden="true" tabindex="-1"></a>    <span class="dt">isTOCLink</span><span class="op">:</span> (target) <span class="kw">=&gt;</span> {</span>
<span id="cb1-464"><a href="#cb1-464" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (target<span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;#TOC&quot;</span>) <span class="op">!=</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb1-465"><a href="#cb1-465" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-466"><a href="#cb1-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-467"><a href="#cb1-467" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Links in the sidebar.</span></span>
<span id="cb1-468"><a href="#cb1-468" aria-hidden="true" tabindex="-1"></a>    <span class="dt">isSidebarLink</span><span class="op">:</span> (target) <span class="kw">=&gt;</span> {</span>
<span id="cb1-469"><a href="#cb1-469" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (target<span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;#sidebar&quot;</span>) <span class="op">!=</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb1-470"><a href="#cb1-470" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-471"><a href="#cb1-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-472"><a href="#cb1-472" aria-hidden="true" tabindex="-1"></a>    <span class="dt">testTarget_LOCAL_PAGE</span><span class="op">:</span> (target) <span class="kw">=&gt;</span> {</span>
<span id="cb1-473"><a href="#cb1-473" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="op">!</span>(   Extracts<span class="op">.</span><span class="at">popFrameProvider</span> <span class="op">==</span> Popins</span>
<span id="cb1-474"><a href="#cb1-474" aria-hidden="true" tabindex="-1"></a>                  <span class="op">&amp;&amp;</span> (   Extracts<span class="op">.</span><span class="fu">isTOCLink</span>(target)</span>
<span id="cb1-475"><a href="#cb1-475" aria-hidden="true" tabindex="-1"></a>                      <span class="op">||</span> Extracts<span class="op">.</span><span class="fu">isSidebarLink</span>(target))))<span class="op">;</span></span>
<span id="cb1-476"><a href="#cb1-476" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-477"><a href="#cb1-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-478"><a href="#cb1-478" aria-hidden="true" tabindex="-1"></a>    <span class="dt">preparePopup_LOCAL_PAGE</span><span class="op">:</span> (popup) <span class="kw">=&gt;</span> {</span>
<span id="cb1-479"><a href="#cb1-479" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> target <span class="op">=</span> popup<span class="op">.</span><span class="at">spawningTarget</span><span class="op">;</span></span>
<span id="cb1-480"><a href="#cb1-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-481"><a href="#cb1-481" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Designate section links spawned by the TOC (for special styling).</span></span>
<span id="cb1-482"><a href="#cb1-482" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (Extracts<span class="op">.</span><span class="fu">isTOCLink</span>(target))</span>
<span id="cb1-483"><a href="#cb1-483" aria-hidden="true" tabindex="-1"></a>            popup<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&quot;toc-section&quot;</span>)<span class="op">;</span></span>
<span id="cb1-484"><a href="#cb1-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-485"><a href="#cb1-485" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> popup<span class="op">;</span></span>
<span id="cb1-486"><a href="#cb1-486" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-487"><a href="#cb1-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-488"><a href="#cb1-488" aria-hidden="true" tabindex="-1"></a>    <span class="dt">titleForPopFrame_LOCAL_PAGE</span><span class="op">:</span> (popFrame) <span class="kw">=&gt;</span> {</span>
<span id="cb1-489"><a href="#cb1-489" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> target <span class="op">=</span> popFrame<span class="op">.</span><span class="at">spawningTarget</span><span class="op">;</span></span>
<span id="cb1-490"><a href="#cb1-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-491"><a href="#cb1-491" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> popFrameTitleText<span class="op">;</span></span>
<span id="cb1-492"><a href="#cb1-492" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (target<span class="op">.</span><span class="at">pathname</span> <span class="op">==</span> location<span class="op">.</span><span class="at">pathname</span>) {</span>
<span id="cb1-493"><a href="#cb1-493" aria-hidden="true" tabindex="-1"></a>            <span class="co">//  Sections of the current page.</span></span>
<span id="cb1-494"><a href="#cb1-494" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> nearestBlockElement <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">nearestBlockElement</span>(<span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="pp">decodeURIComponent</span>(target<span class="op">.</span><span class="at">hash</span>)))<span class="op">;</span></span>
<span id="cb1-495"><a href="#cb1-495" aria-hidden="true" tabindex="-1"></a>            popFrameTitleText <span class="op">=</span> nearestBlockElement<span class="op">.</span><span class="at">tagName</span> <span class="op">==</span> <span class="st">&quot;SECTION&quot;</span></span>
<span id="cb1-496"><a href="#cb1-496" aria-hidden="true" tabindex="-1"></a>                                <span class="op">?</span> nearestBlockElement<span class="op">.</span><span class="at">firstElementChild</span><span class="op">.</span><span class="at">textContent</span></span>
<span id="cb1-497"><a href="#cb1-497" aria-hidden="true" tabindex="-1"></a>                                <span class="op">:</span> target<span class="op">.</span><span class="at">hash</span><span class="op">;</span></span>
<span id="cb1-498"><a href="#cb1-498" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb1-499"><a href="#cb1-499" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (popFrame<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&quot;external-page-embed&quot;</span>)) {</span>
<span id="cb1-500"><a href="#cb1-500" aria-hidden="true" tabindex="-1"></a>                <span class="co">//  Entire other pages.</span></span>
<span id="cb1-501"><a href="#cb1-501" aria-hidden="true" tabindex="-1"></a>                popFrameTitleText <span class="op">=</span> Extracts<span class="op">.</span><span class="at">cachedPageTitles</span>[target<span class="op">.</span><span class="at">pathname</span>] <span class="op">||</span> target<span class="op">.</span><span class="at">pathname</span><span class="op">;</span></span>
<span id="cb1-502"><a href="#cb1-502" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {</span>
<span id="cb1-503"><a href="#cb1-503" aria-hidden="true" tabindex="-1"></a>                <span class="co">//  Sections of other pages.</span></span>
<span id="cb1-504"><a href="#cb1-504" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> nearestBlockElement <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">nearestBlockElement</span>(Extracts<span class="op">.</span><span class="fu">targetDocument</span>(target)<span class="op">.</span><span class="fu">querySelector</span>(<span class="pp">decodeURIComponent</span>(target<span class="op">.</span><span class="at">hash</span>)))<span class="op">;</span></span>
<span id="cb1-505"><a href="#cb1-505" aria-hidden="true" tabindex="-1"></a>                popFrameTitleText <span class="op">=</span> nearestBlockElement<span class="op">.</span><span class="at">tagName</span> <span class="op">==</span> <span class="st">&quot;SECTION&quot;</span></span>
<span id="cb1-506"><a href="#cb1-506" aria-hidden="true" tabindex="-1"></a>                                    <span class="op">?</span> (nearestBlockElement<span class="op">.</span><span class="at">firstElementChild</span><span class="op">.</span><span class="at">textContent</span> <span class="op">+</span> <span class="vs">` (</span><span class="sc">${</span>Extracts<span class="op">.</span><span class="at">cachedPageTitles</span>[target<span class="op">.</span><span class="at">pathname</span>] <span class="op">||</span> target<span class="op">.</span><span class="at">pathname</span><span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb1-507"><a href="#cb1-507" aria-hidden="true" tabindex="-1"></a>                                    <span class="op">:</span> (target<span class="op">.</span><span class="at">pathname</span> <span class="op">+</span> target<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb1-508"><a href="#cb1-508" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-509"><a href="#cb1-509" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-510"><a href="#cb1-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-511"><a href="#cb1-511" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Mark sections with ‘§’ symbol.</span></span>
<span id="cb1-512"><a href="#cb1-512" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (target<span class="op">.</span><span class="at">hash</span> <span class="op">&gt;</span> <span class="st">&quot;&quot;</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>popFrame<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&quot;external-page-embed&quot;</span> <span class="op">&amp;&amp;</span></span>
<span id="cb1-513"><a href="#cb1-513" aria-hidden="true" tabindex="-1"></a>            <span class="co">// links with an org notation for link icons (eg &#39;https://arxiv.org/abs/2006.07159#google&#39;) should not get a section mark</span></span>
<span id="cb1-514"><a href="#cb1-514" aria-hidden="true" tabindex="-1"></a>            <span class="op">!</span>[<span class="st">&quot;alibaba&quot;</span><span class="op">,</span> <span class="st">&quot;allen&quot;</span><span class="op">,</span> <span class="st">&quot;amazon&quot;</span><span class="op">,</span> <span class="st">&quot;baidu&quot;</span><span class="op">,</span> <span class="st">&quot;deepmind&quot;</span><span class="op">,</span> <span class="st">&quot;eleutherai&quot;</span><span class="op">,</span> <span class="st">&quot;facebook&quot;</span><span class="op">,</span> <span class="st">&quot;google&quot;</span><span class="op">,</span> <span class="st">&quot;googlebrain&quot;</span><span class="op">,</span> <span class="st">&quot;lighton&quot;</span><span class="op">,</span> <span class="st">&quot;microsoft&quot;</span><span class="op">,</span> <span class="st">&quot;miri&quot;</span><span class="op">,</span> <span class="st">&quot;nvidia&quot;</span><span class="op">,</span> <span class="st">&quot;openai&quot;</span><span class="op">,</span> <span class="st">&quot;pdf&quot;</span><span class="op">,</span> <span class="st">&quot;salesforce&quot;</span><span class="op">,</span> <span class="st">&quot;tencent&quot;</span><span class="op">,</span> <span class="st">&quot;tensorfork&quot;</span><span class="op">,</span> <span class="st">&quot;uber&quot;</span><span class="op">,</span> <span class="st">&quot;yandex&quot;</span>]<span class="op">.</span><span class="fu">includes</span>(target<span class="op">.</span><span class="at">hash</span>)))</span>
<span id="cb1-515"><a href="#cb1-515" aria-hidden="true" tabindex="-1"></a>            popFrameTitleText <span class="op">=</span> <span class="st">&quot;&amp;#x00a7; &quot;</span> <span class="op">+</span> popFrameTitleText<span class="op">;</span></span>
<span id="cb1-516"><a href="#cb1-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-517"><a href="#cb1-517" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Extracts<span class="op">.</span><span class="fu">standardPopFrameTitleElementForTarget</span>(target<span class="op">,</span> popFrameTitleText)<span class="op">;</span></span>
<span id="cb1-518"><a href="#cb1-518" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-519"><a href="#cb1-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-520"><a href="#cb1-520" aria-hidden="true" tabindex="-1"></a>    <span class="dt">rewritePopFrameContent_LOCAL_PAGE</span><span class="op">:</span> (popFrame) <span class="kw">=&gt;</span> {</span>
<span id="cb1-521"><a href="#cb1-521" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> target <span class="op">=</span> popFrame<span class="op">.</span><span class="at">spawningTarget</span><span class="op">;</span></span>
<span id="cb1-522"><a href="#cb1-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-523"><a href="#cb1-523" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Qualify internal links in the pop-frame.</span></span>
<span id="cb1-524"><a href="#cb1-524" aria-hidden="true" tabindex="-1"></a>        Extracts<span class="op">.</span><span class="fu">qualifyLinksInPopFrame</span>(target<span class="op">.</span><span class="at">popFrame</span>)<span class="op">;</span></span>
<span id="cb1-525"><a href="#cb1-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-526"><a href="#cb1-526" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Rectify margin note style.</span></span>
<span id="cb1-527"><a href="#cb1-527" aria-hidden="true" tabindex="-1"></a>        popFrame<span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;.marginnote&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(marginNote <span class="kw">=&gt;</span> {</span>
<span id="cb1-528"><a href="#cb1-528" aria-hidden="true" tabindex="-1"></a>            marginNote<span class="op">.</span><span class="fu">swapClasses</span>([ <span class="st">&quot;inline&quot;</span><span class="op">,</span> <span class="st">&quot;sidenote&quot;</span> ]<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb1-529"><a href="#cb1-529" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-530"><a href="#cb1-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-531"><a href="#cb1-531" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Fire a contentDidLoad event.</span></span>
<span id="cb1-532"><a href="#cb1-532" aria-hidden="true" tabindex="-1"></a>        GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">fireEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> {</span>
<span id="cb1-533"><a href="#cb1-533" aria-hidden="true" tabindex="-1"></a>            <span class="dt">source</span><span class="op">:</span> <span class="st">&quot;Extracts.rewritePopFrameContent_LOCAL_PAGE&quot;</span><span class="op">,</span></span>
<span id="cb1-534"><a href="#cb1-534" aria-hidden="true" tabindex="-1"></a>            <span class="dt">document</span><span class="op">:</span> popFrame<span class="op">.</span><span class="at">contentView</span><span class="op">,</span></span>
<span id="cb1-535"><a href="#cb1-535" aria-hidden="true" tabindex="-1"></a>            <span class="dt">isMainDocument</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb1-536"><a href="#cb1-536" aria-hidden="true" tabindex="-1"></a>            <span class="dt">needsRewrite</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb1-537"><a href="#cb1-537" aria-hidden="true" tabindex="-1"></a>            <span class="dt">clickable</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb1-538"><a href="#cb1-538" aria-hidden="true" tabindex="-1"></a>            <span class="dt">collapseAllowed</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb1-539"><a href="#cb1-539" aria-hidden="true" tabindex="-1"></a>            <span class="dt">isCollapseBlock</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb1-540"><a href="#cb1-540" aria-hidden="true" tabindex="-1"></a>            <span class="dt">isFullPage</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb1-541"><a href="#cb1-541" aria-hidden="true" tabindex="-1"></a>            <span class="dt">location</span><span class="op">:</span> Extracts<span class="op">.</span><span class="fu">locationForTarget</span>(target)<span class="op">,</span></span>
<span id="cb1-542"><a href="#cb1-542" aria-hidden="true" tabindex="-1"></a>            <span class="dt">fullWidthPossible</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb1-543"><a href="#cb1-543" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-544"><a href="#cb1-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-545"><a href="#cb1-545" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Scroll to the target.</span></span>
<span id="cb1-546"><a href="#cb1-546" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (target<span class="op">.</span><span class="at">hash</span> <span class="op">&gt;</span> <span class="st">&quot;&quot;</span> <span class="op">&amp;&amp;</span> popFrame<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&quot;external-page-embed&quot;</span>))</span>
<span id="cb1-547"><a href="#cb1-547" aria-hidden="true" tabindex="-1"></a>            <span class="fu">requestAnimationFrame</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb1-548"><a href="#cb1-548" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (popFrame)</span>
<span id="cb1-549"><a href="#cb1-549" aria-hidden="true" tabindex="-1"></a>                    Extracts<span class="op">.</span><span class="at">popFrameProvider</span><span class="op">.</span><span class="fu">scrollElementIntoViewInPopFrame</span>(popFrame<span class="op">.</span><span class="fu">querySelector</span>(<span class="pp">decodeURIComponent</span>(target<span class="op">.</span><span class="at">hash</span>)))<span class="op">;</span></span>
<span id="cb1-550"><a href="#cb1-550" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb1-551"><a href="#cb1-551" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-552"><a href="#cb1-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-553"><a href="#cb1-553" aria-hidden="true" tabindex="-1"></a>    <span class="dt">rewritePopinContent_LOCAL_PAGE</span><span class="op">:</span> (popin) <span class="kw">=&gt;</span> {</span>
<span id="cb1-554"><a href="#cb1-554" aria-hidden="true" tabindex="-1"></a>        Extracts<span class="op">.</span><span class="fu">rewritePopFrameContent_LOCAL_PAGE</span>(popin)<span class="op">;</span></span>
<span id="cb1-555"><a href="#cb1-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-556"><a href="#cb1-556" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> target <span class="op">=</span> popin<span class="op">.</span><span class="at">spawningTarget</span><span class="op">;</span></span>
<span id="cb1-557"><a href="#cb1-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-558"><a href="#cb1-558" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*  Make non-popin-spawning anchorlinks scroll popin instead of opening</span></span>
<span id="cb1-559"><a href="#cb1-559" aria-hidden="true" tabindex="-1"></a><span class="co">            normally.</span></span>
<span id="cb1-560"><a href="#cb1-560" aria-hidden="true" tabindex="-1"></a><span class="co">            */</span></span>
<span id="cb1-561"><a href="#cb1-561" aria-hidden="true" tabindex="-1"></a>        popin<span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;a&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(link <span class="kw">=&gt;</span> {</span>
<span id="cb1-562"><a href="#cb1-562" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (   link<span class="op">.</span><span class="at">hostname</span> <span class="op">==</span> target<span class="op">.</span><span class="at">hostname</span></span>
<span id="cb1-563"><a href="#cb1-563" aria-hidden="true" tabindex="-1"></a>                <span class="op">&amp;&amp;</span> link<span class="op">.</span><span class="at">pathname</span> <span class="op">==</span> target<span class="op">.</span><span class="at">pathname</span></span>
<span id="cb1-564"><a href="#cb1-564" aria-hidden="true" tabindex="-1"></a>                <span class="op">&amp;&amp;</span> link<span class="op">.</span><span class="at">hash</span> <span class="op">&gt;</span> <span class="st">&quot;&quot;</span></span>
<span id="cb1-565"><a href="#cb1-565" aria-hidden="true" tabindex="-1"></a>                <span class="op">&amp;&amp;</span> link<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&quot;no-popin&quot;</span>)) {</span>
<span id="cb1-566"><a href="#cb1-566" aria-hidden="true" tabindex="-1"></a>                link<span class="op">.</span><span class="at">onclick</span> <span class="op">=</span> () <span class="kw">=&gt;</span> { <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span> }<span class="op">;</span></span>
<span id="cb1-567"><a href="#cb1-567" aria-hidden="true" tabindex="-1"></a>                link<span class="op">.</span><span class="fu">addActivateEvent</span>((<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-568"><a href="#cb1-568" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> hashTarget <span class="op">=</span> popin<span class="op">.</span><span class="fu">querySelector</span>(<span class="pp">decodeURIComponent</span>(link<span class="op">.</span><span class="at">hash</span>))<span class="op">;</span></span>
<span id="cb1-569"><a href="#cb1-569" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> (hashTarget) {</span>
<span id="cb1-570"><a href="#cb1-570" aria-hidden="true" tabindex="-1"></a>                        Popins<span class="op">.</span><span class="fu">scrollElementIntoViewInPopFrame</span>(hashTarget)<span class="op">;</span></span>
<span id="cb1-571"><a href="#cb1-571" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-572"><a href="#cb1-572" aria-hidden="true" tabindex="-1"></a>                    } <span class="cf">else</span> {</span>
<span id="cb1-573"><a href="#cb1-573" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb1-574"><a href="#cb1-574" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb1-575"><a href="#cb1-575" aria-hidden="true" tabindex="-1"></a>                })<span class="op">;</span></span>
<span id="cb1-576"><a href="#cb1-576" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-577"><a href="#cb1-577" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-578"><a href="#cb1-578" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-579"><a href="#cb1-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-580"><a href="#cb1-580" aria-hidden="true" tabindex="-1"></a>    <span class="dt">rewritePopupContent_LOCAL_PAGE</span><span class="op">:</span> (popup) <span class="kw">=&gt;</span> {</span>
<span id="cb1-581"><a href="#cb1-581" aria-hidden="true" tabindex="-1"></a>        Extracts<span class="op">.</span><span class="fu">rewritePopFrameContent_LOCAL_PAGE</span>(popup)<span class="op">;</span></span>
<span id="cb1-582"><a href="#cb1-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-583"><a href="#cb1-583" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> target <span class="op">=</span> popup<span class="op">.</span><span class="at">spawningTarget</span><span class="op">;</span></span>
<span id="cb1-584"><a href="#cb1-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-585"><a href="#cb1-585" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Make anchorlinks scroll popup instead of opening normally.</span></span>
<span id="cb1-586"><a href="#cb1-586" aria-hidden="true" tabindex="-1"></a>        popup<span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;a&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(link <span class="kw">=&gt;</span> {</span>
<span id="cb1-587"><a href="#cb1-587" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (   link<span class="op">.</span><span class="at">hostname</span> <span class="op">==</span> target<span class="op">.</span><span class="at">hostname</span></span>
<span id="cb1-588"><a href="#cb1-588" aria-hidden="true" tabindex="-1"></a>                <span class="op">&amp;&amp;</span> link<span class="op">.</span><span class="at">pathname</span> <span class="op">==</span> target<span class="op">.</span><span class="at">pathname</span></span>
<span id="cb1-589"><a href="#cb1-589" aria-hidden="true" tabindex="-1"></a>                <span class="op">&amp;&amp;</span> link<span class="op">.</span><span class="at">hash</span> <span class="op">&gt;</span> <span class="st">&quot;&quot;</span>) {</span>
<span id="cb1-590"><a href="#cb1-590" aria-hidden="true" tabindex="-1"></a>                link<span class="op">.</span><span class="at">onclick</span> <span class="op">=</span> () <span class="kw">=&gt;</span> { <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span> }<span class="op">;</span></span>
<span id="cb1-591"><a href="#cb1-591" aria-hidden="true" tabindex="-1"></a>                link<span class="op">.</span><span class="fu">addActivateEvent</span>((<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-592"><a href="#cb1-592" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> hashTarget <span class="op">=</span> popup<span class="op">.</span><span class="fu">querySelector</span>(<span class="pp">decodeURIComponent</span>(link<span class="op">.</span><span class="at">hash</span>))<span class="op">;</span></span>
<span id="cb1-593"><a href="#cb1-593" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> (hashTarget) {</span>
<span id="cb1-594"><a href="#cb1-594" aria-hidden="true" tabindex="-1"></a>                        Popups<span class="op">.</span><span class="fu">scrollElementIntoViewInPopFrame</span>(hashTarget)<span class="op">;</span></span>
<span id="cb1-595"><a href="#cb1-595" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-596"><a href="#cb1-596" aria-hidden="true" tabindex="-1"></a>                    } <span class="cf">else</span> {</span>
<span id="cb1-597"><a href="#cb1-597" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb1-598"><a href="#cb1-598" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb1-599"><a href="#cb1-599" aria-hidden="true" tabindex="-1"></a>                })<span class="op">;</span></span>
<span id="cb1-600"><a href="#cb1-600" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-601"><a href="#cb1-601" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-602"><a href="#cb1-602" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-603"><a href="#cb1-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-604"><a href="#cb1-604" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Other site pages.</span></span>
<span id="cb1-605"><a href="#cb1-605" aria-hidden="true" tabindex="-1"></a>    <span class="dt">cachedPages</span><span class="op">:</span> { }<span class="op">,</span></span>
<span id="cb1-606"><a href="#cb1-606" aria-hidden="true" tabindex="-1"></a>    <span class="dt">cachedPageTitles</span><span class="op">:</span> { }<span class="op">,</span></span>
<span id="cb1-607"><a href="#cb1-607" aria-hidden="true" tabindex="-1"></a>    <span class="dt">refreshPopFrameAfterLocalPageLoads</span><span class="op">:</span> (target) <span class="kw">=&gt;</span> {</span>
<span id="cb1-608"><a href="#cb1-608" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.refreshPopFrameAfterLocalPageLoads&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-609"><a href="#cb1-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-610"><a href="#cb1-610" aria-hidden="true" tabindex="-1"></a>        target<span class="op">.</span><span class="at">popFrame</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;loading&quot;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb1-611"><a href="#cb1-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-612"><a href="#cb1-612" aria-hidden="true" tabindex="-1"></a>        <span class="fu">doAjax</span>({</span>
<span id="cb1-613"><a href="#cb1-613" aria-hidden="true" tabindex="-1"></a>            <span class="dt">location</span><span class="op">:</span> target<span class="op">.</span><span class="at">href</span><span class="op">,</span></span>
<span id="cb1-614"><a href="#cb1-614" aria-hidden="true" tabindex="-1"></a>            <span class="dt">onSuccess</span><span class="op">:</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-615"><a href="#cb1-615" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (<span class="op">!</span>target<span class="op">.</span><span class="at">popFrame</span>)</span>
<span id="cb1-616"><a href="#cb1-616" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb1-617"><a href="#cb1-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-618"><a href="#cb1-618" aria-hidden="true" tabindex="-1"></a>                <span class="co">//  Inject the whole page into the pop-frame at first.</span></span>
<span id="cb1-619"><a href="#cb1-619" aria-hidden="true" tabindex="-1"></a>                Extracts<span class="op">.</span><span class="at">popFrameProvider</span><span class="op">.</span><span class="fu">setPopFrameContent</span>(target<span class="op">.</span><span class="at">popFrame</span><span class="op">,</span> <span class="bu">event</span><span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">responseText</span>)<span class="op">;</span></span>
<span id="cb1-620"><a href="#cb1-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-621"><a href="#cb1-621" aria-hidden="true" tabindex="-1"></a>                <span class="co">//  The content is the page body plus the metadata block.</span></span>
<span id="cb1-622"><a href="#cb1-622" aria-hidden="true" tabindex="-1"></a>                Extracts<span class="op">.</span><span class="at">cachedPages</span>[target<span class="op">.</span><span class="at">pathname</span>] <span class="op">=</span> target<span class="op">.</span><span class="at">popFrame</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;#markdownBody&quot;</span>)<span class="op">;</span></span>
<span id="cb1-623"><a href="#cb1-623" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> pageMetadata <span class="op">=</span> target<span class="op">.</span><span class="at">popFrame</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;#page-metadata&quot;</span>)<span class="op">;</span></span>
<span id="cb1-624"><a href="#cb1-624" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (pageMetadata)</span>
<span id="cb1-625"><a href="#cb1-625" aria-hidden="true" tabindex="-1"></a>                    Extracts<span class="op">.</span><span class="at">cachedPages</span>[target<span class="op">.</span><span class="at">pathname</span>]<span class="op">.</span><span class="fu">insertBefore</span>(pageMetadata<span class="op">,</span> Extracts<span class="op">.</span><span class="at">cachedPages</span>[target<span class="op">.</span><span class="at">pathname</span>]<span class="op">.</span><span class="at">firstElementChild</span>)<span class="op">;</span></span>
<span id="cb1-626"><a href="#cb1-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-627"><a href="#cb1-627" aria-hidden="true" tabindex="-1"></a>                <span class="co">//  Get the page title.</span></span>
<span id="cb1-628"><a href="#cb1-628" aria-hidden="true" tabindex="-1"></a>                Extracts<span class="op">.</span><span class="at">cachedPageTitles</span>[target<span class="op">.</span><span class="at">pathname</span>] <span class="op">=</span> target<span class="op">.</span><span class="at">popFrame</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;title&quot;</span>)<span class="op">.</span><span class="at">innerHTML</span><span class="op">.</span><span class="fu">match</span>(Extracts<span class="op">.</span><span class="at">pageTitleRegexp</span>)[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb1-629"><a href="#cb1-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-630"><a href="#cb1-630" aria-hidden="true" tabindex="-1"></a>                <span class="co">/*  Trigger the rewrite pass by firing the requisite event.</span></span>
<span id="cb1-631"><a href="#cb1-631" aria-hidden="true" tabindex="-1"></a><span class="co">                    */</span></span>
<span id="cb1-632"><a href="#cb1-632" aria-hidden="true" tabindex="-1"></a>                GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">fireEvent</span>(<span class="st">&quot;GW.contentDidLoad&quot;</span><span class="op">,</span> {</span>
<span id="cb1-633"><a href="#cb1-633" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">source</span><span class="op">:</span> <span class="st">&quot;Extracts.externalPageEmbedForTarget&quot;</span><span class="op">,</span></span>
<span id="cb1-634"><a href="#cb1-634" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">document</span><span class="op">:</span> target<span class="op">.</span><span class="at">popFrame</span><span class="op">.</span><span class="at">contentView</span><span class="op">,</span></span>
<span id="cb1-635"><a href="#cb1-635" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">isMainDocument</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb1-636"><a href="#cb1-636" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">needsRewrite</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb1-637"><a href="#cb1-637" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">clickable</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb1-638"><a href="#cb1-638" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">collapseAllowed</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb1-639"><a href="#cb1-639" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">isCollapseBlock</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb1-640"><a href="#cb1-640" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">isFullPage</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb1-641"><a href="#cb1-641" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">location</span><span class="op">:</span> Extracts<span class="op">.</span><span class="fu">locationForTarget</span>(target)<span class="op">,</span></span>
<span id="cb1-642"><a href="#cb1-642" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">fullWidthPossible</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb1-643"><a href="#cb1-643" aria-hidden="true" tabindex="-1"></a>                })<span class="op">;</span></span>
<span id="cb1-644"><a href="#cb1-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-645"><a href="#cb1-645" aria-hidden="true" tabindex="-1"></a>                <span class="co">//  Re-spawn, or fill and rewrite, the pop-frame.</span></span>
<span id="cb1-646"><a href="#cb1-646" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (Extracts<span class="op">.</span><span class="at">popFrameProvider</span> <span class="op">==</span> Popups) {</span>
<span id="cb1-647"><a href="#cb1-647" aria-hidden="true" tabindex="-1"></a>                    Popups<span class="op">.</span><span class="fu">spawnPopup</span>(target)<span class="op">;</span></span>
<span id="cb1-648"><a href="#cb1-648" aria-hidden="true" tabindex="-1"></a>                } <span class="cf">else</span> <span class="cf">if</span> (Extracts<span class="op">.</span><span class="at">popFrameProvider</span> <span class="op">==</span> Popins) {</span>
<span id="cb1-649"><a href="#cb1-649" aria-hidden="true" tabindex="-1"></a>                    Extracts<span class="op">.</span><span class="fu">fillPopFrame</span>(target<span class="op">.</span><span class="at">popin</span>)<span class="op">;</span></span>
<span id="cb1-650"><a href="#cb1-650" aria-hidden="true" tabindex="-1"></a>                    target<span class="op">.</span><span class="at">popin</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;loading&quot;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb1-651"><a href="#cb1-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-652"><a href="#cb1-652" aria-hidden="true" tabindex="-1"></a>                    Extracts<span class="op">.</span><span class="fu">rewritePopinContent</span>(target<span class="op">.</span><span class="at">popin</span>)<span class="op">;</span></span>
<span id="cb1-653"><a href="#cb1-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-654"><a href="#cb1-654" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">requestAnimationFrame</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb1-655"><a href="#cb1-655" aria-hidden="true" tabindex="-1"></a>                        Popins<span class="op">.</span><span class="fu">scrollPopinIntoView</span>(target<span class="op">.</span><span class="at">popin</span>)<span class="op">;</span></span>
<span id="cb1-656"><a href="#cb1-656" aria-hidden="true" tabindex="-1"></a>                    })<span class="op">;</span></span>
<span id="cb1-657"><a href="#cb1-657" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb1-658"><a href="#cb1-658" aria-hidden="true" tabindex="-1"></a>            }<span class="op">,</span></span>
<span id="cb1-659"><a href="#cb1-659" aria-hidden="true" tabindex="-1"></a>            <span class="dt">onFailure</span><span class="op">:</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-660"><a href="#cb1-660" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (<span class="op">!</span>target<span class="op">.</span><span class="at">popFrame</span>)</span>
<span id="cb1-661"><a href="#cb1-661" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb1-662"><a href="#cb1-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-663"><a href="#cb1-663" aria-hidden="true" tabindex="-1"></a>                target<span class="op">.</span><span class="at">popFrame</span><span class="op">.</span><span class="fu">swapClasses</span>([ <span class="st">&quot;loading&quot;</span><span class="op">,</span> <span class="st">&quot;loading-failed&quot;</span> ]<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-664"><a href="#cb1-664" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-665"><a href="#cb1-665" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-666"><a href="#cb1-666" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-667"><a href="#cb1-667" aria-hidden="true" tabindex="-1"></a>    <span class="dt">externalPageEmbedForTarget</span><span class="op">:</span> (target) <span class="kw">=&gt;</span> {</span>
<span id="cb1-668"><a href="#cb1-668" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.externalPageEmbedForTarget&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-669"><a href="#cb1-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-670"><a href="#cb1-670" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Mark the pop-frame as an external page embed.</span></span>
<span id="cb1-671"><a href="#cb1-671" aria-hidden="true" tabindex="-1"></a>        target<span class="op">.</span><span class="at">popFrame</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&quot;external-page-embed&quot;</span>)<span class="op">;</span></span>
<span id="cb1-672"><a href="#cb1-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-673"><a href="#cb1-673" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (Extracts<span class="op">.</span><span class="at">cachedPages</span>[target<span class="op">.</span><span class="at">pathname</span>]) {</span>
<span id="cb1-674"><a href="#cb1-674" aria-hidden="true" tabindex="-1"></a>            <span class="co">//  Give the pop-frame an identifying class.</span></span>
<span id="cb1-675"><a href="#cb1-675" aria-hidden="true" tabindex="-1"></a>            target<span class="op">.</span><span class="at">popFrame</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&quot;external-page-embed&quot;</span><span class="op">,</span> <span class="st">&quot;page-&quot;</span> <span class="op">+</span> target<span class="op">.</span><span class="at">pathname</span><span class="op">.</span><span class="fu">substring</span>(<span class="dv">1</span>)<span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb1-676"><a href="#cb1-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-677"><a href="#cb1-677" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Extracts<span class="op">.</span><span class="at">cachedPages</span>[target<span class="op">.</span><span class="at">pathname</span>]<span class="op">.</span><span class="at">innerHTML</span><span class="op">;</span></span>
<span id="cb1-678"><a href="#cb1-678" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb1-679"><a href="#cb1-679" aria-hidden="true" tabindex="-1"></a>            Extracts<span class="op">.</span><span class="fu">refreshPopFrameAfterLocalPageLoads</span>(target)<span class="op">;</span></span>
<span id="cb1-680"><a href="#cb1-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-681"><a href="#cb1-681" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="vs">`&amp;nbsp;`</span><span class="op">;</span></span>
<span id="cb1-682"><a href="#cb1-682" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-683"><a href="#cb1-683" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-684"><a href="#cb1-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-685"><a href="#cb1-685" aria-hidden="true" tabindex="-1"></a>    <span class="co">/***************************/</span></span>
<span id="cb1-686"><a href="#cb1-686" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Pop-frames (in general).</span></span>
<span id="cb1-687"><a href="#cb1-687" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-688"><a href="#cb1-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-689"><a href="#cb1-689" aria-hidden="true" tabindex="-1"></a>    <span class="dt">preparePopFrame</span><span class="op">:</span> (popFrame) <span class="kw">=&gt;</span> {</span>
<span id="cb1-690"><a href="#cb1-690" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.preparePopFrame&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-691"><a href="#cb1-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-692"><a href="#cb1-692" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> target <span class="op">=</span> popFrame<span class="op">.</span><span class="at">spawningTarget</span><span class="op">;</span></span>
<span id="cb1-693"><a href="#cb1-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-694"><a href="#cb1-694" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Import the class(es) of the target.</span></span>
<span id="cb1-695"><a href="#cb1-695" aria-hidden="true" tabindex="-1"></a>        popFrame<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="op">...</span>target<span class="op">.</span><span class="at">classList</span>)<span class="op">;</span></span>
<span id="cb1-696"><a href="#cb1-696" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  We then remove some of the imported classes.</span></span>
<span id="cb1-697"><a href="#cb1-697" aria-hidden="true" tabindex="-1"></a>        popFrame<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&quot;has-annotation&quot;</span><span class="op">,</span> <span class="st">&quot;has-content&quot;</span><span class="op">,</span> <span class="st">&quot;link-self&quot;</span><span class="op">,</span> <span class="st">&quot;link-local&quot;</span><span class="op">,</span> <span class="st">&quot;spawns-popup&quot;</span><span class="op">,</span> <span class="st">&quot;spawns-popin&quot;</span>)<span class="op">;</span></span>
<span id="cb1-698"><a href="#cb1-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-699"><a href="#cb1-699" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Add ‘markdownBody’ class.</span></span>
<span id="cb1-700"><a href="#cb1-700" aria-hidden="true" tabindex="-1"></a>        popFrame<span class="op">.</span><span class="at">contentView</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&quot;markdownBody&quot;</span>)<span class="op">;</span></span>
<span id="cb1-701"><a href="#cb1-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-702"><a href="#cb1-702" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Attempt to fill the popup.</span></span>
<span id="cb1-703"><a href="#cb1-703" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (Extracts<span class="op">.</span><span class="fu">fillPopFrame</span>(popFrame) <span class="op">==</span> <span class="kw">false</span>)</span>
<span id="cb1-704"><a href="#cb1-704" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb1-705"><a href="#cb1-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-706"><a href="#cb1-706" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> popFrame<span class="op">;</span></span>
<span id="cb1-707"><a href="#cb1-707" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-708"><a href="#cb1-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-709"><a href="#cb1-709" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**********/</span></span>
<span id="cb1-710"><a href="#cb1-710" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Popins.</span></span>
<span id="cb1-711"><a href="#cb1-711" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-712"><a href="#cb1-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-713"><a href="#cb1-713" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Called by popins.js just before injecting the popin. This is our chance</span></span>
<span id="cb1-714"><a href="#cb1-714" aria-hidden="true" tabindex="-1"></a><span class="co">        to fill the popin with content, and rewrite that content in whatever</span></span>
<span id="cb1-715"><a href="#cb1-715" aria-hidden="true" tabindex="-1"></a><span class="co">        ways necessary. After this function exits, the popin will appear on the</span></span>
<span id="cb1-716"><a href="#cb1-716" aria-hidden="true" tabindex="-1"></a><span class="co">        screen.</span></span>
<span id="cb1-717"><a href="#cb1-717" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-718"><a href="#cb1-718" aria-hidden="true" tabindex="-1"></a>    <span class="dt">preparePopin</span><span class="op">:</span> (popin) <span class="kw">=&gt;</span> {</span>
<span id="cb1-719"><a href="#cb1-719" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.preparePopin&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-720"><a href="#cb1-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-721"><a href="#cb1-721" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> target <span class="op">=</span> popin<span class="op">.</span><span class="at">spawningTarget</span><span class="op">;</span></span>
<span id="cb1-722"><a href="#cb1-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-723"><a href="#cb1-723" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Call generic prepare function.</span></span>
<span id="cb1-724"><a href="#cb1-724" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ((popin <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">preparePopFrame</span>(popin)) <span class="op">==</span> <span class="kw">null</span>)</span>
<span id="cb1-725"><a href="#cb1-725" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb1-726"><a href="#cb1-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-727"><a href="#cb1-727" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Add popin title bar contents.</span></span>
<span id="cb1-728"><a href="#cb1-728" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> popinTitle <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">titleForPopFrame</span>(popin)<span class="op">;</span></span>
<span id="cb1-729"><a href="#cb1-729" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (popinTitle) {</span>
<span id="cb1-730"><a href="#cb1-730" aria-hidden="true" tabindex="-1"></a>            popin<span class="op">.</span><span class="at">titleBarContents</span> <span class="op">=</span> [</span>
<span id="cb1-731"><a href="#cb1-731" aria-hidden="true" tabindex="-1"></a>                <span class="vs">`&lt;span class=&quot;popframe-title&quot;&gt;</span><span class="sc">${</span>popinTitle<span class="sc">}</span><span class="vs">&lt;/span&gt;`</span><span class="op">,</span></span>
<span id="cb1-732"><a href="#cb1-732" aria-hidden="true" tabindex="-1"></a>                Popins<span class="op">.</span><span class="at">titleBarComponents</span><span class="op">.</span><span class="fu">closeButton</span>()</span>
<span id="cb1-733"><a href="#cb1-733" aria-hidden="true" tabindex="-1"></a>            ]<span class="op">;</span></span>
<span id="cb1-734"><a href="#cb1-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-735"><a href="#cb1-735" aria-hidden="true" tabindex="-1"></a>            <span class="co">//  Add the options button.</span></span>
<span id="cb1-736"><a href="#cb1-736" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (Extracts<span class="op">.</span><span class="at">popinOptionsEnabled</span>)</span>
<span id="cb1-737"><a href="#cb1-737" aria-hidden="true" tabindex="-1"></a>                popup<span class="op">.</span><span class="at">titleBarContents</span><span class="op">.</span><span class="fu">push</span>(Extracts<span class="op">.</span><span class="fu">showPopinOptionsDialogPopinTitleBarButton</span>())<span class="op">;</span></span>
<span id="cb1-738"><a href="#cb1-738" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-739"><a href="#cb1-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-740"><a href="#cb1-740" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Special handling for certain popin types.</span></span>
<span id="cb1-741"><a href="#cb1-741" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> targetTypeName <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">targetTypeInfo</span>(target)<span class="op">.</span><span class="at">typeName</span><span class="op">;</span></span>
<span id="cb1-742"><a href="#cb1-742" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> specialPrepareFunction <span class="op">=</span> Extracts[<span class="vs">`preparePopin_</span><span class="sc">${</span>targetTypeName<span class="sc">}</span><span class="vs">`</span>] <span class="op">||</span> Extracts[<span class="vs">`preparePopFrame_</span><span class="sc">${</span>targetTypeName<span class="sc">}</span><span class="vs">`</span>]<span class="op">;</span></span>
<span id="cb1-743"><a href="#cb1-743" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (specialPrepareFunction)</span>
<span id="cb1-744"><a href="#cb1-744" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> ((popin <span class="op">=</span> <span class="fu">specialPrepareFunction</span>(popin)) <span class="op">==</span> <span class="kw">null</span>)</span>
<span id="cb1-745"><a href="#cb1-745" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb1-746"><a href="#cb1-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-747"><a href="#cb1-747" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*  If we’re waiting for content to be loaded into the popin</span></span>
<span id="cb1-748"><a href="#cb1-748" aria-hidden="true" tabindex="-1"></a><span class="co">            asynchronously, then there’s no need to do rewrites for now.</span></span>
<span id="cb1-749"><a href="#cb1-749" aria-hidden="true" tabindex="-1"></a><span class="co">            */</span></span>
<span id="cb1-750"><a href="#cb1-750" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (Extracts<span class="op">.</span><span class="fu">popFrameHasLoaded</span>(popin))</span>
<span id="cb1-751"><a href="#cb1-751" aria-hidden="true" tabindex="-1"></a>            Extracts<span class="op">.</span><span class="fu">rewritePopinContent</span>(popin)<span class="op">;</span></span>
<span id="cb1-752"><a href="#cb1-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-753"><a href="#cb1-753" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> popin<span class="op">;</span></span>
<span id="cb1-754"><a href="#cb1-754" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-755"><a href="#cb1-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-756"><a href="#cb1-756" aria-hidden="true" tabindex="-1"></a>    <span class="dt">rewritePopinContent</span><span class="op">:</span> (popin) <span class="kw">=&gt;</span> {</span>
<span id="cb1-757"><a href="#cb1-757" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.rewritePopinContent&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-758"><a href="#cb1-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-759"><a href="#cb1-759" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> target <span class="op">=</span> popin<span class="op">.</span><span class="at">spawningTarget</span><span class="op">;</span></span>
<span id="cb1-760"><a href="#cb1-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-761"><a href="#cb1-761" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Update the title.</span></span>
<span id="cb1-762"><a href="#cb1-762" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (popin<span class="op">.</span><span class="at">titleBar</span>)</span>
<span id="cb1-763"><a href="#cb1-763" aria-hidden="true" tabindex="-1"></a>            popin<span class="op">.</span><span class="at">titleBar</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;.popframe-title&quot;</span>)<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">titleForPopFrame</span>(popin)<span class="op">;</span></span>
<span id="cb1-764"><a href="#cb1-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-765"><a href="#cb1-765" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Special handling for certain popin types.</span></span>
<span id="cb1-766"><a href="#cb1-766" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> targetTypeName <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">targetTypeInfo</span>(target)<span class="op">.</span><span class="at">typeName</span><span class="op">;</span></span>
<span id="cb1-767"><a href="#cb1-767" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> specialRewriteFunction <span class="op">=</span> Extracts[<span class="vs">`rewritePopinContent_</span><span class="sc">${</span>targetTypeName<span class="sc">}</span><span class="vs">`</span>] <span class="op">||</span> Extracts[<span class="vs">`rewritePopFrameContent_</span><span class="sc">${</span>targetTypeName<span class="sc">}</span><span class="vs">`</span>]<span class="op">;</span></span>
<span id="cb1-768"><a href="#cb1-768" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (specialRewriteFunction)</span>
<span id="cb1-769"><a href="#cb1-769" aria-hidden="true" tabindex="-1"></a>            <span class="fu">specialRewriteFunction</span>(popin)<span class="op">;</span></span>
<span id="cb1-770"><a href="#cb1-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-771"><a href="#cb1-771" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  For object popins, scroll popin into view once object loads.</span></span>
<span id="cb1-772"><a href="#cb1-772" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> objectOfSomeSort <span class="op">=</span> popin<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;iframe, object, img, video&quot;</span>)<span class="op">;</span></span>
<span id="cb1-773"><a href="#cb1-773" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (objectOfSomeSort) {</span>
<span id="cb1-774"><a href="#cb1-774" aria-hidden="true" tabindex="-1"></a>            objectOfSomeSort<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;load&quot;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb1-775"><a href="#cb1-775" aria-hidden="true" tabindex="-1"></a>                <span class="fu">requestAnimationFrame</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb1-776"><a href="#cb1-776" aria-hidden="true" tabindex="-1"></a>                    Popins<span class="op">.</span><span class="fu">scrollPopinIntoView</span>(popin)<span class="op">;</span></span>
<span id="cb1-777"><a href="#cb1-777" aria-hidden="true" tabindex="-1"></a>                })<span class="op">;</span></span>
<span id="cb1-778"><a href="#cb1-778" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb1-779"><a href="#cb1-779" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-780"><a href="#cb1-780" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-781"><a href="#cb1-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-782"><a href="#cb1-782" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**********/</span></span>
<span id="cb1-783"><a href="#cb1-783" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Popups.</span></span>
<span id="cb1-784"><a href="#cb1-784" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-785"><a href="#cb1-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-786"><a href="#cb1-786" aria-hidden="true" tabindex="-1"></a>    <span class="dt">popupsEnabled</span><span class="op">:</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb1-787"><a href="#cb1-787" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&quot;extract-popups-disabled&quot;</span>) <span class="op">!=</span> <span class="st">&quot;true&quot;</span>)<span class="op">;</span></span>
<span id="cb1-788"><a href="#cb1-788" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-789"><a href="#cb1-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-790"><a href="#cb1-790" aria-hidden="true" tabindex="-1"></a>    <span class="dt">spawnedPopupMatchingTarget</span><span class="op">:</span> (target) <span class="kw">=&gt;</span> {</span>
<span id="cb1-791"><a href="#cb1-791" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Popups<span class="op">.</span><span class="fu">allSpawnedPopups</span>()<span class="op">.</span><span class="fu">find</span>(popup <span class="kw">=&gt;</span></span>
<span id="cb1-792"><a href="#cb1-792" aria-hidden="true" tabindex="-1"></a>                   Extracts<span class="op">.</span><span class="fu">targetsMatch</span>(target<span class="op">,</span> popup<span class="op">.</span><span class="at">spawningTarget</span>)</span>
<span id="cb1-793"><a href="#cb1-793" aria-hidden="true" tabindex="-1"></a>                <span class="op">&amp;&amp;</span> Popups<span class="op">.</span><span class="fu">popupIsEphemeral</span>(popup))<span class="op">;</span></span>
<span id="cb1-794"><a href="#cb1-794" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-795"><a href="#cb1-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-796"><a href="#cb1-796" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Called by popups.js when adding a target.</span></span>
<span id="cb1-797"><a href="#cb1-797" aria-hidden="true" tabindex="-1"></a>    <span class="dt">preparePopupTarget</span><span class="op">:</span> (target) <span class="kw">=&gt;</span> {</span>
<span id="cb1-798"><a href="#cb1-798" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Remove the title attribute (saving it first);</span></span>
<span id="cb1-799"><a href="#cb1-799" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (target<span class="op">.</span><span class="at">title</span>) {</span>
<span id="cb1-800"><a href="#cb1-800" aria-hidden="true" tabindex="-1"></a>            target<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">attributeTitle</span> <span class="op">=</span> target<span class="op">.</span><span class="at">title</span><span class="op">;</span></span>
<span id="cb1-801"><a href="#cb1-801" aria-hidden="true" tabindex="-1"></a>            target<span class="op">.</span><span class="fu">removeAttribute</span>(<span class="st">&quot;title&quot;</span>)<span class="op">;</span></span>
<span id="cb1-802"><a href="#cb1-802" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-803"><a href="#cb1-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-804"><a href="#cb1-804" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  For special positioning by Popups.js.</span></span>
<span id="cb1-805"><a href="#cb1-805" aria-hidden="true" tabindex="-1"></a>        target<span class="op">.</span><span class="at">preferSidePositioning</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb1-806"><a href="#cb1-806" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (   target<span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;#sidebar, li&quot;</span>) <span class="op">!=</span> <span class="kw">null</span></span>
<span id="cb1-807"><a href="#cb1-807" aria-hidden="true" tabindex="-1"></a>                    <span class="op">&amp;&amp;</span> target<span class="op">.</span><span class="fu">closest</span>(<span class="st">&quot;.columns&quot;</span>) <span class="op">==</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb1-808"><a href="#cb1-808" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb1-809"><a href="#cb1-809" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-810"><a href="#cb1-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-811"><a href="#cb1-811" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*  Called by popups.js just before spawning (injecting and positioning) the</span></span>
<span id="cb1-812"><a href="#cb1-812" aria-hidden="true" tabindex="-1"></a><span class="co">        popup. This is our chance to fill the popup with content, and rewrite</span></span>
<span id="cb1-813"><a href="#cb1-813" aria-hidden="true" tabindex="-1"></a><span class="co">        that content in whatever ways necessary. After this function exits, the</span></span>
<span id="cb1-814"><a href="#cb1-814" aria-hidden="true" tabindex="-1"></a><span class="co">        popup will appear on the screen.</span></span>
<span id="cb1-815"><a href="#cb1-815" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb1-816"><a href="#cb1-816" aria-hidden="true" tabindex="-1"></a>    <span class="dt">preparePopup</span><span class="op">:</span> (popup) <span class="kw">=&gt;</span> {</span>
<span id="cb1-817"><a href="#cb1-817" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.preparePopup&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-818"><a href="#cb1-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-819"><a href="#cb1-819" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> target <span class="op">=</span> popup<span class="op">.</span><span class="at">spawningTarget</span><span class="op">;</span></span>
<span id="cb1-820"><a href="#cb1-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-821"><a href="#cb1-821" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*  If a popup already exists that matches the target, do not spawn a</span></span>
<span id="cb1-822"><a href="#cb1-822" aria-hidden="true" tabindex="-1"></a><span class="co">            new popup; just use the existing popup.</span></span>
<span id="cb1-823"><a href="#cb1-823" aria-hidden="true" tabindex="-1"></a><span class="co">            */</span></span>
<span id="cb1-824"><a href="#cb1-824" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> existingPopup <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">spawnedPopupMatchingTarget</span>(target)<span class="op">;</span></span>
<span id="cb1-825"><a href="#cb1-825" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (existingPopup) {</span>
<span id="cb1-826"><a href="#cb1-826" aria-hidden="true" tabindex="-1"></a>            Popups<span class="op">.</span><span class="fu">detachPopupFromTarget</span>(existingPopup)<span class="op">;</span></span>
<span id="cb1-827"><a href="#cb1-827" aria-hidden="true" tabindex="-1"></a>            existingPopup<span class="op">.</span><span class="at">spawningTarget</span> <span class="op">=</span> target<span class="op">;</span></span>
<span id="cb1-828"><a href="#cb1-828" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> existingPopup<span class="op">;</span></span>
<span id="cb1-829"><a href="#cb1-829" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-830"><a href="#cb1-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-831"><a href="#cb1-831" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Call generic prepare function.</span></span>
<span id="cb1-832"><a href="#cb1-832" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ((popup <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">preparePopFrame</span>(popup)) <span class="op">==</span> <span class="kw">null</span>)</span>
<span id="cb1-833"><a href="#cb1-833" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb1-834"><a href="#cb1-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-835"><a href="#cb1-835" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Add popup title bar contents.</span></span>
<span id="cb1-836"><a href="#cb1-836" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> popupTitle <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">titleForPopFrame</span>(popup)<span class="op">;</span></span>
<span id="cb1-837"><a href="#cb1-837" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (popupTitle) {</span>
<span id="cb1-838"><a href="#cb1-838" aria-hidden="true" tabindex="-1"></a>            popup<span class="op">.</span><span class="at">titleBarContents</span> <span class="op">=</span> [</span>
<span id="cb1-839"><a href="#cb1-839" aria-hidden="true" tabindex="-1"></a>                Popups<span class="op">.</span><span class="at">titleBarComponents</span><span class="op">.</span><span class="fu">closeButton</span>()<span class="op">,</span></span>
<span id="cb1-840"><a href="#cb1-840" aria-hidden="true" tabindex="-1"></a>                Popups<span class="op">.</span><span class="at">titleBarComponents</span><span class="op">.</span><span class="fu">zoomButton</span>()<span class="op">.</span><span class="fu">enableSubmenu</span>()<span class="op">,</span></span>
<span id="cb1-841"><a href="#cb1-841" aria-hidden="true" tabindex="-1"></a>                Popups<span class="op">.</span><span class="at">titleBarComponents</span><span class="op">.</span><span class="fu">pinButton</span>()<span class="op">,</span></span>
<span id="cb1-842"><a href="#cb1-842" aria-hidden="true" tabindex="-1"></a>                <span class="vs">`&lt;span class=&quot;popframe-title&quot;&gt;</span><span class="sc">${</span>popupTitle<span class="sc">}</span><span class="vs">&lt;/span&gt;`</span></span>
<span id="cb1-843"><a href="#cb1-843" aria-hidden="true" tabindex="-1"></a>            ]<span class="op">;</span></span>
<span id="cb1-844"><a href="#cb1-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-845"><a href="#cb1-845" aria-hidden="true" tabindex="-1"></a>            <span class="co">//  Add the options button.</span></span>
<span id="cb1-846"><a href="#cb1-846" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (Extracts<span class="op">.</span><span class="at">popupOptionsEnabled</span>)</span>
<span id="cb1-847"><a href="#cb1-847" aria-hidden="true" tabindex="-1"></a>                popup<span class="op">.</span><span class="at">titleBarContents</span><span class="op">.</span><span class="fu">push</span>(Extracts<span class="op">.</span><span class="fu">showPopupOptionsDialogPopupTitleBarButton</span>())<span class="op">;</span></span>
<span id="cb1-848"><a href="#cb1-848" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-849"><a href="#cb1-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-850"><a href="#cb1-850" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Special handling for certain popup types.</span></span>
<span id="cb1-851"><a href="#cb1-851" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> targetTypeName <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">targetTypeInfo</span>(target)<span class="op">.</span><span class="at">typeName</span><span class="op">;</span></span>
<span id="cb1-852"><a href="#cb1-852" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> specialPrepareFunction <span class="op">=</span> Extracts[<span class="vs">`preparePopup_</span><span class="sc">${</span>targetTypeName<span class="sc">}</span><span class="vs">`</span>] <span class="op">||</span> Extracts[<span class="vs">`preparePopFrame_</span><span class="sc">${</span>targetTypeName<span class="sc">}</span><span class="vs">`</span>]<span class="op">;</span></span>
<span id="cb1-853"><a href="#cb1-853" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (specialPrepareFunction)</span>
<span id="cb1-854"><a href="#cb1-854" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> ((popup <span class="op">=</span> <span class="fu">specialPrepareFunction</span>(popup)) <span class="op">==</span> <span class="kw">null</span>)</span>
<span id="cb1-855"><a href="#cb1-855" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb1-856"><a href="#cb1-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-857"><a href="#cb1-857" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*  If we’re waiting for content to be loaded into the popup</span></span>
<span id="cb1-858"><a href="#cb1-858" aria-hidden="true" tabindex="-1"></a><span class="co">            asynchronously, then there’s no need to do rewrites for now.</span></span>
<span id="cb1-859"><a href="#cb1-859" aria-hidden="true" tabindex="-1"></a><span class="co">            */</span></span>
<span id="cb1-860"><a href="#cb1-860" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (Extracts<span class="op">.</span><span class="fu">popFrameHasLoaded</span>(popup))</span>
<span id="cb1-861"><a href="#cb1-861" aria-hidden="true" tabindex="-1"></a>            Extracts<span class="op">.</span><span class="fu">rewritePopupContent</span>(popup)<span class="op">;</span></span>
<span id="cb1-862"><a href="#cb1-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-863"><a href="#cb1-863" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> popup<span class="op">;</span></span>
<span id="cb1-864"><a href="#cb1-864" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb1-865"><a href="#cb1-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-866"><a href="#cb1-866" aria-hidden="true" tabindex="-1"></a>    <span class="dt">rewritePopupContent</span><span class="op">:</span> (popup) <span class="kw">=&gt;</span> {</span>
<span id="cb1-867"><a href="#cb1-867" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GWLog</span>(<span class="st">&quot;Extracts.rewritePopupContent&quot;</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-868"><a href="#cb1-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-869"><a href="#cb1-869" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> target <span class="op">=</span> popup<span class="op">.</span><span class="at">spawningTarget</span><span class="op">;</span></span>
<span id="cb1-870"><a href="#cb1-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-871"><a href="#cb1-871" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Special handling for certain popup types.</span></span>
<span id="cb1-872"><a href="#cb1-872" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> targetTypeName <span class="op">=</span> Extracts<span class="op">.</span><span class="fu">targetTypeInfo</span>(target)<span class="op">.</span><span class="at">typeName</span><span class="op">;</span></span>
<span id="cb1-873"><a href="#cb1-873" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> specialRewriteFunction <span class="op">=</span> Extracts[<span class="vs">`rewritePopupContent_</span><span class="sc">${</span>targetTypeName<span class="sc">}</span><span class="vs">`</span>] <span class="op">||</span> Extracts[<span class="vs">`rewritePopFrameContent_</span><span class="sc">${</span>targetTypeName<span class="sc">}</span><span class="vs">`</span>]<span class="op">;</span></span>
<span id="cb1-874"><a href="#cb1-874" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (specialRewriteFunction)</span>
<span id="cb1-875"><a href="#cb1-875" aria-hidden="true" tabindex="-1"></a>            <span class="fu">specialRewriteFunction</span>(popup)<span class="op">;</span></span>
<span id="cb1-876"><a href="#cb1-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-877"><a href="#cb1-877" aria-hidden="true" tabindex="-1"></a>        <span class="co">//  Ensure no reflow due to figures.</span></span>
<span id="cb1-878"><a href="#cb1-878" aria-hidden="true" tabindex="-1"></a>        popup<span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&quot;figure[class^=&#39;float-&#39;] img[width]&quot;</span>)<span class="op">.</span><span class="fu">forEach</span>(img <span class="kw">=&gt;</span> {</span>
<span id="cb1-879"><a href="#cb1-879" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (img<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">width</span> <span class="op">&lt;=</span> <span class="st">&quot;&quot;</span>) {</span>
<span id="cb1-880"><a href="#cb1-880" aria-hidden="true" tabindex="-1"></a>                img<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">width</span> <span class="op">=</span> img<span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&quot;width&quot;</span>) <span class="op">+</span> <span class="st">&quot;px&quot;</span><span class="op">;</span></span>
<span id="cb1-881"><a href="#cb1-881" aria-hidden="true" tabindex="-1"></a>                img<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">maxHeight</span> <span class="op">=</span> <span class="st">&quot;unset&quot;</span><span class="op">;</span></span>
<span id="cb1-882"><a href="#cb1-882" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-883"><a href="#cb1-883" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb1-884"><a href="#cb1-884" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-885"><a href="#cb1-885" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb1-886"><a href="#cb1-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-887"><a href="#cb1-887" aria-hidden="true" tabindex="-1"></a>GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">fireEvent</span>(<span class="st">&quot;Extracts.didLoad&quot;</span>)<span class="op">;</span></span>
<span id="cb1-888"><a href="#cb1-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-889"><a href="#cb1-889" aria-hidden="true" tabindex="-1"></a><span class="co">//  Set pop-frame type (mode) - popups or popins.</span></span>
<span id="cb1-890"><a href="#cb1-890" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> mobileMode <span class="op">=</span> (localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&quot;extracts-force-popins&quot;</span>) <span class="op">==</span> <span class="st">&quot;true&quot;</span>) <span class="op">||</span> GW<span class="op">.</span><span class="fu">isMobile</span>()<span class="op">;</span></span>
<span id="cb1-891"><a href="#cb1-891" aria-hidden="true" tabindex="-1"></a>Extracts<span class="op">.</span><span class="at">popFrameProviderName</span> <span class="op">=</span> mobileMode <span class="op">?</span> <span class="st">&quot;Popins&quot;</span> <span class="op">:</span> <span class="st">&quot;Popups&quot;</span><span class="op">;</span></span>
<span id="cb1-892"><a href="#cb1-892" aria-hidden="true" tabindex="-1"></a><span class="fu">GWLog</span>(<span class="vs">`</span><span class="sc">${</span>(mobileMode <span class="op">?</span> <span class="st">&quot;Mobile&quot;</span> <span class="op">:</span> <span class="st">&quot;Non-mobile&quot;</span>)<span class="sc">}</span><span class="vs"> client detected. Activating </span><span class="sc">${</span>(mobileMode <span class="op">?</span> <span class="st">&quot;popins&quot;</span> <span class="op">:</span> <span class="st">&quot;popups&quot;</span>)<span class="sc">}</span><span class="vs">.`</span><span class="op">,</span> <span class="st">&quot;extracts.js&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-893"><a href="#cb1-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-894"><a href="#cb1-894" aria-hidden="true" tabindex="-1"></a>doSetup <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb1-895"><a href="#cb1-895" aria-hidden="true" tabindex="-1"></a>    <span class="co">//  Prevent null references.</span></span>
<span id="cb1-896"><a href="#cb1-896" aria-hidden="true" tabindex="-1"></a>    Popups <span class="op">=</span> <span class="bu">window</span>[<span class="st">&quot;Popups&quot;</span>] <span class="op">||</span> { }<span class="op">;</span></span>
<span id="cb1-897"><a href="#cb1-897" aria-hidden="true" tabindex="-1"></a>    Popins <span class="op">=</span> <span class="bu">window</span>[<span class="st">&quot;Popins&quot;</span>] <span class="op">||</span> { }<span class="op">;</span></span>
<span id="cb1-898"><a href="#cb1-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-899"><a href="#cb1-899" aria-hidden="true" tabindex="-1"></a>    Extracts<span class="op">.</span><span class="fu">setup</span>()<span class="op">;</span></span>
<span id="cb1-900"><a href="#cb1-900" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb1-901"><a href="#cb1-901" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="bu">window</span>[Extracts<span class="op">.</span><span class="at">popFrameProviderName</span>]) {</span>
<span id="cb1-902"><a href="#cb1-902" aria-hidden="true" tabindex="-1"></a>    <span class="fu">doSetup</span>()<span class="op">;</span></span>
<span id="cb1-903"><a href="#cb1-903" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-904"><a href="#cb1-904" aria-hidden="true" tabindex="-1"></a>    GW<span class="op">.</span><span class="at">notificationCenter</span><span class="op">.</span><span class="fu">addHandlerForEvent</span>(Extracts<span class="op">.</span><span class="at">popFrameProviderName</span> <span class="op">+</span> <span class="st">&quot;.didLoad&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb1-905"><a href="#cb1-905" aria-hidden="true" tabindex="-1"></a>        <span class="fu">doSetup</span>()<span class="op">;</span></span>
<span id="cb1-906"><a href="#cb1-906" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> { <span class="dt">once</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb1-907"><a href="#cb1-907" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
